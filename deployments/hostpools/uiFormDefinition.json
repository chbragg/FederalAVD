{
	"$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
	"view": {
		"kind": "Form",
		"properties": {
			"title": "Azure Virtual Desktop Host Pool Deployment",
			"steps": [
				{
					"name": "basics",
					"label": "Deployment Basics",
					"elements": [
						{
							"name": "subscriptionsApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"request": {
								"method": "GET",
								"path": "/subscriptions?api-version=2022-12-01"
							}
						},
						{
							"name": "infoBox1",
							"type": "Microsoft.Common.TextBlock",
							"visible": true,
							"options": {
								"text": "This solution is designed to deploy an Azure Virtual Desktop hostpool according to Cloud Adoption Framework (CAF) best practices. Please complete the sections of this form to get started."
							}
						},
						{
							"name": "prereqs",
							"type": "Microsoft.Common.Section",
							"label": "Solution Prerequisites",
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
							"elements": [
								{
									"name": "textBlock1",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "This solution has several prerequisites documented at the link below and in the Federal AVD Repo.",
										"link": {
											"label": "Prerequisites for Azure Virtual Desktop",
											"uri": "https://learn.microsoft.com/en-us/azure/virtual-desktop/prerequisites"
										}
									}
								}
							]
						},
						{
							"name": "deploymentType",
							"type": "Microsoft.Common.OptionsGroup",
							"label": "Deployment Mode",
							"defaultValue": "Complete",
							"toolTip": "Select the deployment type from:<br><ul><li><b>Complete</b>: This solution will deploy a fully functioning Azure Virtual Desktop hostpool along with associated resources depending on the options chosen. All resources and resource groups are named in accordance with Cloud Adoption Framework (CAF) naming standards.</li><br><li><b>Hostpool resources only</b>: The solution will deploy the resources necessary to support a hostpool including the hostpool object, desktop application group, virtual machines, and storage for FSLogix (if selected). You'll have the option to select existing management, monitoring, and control plane resources.</li><br><li><b>Add session hosts to an existing hostpool</b>: The solution will only add session hosts to an existing hostpool allowing you to select existing resources when required to customize your session hosts.</li></ul>",
							"constraints": {
								"allowedValues": [
									{
										"label": "Complete",
										"value": "Complete"
									},
									{
										"label": "Hostpool resources only",
										"value": "HostpoolOnly"
									},
									{
										"label": "Add session hosts to an existing hostpool",
										"value": "SessionHostsOnly"
									}
								]
							},
							"visible": true
						},
						{
							"name": "existingHostPoolTextBlock",
							"type": "Microsoft.Common.TextBlock",
							"options": {
								"text": "Select the hostpool that you wish to update below."
							},
							"visible": "[equals(steps('basics').deploymentType, 'SessionHostsOnly')]"
						},
						{
							"name": "existingHostPool",
							"type": "Microsoft.Solutions.ResourceSelector",
							"visible": "[equals(steps('basics').deploymentType, 'SessionHostsOnly')]",
							"label": "Hostpool",
							"resourceType": "Microsoft.DesktopVirtualization/hostPools",
							"constraints": {
								"required": true
							}
						},
						{
							"name": "hostPoolApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"condition": "[not(empty(steps('basics').existingHostPool))]",
							"request": {
								"method": "GET",
								"path": "[concat(steps('basics').existingHostPool.id, '?api-version=2024-04-03')]"
							}
						},
						{
							"name": "sessionHostsApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"condition": "[not(empty(steps('basics').existingHostPool))]",
							"request": {
								"method": "GET",
								"path": "[concat(steps('basics').existingHostPool.id, '/sessionHosts?api-version=2024-04-03&isDescending=true')]",
								"transforms": {
									"lastname": "value[*].name|[0]"
								}
							}
						},
						{
							"name": "naming",
							"type": "Microsoft.Common.Section",
							"label": "Naming Components",
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
							"elements": [
								{
									"name": "namingIntroTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"link": {
											"label": "User Personas | Microsoft Learn",
											"uri": "https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/scenarios/azure-virtual-desktop/migrate-assess#user-personas"
										},
										"text": "Please provide the naming components below.<br><br>The Persona Identifier is required and is designed to represent the persona being provided resources by the host pool. Each persona requires a specific host-pool configuration. Defining personas (and thus host pools) will come as a result of bucketing users based on the following criteria:<ul><li><b>Personal Pools:</b> Do specific groups of users require dedicated desktops, instead of pools?</li><li><b>Density:</b> Do specific groups of users require a lower-density desktop experience?</li><li><b>Performance:</b> Do specific groups of users require a higher-performance desktop experience?</li><li><b>Graphical processing (GPU):</b> Do specific groups of users have greater graphical requirements?</li><li><b>Business functions:</b> Can the specific groupings of users be bucketed by business unit, charge code, or their business function?</li><li><b>User count:</b> How many users will be in each distinct persona?</li><li><b>Max session counts:</b> Based on geography and hours of operation, how many concurrent users are expected for each persona during maximum load?</li></ul>"
									}
								},
								{
									"name": "identifier",
									"type": "Microsoft.Common.TextBox",
									"label": "Persona Identifier",
									"toolTip": "Input an alphanumeric identifier for the business unit or the persona for which the hostpool will be deployed.",
									"constraints": {
										"required": true,
										"validations": [
											{
												"regex": "^[a-zA-Z0-9]+(-[a-zA-Z0-9]+)?$",
												"message": "Only alphanumeric characters and a single dash '-' are allowed. The dash must be specified between alphanumeric characters."
											},
											{
												"isValid": "[not(greater(add(length(steps('basics').naming.identifier), length(steps('basics').naming.index)), 9))]",
												"message": "The total length of the identifier and index cannot exceed 9 characters."
											}
										]
									}
								},
								{
									"name": "indexTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"link": {
											"label": "Sharding pattern - Azure Architecture Center | Microsoft Learn",
											"uri": "https://learn.microsoft.com/en-us/azure/architecture/patterns/sharding"
										},
										"text": "Optionally, if you need to provide more than one host pool for the same persona, you should use the HostPool Index value below."
									}
								},
								{
									"name": "index",
									"type": "Microsoft.Common.TextBox",
									"label": "HostPool Index",
									"toolTip": "Input a numeric index value for the hostpool created by this solution.",
									"constraints": {
										"required": false,
										"validations": [
											{
												"regex": "^\\d{0,2}$",
												"message": "Only a blank value or an integer value from 0 to 99 are allowed."
											}
										]
									}
								},
								{
									"name": "cafTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "The Cloud Adoption Framework (CAF) provides a recommended resource naming convention which specifies that the abbreviation for the resource type is listed first in the name. This solution automatically names resources using the CAF naming convention and suggested resource type abbreviations. Some customers have chosen to move the resource type to the end of the resource names. Select 'Yes' below to ensure that resources are named with this reverse convention or leave it set to 'No' to follow the CAF.",
										"link": {
											"label": "Resource Naming | Microsoft Learn",
											"uri": "https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming"
										}
									}
								},
								{
									"name": "nameConvResTypeAtEnd",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Move the Resource Type to the end of resource names",
									"defaultValue": "No",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										]
									}
								}
							]
						}
					]
				},
				{
					"name": "identity",
					"label": "Identity",
					"elements": [
						{
							"name": "solution",
							"type": "Microsoft.Common.OptionsGroup",
							"visible": true,
							"label": "Identity Provider",
							"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmIdentityType)), 'Active Directory Domain Services (ADDS)', if(equals(steps('basics').hostPoolApi.tags.vmIdentityType, 'EntraId'), 'Entra Id', if(contains(steps('basics').hostPoolApi.tags.vmIdentityType, 'ActiveDirectory'), 'Active Directory Domain Services (ADDS)', if(contains(steps('basics').hostPoolApi.tags.vmIdentityType, 'Kerberos'), 'Entra Kerberos (Hybrid Identities)', 'Entra Domain Services'))))]",
							"toolTip": "Choose the identity service provider for your users and session hosts. Your choices explained:</br></br><b>Active Directory Domain Services (ADDS)</b>: The users are sourced from ADDS and session hosts will be domain joined.</br></br><b>Entra Domain Services</b>: The users are sourced from Entra ID or ADDS and the session hosts are joined to Entra Domain Services.</br></br><b>Entra ID</b>: The users are sourced from Entra ID and the session hosts will join Entra ID.</br></br><b>Entra Kerberos (hybrid identities)</b>: The Users are sourced from ADDS, but the session hosts will be joined to Entra ID.",
							"constraints": {
								"required": true,
								"allowedValues": [
									{
										"label": "Active Directory Domain Services (ADDS)",
										"value": "ActiveDirectoryDomainServices"
									},
									{
										"label": "Entra Domain Services",
										"value": "EntraDomainServices"
									},
									{
										"label": "Entra Id",
										"value": "EntraId"
									},
									{
										"label": "Entra Kerberos (Cloud Only Identities) (Preview)",
										"value": "EntraKerberos-CloudOnly"
									},
									{
										"label": "Entra Kerberos (Hybrid Identities)",
										"value": "EntraKerberos-Hybrid"
									}
								]
							}
						},
						{
							"name": "entraKerberosInfoBox",
							"type": "Microsoft.Common.InfoBox",
							"visible": "[equals(steps('identity').solution, 'EntraKerberos-Hybrid')]",
							"options": {
								"text": "Enabling authentication to FSLogix storage accounts using Entra Kerberos requires additional steps that cannot be completed using this automation solution. After this deployment completes, you'll need to complete the following tasks as detailed in the link:<ol><li>Grant admin consent to the new service principal</li><li>Disable multifactor authentication on the storage account</li></ol>",
								"style": "Info",
								"uri": "https://learn.microsoft.com/en-us/azure/storage/files/storage-files-identity-auth-hybrid-identities-enable?tabs=azure-portal%2Cintune"
							}
						},
						{
							"name": "entraIdPreviewInfoBox",
							"type": "Microsoft.Common.InfoBox",
							"visible": "[equals(steps('identity').solution, 'EntraKerberos-CloudOnly')]",
							"options": {
								"text": "<b>Enabling authentication to FSLogix storage accounts using Entra Kerberos for Cloud Only Identities is only supported in Azure Commercial.</b><br><br>It also requires additional steps that cannot be completed using this automation solution. After this deployment completes, you'll need to complete the following tasks as detailed in the link:<ol><li>Grant admin consent to the new service principal</li><li>Disable multifactor authentication on the storage account</li></ol>",
								"style": "Warning",
								"uri": "https://learn.microsoft.com/en-us/azure/storage/files/storage-files-identity-auth-hybrid-identities-enable?tabs=azure-portal%2Cintune"
							}
						},
						{
							"name": "virtualMachines",
							"type": "Microsoft.Common.Section",
							"label": "Virtual Machines",
							"elements": [
								{
									"name": "domainName",
									"type": "Microsoft.Common.TextBox",
									"visible": "[contains(steps('identity').solution, 'DomainServices')]",
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), '', coalesce(steps('basics').hostPoolApi.tags.vmDomain, ''))]",
									"label": "Domain Name",
									"toolTip": "Provide domain name for the selected Virtual Machine Identity solution.",
									"placeholder": "Example: contoso.com",
									"constraints": {
										"regex": "^([a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,}$",
										"required": true,
										"validationMessage": "Provide a valid fully qualified domain name."
									}
								},
								{
									"name": "ouPath",
									"type": "Microsoft.Common.TextBox",
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), '', coalesce(steps('basics').hostPoolApi.tags.vmOUPath , ''))]",
									"visible": "[or(equals(steps('identity').solution, 'ActiveDirectoryDomainServices'), equals(steps('identity').solution, 'EntraDomainServices'))]",
									"label": "OU Path",
									"toolTip": "Input the distinguished name of the desired organization unit for the AVD session hosts.",
									"placeholder": "Example: OU=pooled,OU=avd,DC=contoso,DC=com",
									"constraints": {
										"regex": "^(?:\\s*[Oo][Uu]\\s*=\\s*[^,]+\\s*,\\s*)+[Dd][Cc]\\s*=\\s*[A-Za-z0-9-]+\\s*(?:,\\s*[Dd][Cc]\\s*=\\s*[A-Za-z0-9-]+\\s*)+$",
										"required": true,
										"validationMessage": "Provide a valid OU path in Distinguished Name format."
									}
								}
							]
						},
						{
							"name": "credentials",
							"type": "Microsoft.Common.Section",
							"visible": true,
							"label": "Credentials",
							"elements": [
								{
									"name": "source",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "[if(contains(steps('identity').solution, 'DomainServices'), 'Domain Join and VM Admin Credentials source', 'VM Admin Credentials source')]",
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), 'Manual Entry', 'Key Vault')]",
									"toolTip": "Select 'Manual Entry' to specify the secrets manually or 'Key Vault' to reference secrets from a Key Vault.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Key Vault",
												"value": "keyVault"
											},
											{
												"label": "Manual Entry",
												"value": "manual"
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "domainJoinUserPrincipalName",
									"type": "Microsoft.Common.TextBox",
									"label": "Domain Join Account UserPrincipalName",
									"toolTip": "Enter the user principal name with permissions to join computers to the domain in the selected OU.",
									"placeholder": "domainjoin@contoso.com",
									"constraints": {
										"required": true,
										"regex": "^[a-z0-9A-Z_.-]+@(?:[a-z0-9]+\\.)+[a-z]+$",
										"validationMessage": "The value must be a valid user principal name."
									},
									"visible": "[and(contains(steps('identity').solution, 'DomainServices'), equals(steps('identity').credentials.source, 'manual'))]"
								},
								{
									"name": "domainJoinUserPassword",
									"type": "Microsoft.Common.PasswordBox",
									"label": {
										"password": "Domain Join Account Password",
										"confirmPassword": "Confirm Password"
									},
									"toolTip": "Enter a password that is alphanumeric, contains at least 12 characters, 1 letter, 1 number and 1 special character.",
									"constraints": {
										"required": true
									},
									"options": {
										"hideConfirmation": false
									},
									"visible": "[and(contains(steps('identity').solution, 'DomainServices'), equals(steps('identity').credentials.source, 'manual'))]"
								},
								{
									"name": "localAdminUsername",
									"type": "Microsoft.Common.TextBox",
									"label": "Local Admin Username",
									"defaultValue": "",
									"toolTip": "Input the username for the local administrator account.",
									"constraints": {
										"required": true,
										"regex": "",
										"validationMessage": ""
									},
									"visible": "[equals(steps('identity').credentials.source, 'manual')]"
								},
								{
									"name": "localAdminPassword",
									"type": "Microsoft.Common.PasswordBox",
									"label": {
										"password": "Local Admin Password",
										"confirmPassword": "Confirm Password"
									},
									"toolTip": "Input the password for the local administrator account.",
									"constraints": {
										"required": true,
										"regex": "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=_!*<>()])(?=\\S+$).{12,123}$",
										"validationMessage": "The value must be within 12 to 123 characters, be alphanumeric, and include 1 lower case character, 1 upper case character, 1 number, and 1 special character that is not '//' or '-'."
									},
									"options": {
										"hideConfirmation": false
									},
									"visible": "[equals(steps('identity').credentials.source, 'manual')]"
								},
								{
									"name": "secretsInfoBox1",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(not(contains(steps('identity').solution, 'DomainServices')), equals(steps('identity').credentials.source, 'keyVault'))]",
									"options": {
										"text": "This add-on requires that the following secret names and values are stored in a key vault that you will select below:</br><ul><li><b>VirtualMachineAdminUserName</b>: The virtual machine administrator username.</li><li><b>VirtualMachineAdminPassword</b>: The virtual machine administrator password.",
										"style": "Info"
									}
								},
								{
									"name": "secretsInfoBox2",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(contains(steps('identity').solution, 'DomainServices'), equals(steps('identity').credentials.source, 'keyVault'))]",
									"options": {
										"text": "This add-on requires that the following secret names and values are stored in a key vault that you will select below:</br><ul><li><b>DomainJoinUserPrincipalName</b>: The domain join account UserPrincipalName (i.e., domjoin@contoso.local).</li><li><b>DomainJoinUserPassword</b>: The password associated with the domain join user account.</li><li><b>VirtualMachineAdminUserName</b>: The virtual machine administrator username.</li><li><b>VirtualMachineAdminPassword</b>: The virtual machine administrator password.",
										"style": "Info"
									}
								},
								{
									"name": "keyVault",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Select Keyvault containing workload secrets",
									"resourceType": "Microsoft.KeyVault/vaults",
									"toolTip": "Select Keyvault which contains the domain join secrets",
									"constraints": {
										"required": true
									},
									"visible": "[equals(steps('identity').credentials.source, 'keyVault')]"
								}
							]
						}
					]
				},
				{
					"name": "controlPlane",
					"label": "Control Plane",
					"elements": [
						{
							"name": "controlPlaneTextBlock0",
							"type": "Microsoft.Common.TextBlock",
							"visible": "[equals(steps('basics').deploymentType, 'SessionHostsOnly')]",
							"options": {
								"text": "This page is intentionally blank when only completing a Session Host Deployment."
							}
						},
						{
							"name": "scope",
							"type": "Microsoft.Common.Section",
							"label": "Subscription and Location Details",
							"elements": [
								{
									"name": "subscription",
									"type": "Microsoft.Common.DropDown",
									"label": "Subscription",
									"constraints": {
										"allowedValues": "[map(steps('basics').subscriptionsApi.value, (sub) => parse(concat('{\"label\":\"', sub.displayName, '\",\"value\":{\"displayName\":\"', sub.displayName, '\",\"id\":\"', sub.id, '\",\"subscriptionId\":\"', sub.subscriptionId, '\"}}')))]",
										"required": true
									},
									"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]"
								},
								{
									"type": "Microsoft.Common.LocationSelector",
									"name": "location",
									"label": "Region",
									"resourceTypes": [
										"Microsoft.DesktopVirtualization/Workspaces",
										"Microsoft.DesktopVirtualization/Hostpools"
									],
									"scope": {
										"subscriptionId": "[steps('controlPlane').scope.subscription.subscriptionId]"
									},
									"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]"
								},
								{
									"name": "desktopVirtualizationProviderApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[not(empty(steps('controlPlane').scope.subscription.id))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('controlPlane').scope.subscription.id, '/providers/Microsoft.DesktopVirtualization?api-version=2021-04-01')]"
									}
								},
								{
									"name": "desktopVirtualizationResourceProviderNotRegisteredErrorBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(not(empty(steps('controlPlane').scope.subscription.id)), not(equals(steps('controlPlane').scope.desktopVirtualizationProviderApi.registrationState, 'Registered')))]",
									"options": {
										"style": "Error",
										"text": "The Desktop Virtualization Resource Provider is not registered in this subscription. Follow the instructions in the link to register the resource provider",
										"uri": "https://learn.microsoft.com/en-us/azure/virtual-desktop/prerequisites?tabs=portal"
									}
								}
							],
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]"
						},
						{
							"name": "virtualNetworksApi",
							"condition": "[not(empty(steps('controlPlane').scope.subscription))]",
							"type": "Microsoft.Solutions.ArmApiControl",
							"request": {
								"method": "GET",
								"path": "[concat(steps('controlPlane').scope.subscription.id, '/providers/Microsoft.Network/virtualNetworks?api-version=2022-11-01')]"
							}
						},
						{
							"name": "workspacesApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"condition": "[not(empty(steps('controlPlane').scope.subscription))]",
							"request": {
								"method": "GET",
								"path": "[concat(steps('controlPlane').scope.subscription.id, '/providers/Microsoft.DesktopVirtualization/workspaces?api-version=2022-02-10-preview')]"
							}
						},
						{
							"name": "workspace",
							"type": "Microsoft.Common.Section",
							"label": "Workspace",
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
							"elements": [
								{
									"name": "textBlock1",
									"type": "Microsoft.Common.TextBlock",
									"options": {
										"text": "There is an existing AVD workspace in the control plane region you selected. This solution allows you to update the application group references of an existing AVD Workspace or create a new Workspace. Select the appropriate option below."
									},
									"visible": "[and(equals(steps('basics').deploymentType, 'Complete'), not(empty(filter(steps('controlPlane').workspacesApi.value, (ws) => equals(ws.location, steps('controlPlane').scope.location.name)))))]"
								},
								{
									"name": "createOption",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Workspace Creation Option",
									"defaultValue": "Update an existing Workspace",
									"visible": "[and(equals(steps('basics').deploymentType, 'Complete'), not(empty(filter(steps('controlPlane').workspacesApi.value, (ws) => equals(ws.location, steps('controlPlane').scope.location.name)))))]",
									"constraints": {
										"allowedValues": [
											{
												"label": "Create a new Workspace",
												"value": "new"
											},
											{
												"label": "Update an existing Workspace",
												"value": "update"
											}
										],
										"required": true
									}
								},
								{
									"name": "warningBox1",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[equals(steps('controlPlane').workspace.createOption, 'new')]",
									"options": {
										"style": "Warning",
										"text": "When you choose create to create a new workspace this solution will overwrite any existing application group references <u>if the workspace already exists</u>. This could cause an outage if existing hostpools and application groups are already registered with this workspace."
									}
								},
								{
									"name": "textBlock3",
									"type": "Microsoft.Common.TextBlock",
									"options": {
										"text": "Select an existing AVD Workspace below to which the Desktop Application Group will be registered."
									},
									"visible": "[and(or(equals(steps('basics').deploymentType, 'HostpoolOnly'), equals(steps('controlPlane').workspace.createOption, 'update') ), not(empty(filter(steps('controlPlane').workspacesApi.value, (ws) => equals(ws.location, steps('controlPlane').scope.location.name)))))]"
								},
								{
									"name": "existingWorkspace",
									"type": "Microsoft.Common.DropDown",
									"label": "Existing AVD Workspace",
									"multiLine": true,
									"toolTip": "Select the existing AVD Workspace to update with the Desktop Application Group deployed via this solution.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(filter(steps('controlPlane').workspacesApi.value, (ws) => equals(ws.location, steps('controlPlane').scope.location.name)), (vdws) => parse(concat('{\"label\":\"', vdws.name, '\",\"description\":\"Friendly Name: ', vdws.properties.friendlyName, ', Resource Group: ', first(skip(split(vdws.id, '/'), 4)), '\",\"value\":\"', vdws.id, '\"}')))]"
									},
									"visible": "[and(or(equals(steps('basics').deploymentType, 'HostpoolOnly'), equals(steps('controlPlane').workspace.createOption, 'update')), not(empty(filter(steps('controlPlane').workspacesApi.value, (ws) => equals(ws.location, steps('controlPlane').scope.location.name)))))]"
								},
								{
									"name": "errorBox1",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(equals(steps('basics').deploymentType, 'HostpoolOnly'), empty(filter(steps('controlPlane').workspacesApi.value, (ws) => equals(ws.location, steps('controlPlane').scope.location.name))))]",
									"options": {
										"style": "Error",
										"text": "There are no available workspaces in this region and subscription. Check your selections or choose a 'Complete' deployment on the 'Basics' page."
									}
								}
							]
						},
						{
							"name": "naming",
							"type": "Microsoft.Common.Section",
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
							"label": "Naming",
							"elements": [
								{
									"name": "workspaceFriendlyName",
									"type": "Microsoft.Common.TextBox",
									"label": "Workspace Friendly Name",
									"toolTip": "Optionally, input the friendly name for the AVD workspace that will be displayed in the end user's client.",
									"constraints": {
										"required": false,
										"regex": "^.{1,64}$",
										"validationMessage": "The value must be between 1 and 64 characters in length."
									},
									"visible": "[and(equals(steps('basics').deploymentType, 'Complete'), not(equals(steps('controlPlane').workspace.createOption, 'update')))]"
								},
								{
									"name": "desktopFriendlyName",
									"type": "Microsoft.Common.TextBox",
									"label": "Session Desktop Friendly Name",
									"defaultValue": "",
									"toolTip": "Optionally, input the friendly name for the default SessionDesktop that will be displayed in the end user's client.",
									"constraints": {
										"required": false,
										"regex": "^.{1,20}$",
										"validationMessage": "The value must be between 1 and 20 characters in length."
									}
								}
							]
						},
						{
							"name": "hostPool",
							"type": "Microsoft.Common.Section",
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
							"label": "Host Pool",
							"elements": [
								{
									"name": "validation",
									"type": "Microsoft.Common.CheckBox",
									"label": "Validation Environment",
									"toolTip": "Choose whether to deploy the host pool as a validation environment. This allows you test preview features for AVD before they are released to production.",
									"constraints": {
										"required": false
									}
								},
								{
									"name": "type",
									"type": "Microsoft.Common.DropDown",
									"label": "Type",
									"defaultValue": "Pooled",
									"multiLine": true,
									"toolTip": "",
									"constraints": {
										"required": true,
										"allowedValues": [
											{
												"label": "Pooled",
												"value": "Pooled"
											},
											{
												"label": "Personal",
												"value": "Personal"
											}
										]
									}
								},
								{
									"name": "loadBalancerAlgorithm",
									"type": "Microsoft.Common.DropDown",
									"visible": "[equals(steps('controlPlane').hostPool.type, 'Pooled')]",
									"label": "Load Balancing Algorithm",
									"defaultValue": "Breadth-First",
									"multiLine": true,
									"toolTip": "Breadth-first load balancing distributes new user sessions across all available session hosts in the host pool. Depth-first load balancing distributes new user sessions to an available session host with the highest number of connections but has not reached its maximum session limit threshold.",
									"constraints": {
										"required": true,
										"allowedValues": [
											{
												"label": "Breadth-First",
												"description": "Each new session is placed on the next VM. (Performance Optimized)",
												"value": "BreadthFirst"
											},
											{
												"label": "Depth-First",
												"description": "Each new session is placed on the same VM until max sessions limit. (Cost Optimized)",
												"value": "DepthFirst"
											}
										]
									}
								},
								{
									"name": "rdpProperties",
									"type": "Microsoft.Common.TextBox",
									"visible": true,
									"label": "Custom RDP properties",
									"toolTip": "Specify the configuration for the RDP properties on the AVD host pool.",
									"constraints": {
										"required": false
									}
								},
								{
									"name": "maxSessions",
									"type": "Microsoft.Common.TextBox",
									"visible": "[equals(steps('controlPlane').hostPool.type, 'Pooled')]",
									"label": "Max Session Limit",
									"defaultValue": "8",
									"toolTip": "The maximum number of users that have concurrent sessions on a session host. When setting a host pool to have depth first load balancing or planning to use Autoscaling, you must set an appropriate max session limit according to the configuration of your deployment and capacity of your VMs.",
									"constraints": {
										"required": true,
										"regex": "\\d+",
										"validationMessage": "The value must be one or more digits."
									}
								},
								{
									"name": "startVmOnConnect",
									"type": "Microsoft.Common.CheckBox",
									"label": "Start VM on Connect",
									"defaultValue": true,
									"toolTip": "Select to enable the Start VM on Connect feature.",
									"constraints": {
										"required": false
									}
								},
								{
									"name": "assignmentType",
									"type": "Microsoft.Common.DropDown",
									"visible": "[equals(steps('controlPlane').hostPool.type, 'Personal')]",
									"label": "Assignment Type",
									"defaultValue": "Automatic (Recommended)",
									"multiLine": true,
									"toolTip": "Automatic assignment - The service will select an available host and assign it to an user./nDirect assignment - Admin selects a specific host to assign to an user.",
									"constraints": {
										"required": true,
										"allowedValues": [
											{
												"label": "Automatic (Recommended)",
												"description": "Users are assigned an available VM the first time they connect.",
												"value": "Automatic"
											},
											{
												"label": "Direct",
												"description": "An administrator assigns a VM for each individual user.",
												"value": "Direct"
											}
										]
									}
								}
							]
						},
						{
							"name": "assignments",
							"type": "Microsoft.Common.Section",
							"label": "Assignments",
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
							"elements": [
								{
									"name": "groupPickerBlade",
									"type": "Microsoft.Solutions.BladeInvokeControl",
									"openBladeStatus": "[steps('controlPlane').assignments.groupSelector.changing]",
									"bladeReference": {
										"name": "ObjectPickerBlade",
										"extension": "Microsoft_AAD_IAM",
										"parameters": {
											"queries": "[if(equals(steps('identity').solution, 'ActiveDirectoryDomainServices'), 4194304, 32)]",
											"disablers": 4,
											"bladeSubtitle": "Pick the groups to assign",
											"additionalQueriesOnSearch": 0,
											"advancedQueryOptions": {
												"suggestedObjectsOptions": {}
											},
											"selectionMaximum": 3,
											"selectionMinimum": 1,
											"bladeTitle": "Select Groups",
											"informationHeader": {
												"informationText": "Select the groups to assign to the desktop application group",
												"informationLink": ""
											},
											"inviteEnabled": true,
											"searchBoxLabel": "Search for a group",
											"searchBoxPlaceHolderText": "Enter a string in the group name",
											"searchBoxTooltip": "This is the tooltip",
											"searchGridNoRowsMessage": "No groups found",
											"selectButtonText": "Select Groups",
											"selectedGridLabel": "Selected Groups",
											"selectedGridNoRowsMessage": "You must select at least one group"
										},
										"inFullScreen": false
									},
									"transforms": {
										"groups": "selectedObjects|[*].{id:id, name:displayName}"
									}
								},
								{
									"name": "groupSelector",
									"type": "Microsoft.Common.Selector",
									"label": "Select Groups",
									"keyPath": "displayName",
									"descriptionKeyPath": "id",
									"value": "[steps('controlPlane').assignments.groupPickerBlade.transformed.groups]",
									"visible": true,
									"barColor": "[if(empty(steps('controlPlane').assignments.groupPickerBlade), '#FF0000', '#7fba00')]",
									"constraints": {
										"required": true
									},
									"link": "[if(empty(steps('controlPlane').assignments.groupPickerBlade), 'Select groups', 'Update selected groups')]"
								}
							]
						},
						{
							"name": "scalingPlan",
							"type": "Microsoft.Common.Section",
							"label": "Scaling Plan",
							"elements": [
								{
									"name": "deployScalingPlan",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Deploy Scaling Plan",
									"defaultValue": "No",
									"toolTip": "Select Yes to configure and deploy a scaling plan specific to the host pool.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "exclusionTag",
									"type": "Microsoft.Common.TextBox",
									"label": "Tag to exclude hosts from Scaling",
									"placeholder": "",
									"defaultValue": "DoNotScale",
									"toolTip": "Use only allowed characters",
									"constraints": {
										"required": true,
										"regex": "^[a-z0-9A-Z]{1,30}$",
										"validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
									},
									"visible": "[steps('controlPlane').scalingPlan.deployScalingPlan]"
								},
								{
									"name": "textBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('controlPlane').scalingPlan.deployScalingPlan]",
									"options": {
										"text": "Use the grids and selectors below to configure the Weekday Scaling Plan schedule."
									}
								},
								{
									"name": "weekdayRampUpSchedule",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Enter Weekday Schedule Information",
									"label": "Weekday Ramp Up Schedule",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 1,
												"max": 1
											}
										},
										"columns": [
											{
												"id": "startTime",
												"header": "Ramp Up Time",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "8:00",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(0?[1-9]|1[0-9]|2[0-3]):[0-5][0-9]$",
																"message": "Must be a valid 24-hour time format without leading zeros."
															}
														]
													}
												}
											},
											{
												"id": "minimumHostsPct",
												"header": "Min % of Hosts",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "20",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^([1-9][0-9]?|100)$",
																"message": "Must be an integer from 1 - 100."
															}
														]
													}
												}
											},
											{
												"id": "capacityThresholdPct",
												"header": "Capacity threshold (%)",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "60",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^([1-9][0-9]?|100)$",
																"message": "Must be an integer from 1 - 100."
															}
														]
													}
												}
											},
											{
												"id": "loadBalancingAlgorithm",
												"header": "Load Balancing Algorithm",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Breadth-First",
																"value": "BreadthFirst"
															},
															{
																"label": "Depth-First",
																"value": "DepthFirst"
															}
														],
														"defaultValue": "Breadth-First",
														"required": true
													}
												}
											}
										]
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Pooled'))]"
								},
								{
									"name": "rampUpTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Personal'))]",
									"options": {
										"text": "<b>Ramp Up</b><br>Configures the time at which the scaling plan will begin to start VM's and make them available for users."
									}
								},
								{
									"name": "personalWeekdayRampUpSchedule",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Enter Schedule Information",
									"label": "Ramp Up Schedule",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 1,
												"max": 2
											}
										},
										"columns": [
											{
												"id": "days",
												"header": "Schedule Type",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Weekdays",
																"value": "Weekdays"
															},
															{
																"label": "Weekends",
																"value": "Weekends"
															}
														],
														"defaultValue": "Weekdays",
														"required": true
													}
												}
											},
											{
												"id": "startTime",
												"header": "Ramp Up Time",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "8:00",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(0?[1-9]|1[0-9]|2[0-3]):[0-5][0-9]$",
																"message": "Must be a valid 24-hour time format without leading zeros."
															}
														]
													}
												}
											},
											{
												"id": "startVMs",
												"header": "VMs to start",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Assigned VMs only",
																"value": "Assigned"
															},
															{
																"label": "Assigned and unassigned VMs",
																"value": "All"
															},
															{
																"label": "Don't turn VMs on at same time",
																"value": "None"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											},
											{
												"id": "disconnectMinutes",
												"header": "Disconnect Delay (mins)",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^\\d+$",
																"message": "Must be an integer."
															}
														]
													}
												}
											},
											{
												"id": "disconnectAction",
												"header": "Disconnect Action",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "None",
																"value": "None"
															},
															{
																"label": "Shutdown",
																"value": "Deallocate"
															},
															{
																"label": "Hibernate",
																"value": "Hibernate"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											},
											{
												"id": "logoffMinutes",
												"header": "Logoff Delay (mins)",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^\\d+$",
																"message": "Must be an integer."
															}
														]
													}
												}
											},
											{
												"id": "logoffAction",
												"header": "Logoff Action",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "None",
																"value": "None"
															},
															{
																"label": "Shutdown",
																"value": "Deallocate"
															},
															{
																"label": "Hibernate",
																"value": "Hibernate"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											}
										]
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Personal'))]"
								},
								{
									"name": "weekdayPeakSchedule",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Enter Weekday Schedule Information",
									"label": "Weekday Peak Schedule",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 1,
												"max": 1
											}
										},
										"columns": [
											{
												"id": "startTime",
												"header": "Peak Start Time",
												"width": "5fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "9:00",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(0?[1-9]|1[0-9]|2[0-3]):[0-5][0-9]$",
																"message": "Must be a valid 24-hour time format without leading zeros."
															}
														]
													}
												}
											},
											{
												"id": "loadBalancingAlgorithm",
												"header": "Load Balancing Algorithm",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Breadth-First",
																"value": "BreadthFirst"
															},
															{
																"label": "Depth-First",
																"value": "DepthFirst"
															}
														],
														"defaultValue": "Depth-First",
														"required": true
													}
												}
											}
										]
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Pooled'))]"
								},
								{
									"name": "peakTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Personal'))]",
									"options": {
										"text": "<b>Peak</b><br>Configures the time at which the scaling plan enters the peak usage phase."
									}
								},
								{
									"name": "personalWeekdayPeakSchedule",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Enter Schedule Information",
									"label": "Peak Schedule",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 1,
												"max": 2
											}
										},
										"columns": [
											{
												"id": "days",
												"header": "Schedule Type",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Weekdays",
																"value": "Weekdays"
															},
															{
																"label": "Weekends",
																"value": "Weekends"
															}
														],
														"defaultValue": "Weekdays",
														"required": true
													}
												}
											},
											{
												"id": "startTime",
												"header": "Peak Start Time",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "9:00",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(0?[1-9]|1[0-9]|2[0-3]):[0-5][0-9]$",
																"message": "Must be a valid 24-hour time format without leading zeros."
															}
														]
													}
												}
											},
											{
												"id": "disconnectMinutes",
												"header": "Disconnect Delay (mins)",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^\\d+$",
																"message": "Must be an integer."
															}
														]
													}
												}
											},
											{
												"id": "disconnectAction",
												"header": "Disconnect Action",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "None",
																"value": "None"
															},
															{
																"label": "Shutdown",
																"value": "Deallocate"
															},
															{
																"label": "Hibernate",
																"value": "Hibernate"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											},
											{
												"id": "logoffMinutes",
												"header": "Logoff Delay (mins)",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^\\d+$",
																"message": "Must be an integer."
															}
														]
													}
												}
											},
											{
												"id": "logoffAction",
												"header": "Logoff Action",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "None",
																"value": "None"
															},
															{
																"label": "Shutdown",
																"value": "Deallocate"
															},
															{
																"label": "Hibernate",
																"value": "Hibernate"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											}
										]
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Personal'))]"
								},
								{
									"name": "weekdayRampDownSchedule",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Enter Weekday Schedule Information",
									"label": "Weekday Ramp Down Schedule",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 1,
												"max": 1
											}
										},
										"columns": [
											{
												"id": "startTime",
												"header": "Ramp Down Start Time",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "18:00",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(0?[1-9]|1[0-9]|2[0-3]):[0-5][0-9]$",
																"message": "Must be a valid 24-hour time format without leading zeros."
															}
														]
													}
												}
											},
											{
												"id": "minimumHostsPct",
												"header": "Min % of Hosts",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^([1-9][0-9]?|100)$",
																"message": "Must be an integer from 1 - 100."
															}
														]
													}
												}
											},
											{
												"id": "capacityThresholdPct",
												"header": "Capacity threshold (%)",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "90",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^([1-9][0-9]?|100)$",
																"message": "Must be an integer from 1 - 100."
															}
														]
													}
												}
											},
											{
												"id": "loadBalancingAlgorithm",
												"header": "Load Balancing Algorithm",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Breadth-First",
																"value": "BreadthFirst"
															},
															{
																"label": "Depth-First",
																"value": "DepthFirst"
															}
														],
														"defaultValue": "Depth-First",
														"required": true
													}
												}
											}
										]
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Pooled'))]"
								},
								{
									"name": "rampDownTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Personal'))]",
									"options": {
										"text": "<b>Ramp Down</b><br>Configures the time at which the scaling plan begins to stop VM's and force logoff users (if configured)."
									}
								},
								{
									"name": "personalWeekdayRampDownSchedule",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Enter Schedule Information",
									"label": "Ramp Down Schedule",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 1,
												"max": 2
											}
										},
										"columns": [
											{
												"id": "days",
												"header": "Schedule Type",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Weekdays",
																"value": "Weekdays"
															},
															{
																"label": "Weekends",
																"value": "Weekends"
															}
														],
														"defaultValue": "Weekdays",
														"required": true
													}
												}
											},
											{
												"id": "startTime",
												"header": "Ramp Down Start Time",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "18:00",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(0?[1-9]|1[0-9]|2[0-3]):[0-5][0-9]$",
																"message": "Must be a valid 24-hour time format without leading zeros."
															}
														]
													}
												}
											},
											{
												"id": "disconnectMinutes",
												"header": "Disconnect Delay (mins)",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^\\d+$",
																"message": "Must be an integer."
															}
														]
													}
												}
											},
											{
												"id": "disconnectAction",
												"header": "Disconnect Action",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "None",
																"value": "None"
															},
															{
																"label": "Shutdown",
																"value": "Deallocate"
															},
															{
																"label": "Hibernate",
																"value": "Hibernate"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											},
											{
												"id": "logoffMinutes",
												"header": "Logoff Delay (mins)",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^\\d+$",
																"message": "Must be an integer."
															}
														]
													}
												}
											},
											{
												"id": "logoffAction",
												"header": "Logoff Action",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "None",
																"value": "None"
															},
															{
																"label": "Shutdown",
																"value": "Deallocate"
															},
															{
																"label": "Hibernate",
																"value": "Hibernate"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											}
										]
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Personal'))]"
								},
								{
									"name": "forceLogoff",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Force Logoff during Ramp Down",
									"defaultValue": "No",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": true
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Pooled'))]"
								},
								{
									"name": "minsToLogoff",
									"type": "Microsoft.Common.TextBox",
									"label": "Number of minutes before users are forcefully logged off",
									"placeholder": "30",
									"toolTip": "Use only integers",
									"constraints": {
										"required": true,
										"regex": "^(?:[1-9]|[1-9][0-9]|1[01][0-9]|120)$",
										"validationMessage": "Must be an integer from 1 - 120."
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, steps('controlPlane').scalingPlan.forceLogoff, equals(steps('controlPlane').hostPool.type, 'Pooled'))]"
								},
								{
									"name": "weekdayOffPeakSchedule",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Enter Weekday Off Peak Schedule Information",
									"label": "Weekday Off Peak Schedule",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 1,
												"max": 1
											}
										},
										"columns": [
											{
												"id": "startTime",
												"header": "Off Peak Start Time",
												"width": "5fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "22:00",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(0?[1-9]|1[0-9]|2[0-3]):[0-5][0-9]$",
																"message": "Must be a valid 24-hour time format without leading zeros."
															}
														]
													}
												}
											},
											{
												"id": "loadBalancingAlgorithm",
												"header": "Load Balancing Algorithm",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Breadth-First",
																"value": "BreadthFirst"
															},
															{
																"label": "Depth-First",
																"value": "DepthFirst"
															}
														],
														"defaultValue": "Depth-First",
														"required": true
													}
												}
											}
										]
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Pooled'))]"
								},
								{
									"name": "personalWeekdayOffPeakSchedule",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Enter Weekday Off Peak Schedule Information",
									"label": "Weekday Off Peak Schedule",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 1,
												"max": 2
											}
										},
										"columns": [
											{
												"id": "days",
												"header": "Schedule Type",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "Weekdays",
																"value": "Weekdays"
															},
															{
																"label": "Weekends",
																"value": "Weekends"
															}
														],
														"defaultValue": "Weekdays",
														"required": true
													}
												}
											},
											{
												"id": "startTime",
												"header": "Off Peak Start Time",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "22:00",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(0?[1-9]|1[0-9]|2[0-3]):[0-5][0-9]$",
																"message": "Must be a valid 24-hour time format without leading zeros."
															}
														]
													}
												}
											},
											{
												"id": "disconnectMinutes",
												"header": "Disconnect Delay (mins)",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^\\d+$",
																"message": "Must be an integer."
															}
														]
													}
												}
											},
											{
												"id": "disconnectAction",
												"header": "Disconnect Action",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "None",
																"value": "None"
															},
															{
																"label": "Shutdown",
																"value": "Deallocate"
															},
															{
																"label": "Hibernate",
																"value": "Hibernate"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											},
											{
												"id": "logoffMinutes",
												"header": "Logoff Delay (mins)",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "10",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^\\d+$",
																"message": "Must be an integer."
															}
														]
													}
												}
											},
											{
												"id": "logoffAction",
												"header": "Logoff Action",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.DropDown",
													"constraints": {
														"allowedValues": [
															{
																"label": "None",
																"value": "None"
															},
															{
																"label": "Shutdown",
																"value": "Deallocate"
															},
															{
																"label": "Hibernate",
																"value": "Hibernate"
															}
														],
														"defaultValue": "None",
														"required": true
													}
												}
											}
										]
									},
									"visible": "[and(steps('controlPlane').scalingPlan.deployScalingPlan, equals(steps('controlPlane').hostPool.type, 'Personal'))]"
								}
							],
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]"
						}
					]
				},
				{
					"name": "hosts",
					"label": "Session Hosts",
					"elements": [
						{
							"name": "scope",
							"type": "Microsoft.Common.Section",
							"label": "Subscription and Location Details",
							"elements": [
								{
									"name": "subscription",
									"type": "Microsoft.Common.DropDown",
									"label": "Subscription",
									"defaultValue": "[steps('controlPlane').scope.subscription.displayName]",
									"constraints": {
										"allowedValues": "[map(steps('basics').subscriptionsApi.value, (sub) => parse(concat('{\"label\":\"', sub.displayName, '\",\"value\":{\"displayName\":\"', sub.displayName, '\",\"id\":\"', sub.id, '\",\"subscriptionId\":\"', sub.subscriptionId, '\"}}')))]",
										"required": true
									}
								},
								{
									"name": "resourceGroupsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), not(empty(steps('hosts').scope.subscription.id)))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.subscription.id, '/resourcegroups?api-version=2021-04-01')]"
									}
								},
								{
									"name": "resourceGroup",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Machine Resource Group",
									"defaultValue": "[steps('basics').hostPoolApi.tags.vmResourceGroup]",
									"multiLine": true,
									"constraints": {
										"allowedValues": "[map(filter(filter(steps('hosts').scope.resourceGroupsApi.value, (rg) => and(contains(rg.name, 'hosts'), not(empty(rg.tags)))), (rg) => not(empty(rg.tags.cm-resource-parent))), (rg) => parse(concat('{\"label\":\"', rg.name, '\",\"description\":\"hostPool: ', last(split(rg.tags.cm-resource-parent, '/')), '\",\"value\":{\"location\":\"', rg.location, '\",\"name\":\"', rg.name, '\",\"id\":\"', rg.id, '\"}}')))]",
										"required": true
									},
									"visible": "[equals(steps('basics').deploymentType, 'SessionHostsOnly')]"
								},
								{
									"name": "locationsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[not(empty(steps('hosts').scope.subscription.id))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.subscription.id, '/locations?api-version=2022-12-01')]",
										"transforms": {
											"list": "sort_by(value, &displayName)[?name!='global' && !contains(displayName, '(Stage)')] | [*].{label: displayName, value: { displayName: displayName, name: name }}"
										}
									}
								},
								{
									"name": "location",
									"type": "Microsoft.Common.DropDown",
									"label": "Region",
									"toolTip": "Select the region where you want to deploy the virtual machines.",
									"defaultValue": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), first(map(filter(steps('hosts').scope.locationsApi.value, (loc) => equals(loc.name, steps('hosts').scope.resourceGroup.location)), (loc) => loc.displayName)), steps('controlPlane').scope.location.displayName)]",
									"constraints": {
										"allowedValues": "[steps('hosts').scope.locationsApi.transformed.list]"
									}
								},
								{
									"name": "timeZone",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Machines Time Zone",
									"toolTip": "Select the time zone for the virtual machines.",
									"defaultValue": "(UTC-05:00) Eastern Time (US & Canada)",
									"constraints": {
										"allowedValues": [
											{
												"label": "(UTC-10:00) Hawaii",
												"value": "Hawaiian Standard Time"
											},
											{
												"label": "(UTC-09:00) Alaska",
												"value": "Alaskan Standard Time"
											},
											{
												"label": "(UTC-08:00) Pacific Time (US & Canada)",
												"value": "Pacific Standard Time"
											},
											{
												"label": "(UTC-07:00) Arizona",
												"value": "US Mountain Standard Time"
											},
											{
												"label": "(UTC-07:00) Mountain Time (US & Canada)",
												"value": "Mountain Standard Time"
											},
											{
												"label": "(UTC-06:00) Central Time (US & Canada)",
												"value": "Central Standard Time"
											},
											{
												"label": "(UTC-05:00) Eastern Time (US & Canada)",
												"value": "Eastern Standard Time"
											},
											{
												"label": "(UTC+00:00) Dublin, Edinburgh, Lisbon, London",
												"value": "GMT Standard Time"
											},
											{
												"label": "(UTC+01:00) Brussels, Copenhagen, Madrid, Paris",
												"value": "Romance Standard Time"
											},
											{
												"label": "(UTC+01:00) Sarajevo, Skopje, Warsaw, Zagreb",
												"value": "Central European Standard Time"
											},
											{
												"label": "(UTC+01:00) Belgrade, Bratislava, Budapest, Ljubljana, Prague",
												"value": "Central Europe Standard Time"
											},
											{
												"label": "(UTC+01:00) West Central Africa",
												"value": "W. Central Africa Standard Time"
											},
											{
												"label": "(UTC+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna",
												"value": "W. Europe Standard Time"
											},
											{
												"label": "(UTC+02:00) Jerusalem",
												"value": "Israel Standard Time"
											},
											{
												"label": "(UTC+03:00) Kuwait, Riyadh",
												"value": "Arab Standard Time"
											},
											{
												"label": "(UTC+03:00) Nairobi",
												"value": "E. Africa Standard Time"
											},
											{
												"label": "(UTC+09:00) Osaka, Sapporo, Tokyo",
												"value": "Tokyo Standard Time"
											},
											{
												"label": "(UTC+09:00) Seoul",
												"value": "Korea Standard Time"
											},
											{
												"label": "(UTC+10:00) Guam, Port Moresby",
												"value": "West Pacific Standard Time"
											}
										],
										"required": true
									},
									"visible": true
								}
							]
						},
						{
							"name": "resourceSkusApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"condition": "[and(not(empty(steps('hosts').scope.subscription.id)), not(empty(steps('hosts').scope.location)))]",
							"request": {
								"method": "GET",
								"path": "[concat(steps('hosts').scope.subscription.id, '/providers/Microsoft.Compute/skus?api-version=2021-07-01&$filter=location eq ', decodeUriComponent('%27'), steps('hosts').scope.location.name, decodeUriComponent('%27'))]",
								"transforms": {
									"confidentialVMSizes": "value[?resourceType=='virtualMachines'&&ends_with(name, `v5`)&&(starts_with(name, `Standard_DC`)||starts_with(name, `Standard_EC`)||starts_with(name, `Standard_NCC`))]|[*].{label:name, value:name}"
								}
							}
						},
						{
							"name": "encryptionAtHostFeatureApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"condition": "[not(empty(steps('hosts').scope.subscription.id))]",
							"request": {
								"method": "GET",
								"path": "[concat(steps('hosts').scope.subscription.id, '/providers/Microsoft.Features/providers/Microsoft.Compute/features/encryptionAtHost?api-version=2021-07-01')]"
							}
						},
						{
							"name": "naming",
							"type": "Microsoft.Common.Section",
							"label": "Naming",
							"elements": [
								{
									"name": "virtualMachineNamePrefix",
									"type": "Microsoft.Common.TextBox",
									"label": "Virtual Machine Name Prefix",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmNamePrefix)), toLower(concat('avd', steps('basics').naming.identifier, if(empty(steps('basics').naming.index), '', concat('-', steps('basics').naming.index)))), steps('basics').hostPoolApi.tags.vmNamePrefix)]",
									"toolTip": "Provide a Virtual Machine name prefix consisting of alphanumeric and dashes up to 12 characters long. A three character numeric suffix will be appended to the name padded with zeros (0).",
									"constraints": {
										"required": true,
										"validations": [
											{
												"regex": "^(?!-)(?!_)(?![0-9]+$)[A-Za-z0-9_-]+$",
												"message": "The prefix can only contain valid character types for computer names."
											},
											{
												"isValid": "[if(lessOrEquals(add(length(steps('hosts').naming.virtualMachineNamePrefix), steps('hosts').naming.indexPadding), 15), true, false)]",
												"message": "The length of the virtual machine name prefix and the index padding cannot exceed 15 characters."
											}
										]
									},
									"visible": true
								},
								{
									"name": "index",
									"type": "Microsoft.Common.Slider",
									"label": "Starting number (index)",
									"defaultValue": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), if(empty(steps('basics').hostPoolApi.tags.vmIndexPadding), 1, add(int(substring(steps('basics').sessionHostsApi.transformed.lastname, sub(length(steps('basics').sessionHostsApi.transformed.lastname), int(steps('basics').hostPoolApi.tags.vmIndexPadding)), int(steps('basics').hostPoolApi.tags.vmIndexPadding))), 1)), 1)]",
									"toolTip": "Select the start number of the virtual machine suffix.",
									"min": 1,
									"max": 998,
									"showStepMarkers": true,
									"constraints": {
										"required": true
									},
									"visible": true
								},
								{
									"name": "indexPadding",
									"type": "Microsoft.Common.Slider",
									"label": "Index Padding (number of digits)",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmIndexPadding)), 2, int(steps('basics').hostPoolApi.tags.vmIndexPadding))]",
									"toolTip": "Select the number of digits used by the index. This value determines the max length of the prefix and also the max number of hosts",
									"min": 1,
									"max": 3,
									"showStepMarkers": true,
									"constraints": {
										"required": true
									},
									"visible": true
								}
							],
							"visible": true
						},
						{
							"name": "network",
							"type": "Microsoft.Common.Section",
							"label": "Network",
							"visible": true,
							"elements": [
								{
									"name": "virtualNetworksApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[not(empty(steps('hosts').scope.subscription))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.subscription.id, '/providers/Microsoft.Network/virtualNetworks?api-version=2022-11-01')]"
									}
								},
								{
									"name": "virtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Network",
									"defaultValue": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), coalesce(first(skip(split(steps('basics').hostPoolApi.tags.vmSubnetId, '/'), 8)), ''), '')]",
									"multiLine": true,
									"toolTip": "Select the virtual network to which the session hosts will be attached. The list of virtual networks is filtered to those in the same region and subscription selected in the 'Subscription and Region Details' section above.",
									"constraints": {
										"allowedValues": "[map(filter(steps('hosts').network.virtualNetworksApi.value, (vnet) => equals(vnet.location, steps('hosts').scope.location.name)), (vnet) => parse(concat('{\"label\":\"', vnet.name, '\",\"description\":\"Location: ', vnet.location, ' Resource Group: ', first(skip(split(vnet.id, '/'), 4)), '\",\"value\":{\"name\":\"', vnet.name, '\",\"id\":\"', vnet.id, '\"}}')))]",
										"required": true
									}
								},
								{
									"name": "subnetsApi",
									"condition": "[not(empty(steps('hosts').network.virtualNetwork))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').network.virtualNetwork.id, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "subnet",
									"type": "Microsoft.Common.DropDown",
									"visible": true,
									"label": "Subnet",
									"defaultValue": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), coalesce(last(split(steps('basics').hostPoolApi.tags.vmSubnetId, '/')), ''), '')]",
									"toolTip": "Select an existing subnet for the AVD session hosts.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(steps('hosts').network.subnetsApi.value, (snet) => parse(concat('{\"label\":\"', snet.name, '\",\"value\":{\"name\":\"', snet.name, '\",\"id\":\"', snet.id, '\"}}')))]"
									}
								}
							]
						},
						{
							"name": "image",
							"type": "Microsoft.Common.Section",
							"visible": true,
							"label": "Image",
							"elements": [
								{
									"name": "source",
									"type": "Microsoft.Common.DropDown",
									"label": "Image Source",
									"filter": true,
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmImageType)), 'Marketplace', if(equals(steps('basics').hostPoolApi.tags.vmImageType, 'CustomImage'), 'Compute Gallery', 'Marketplace'))]",
									"toolTip": "Select the type of image to deploy on the session hosts.",
									"constraints": {
										"required": true,
										"allowedValues": [
											{
												"label": "Marketplace",
												"value": "marketplace"
											},
											{
												"label": "Compute Gallery",
												"value": "gallery"
											}
										]
									}
								},
								{
									"name": "offer",
									"type": "Microsoft.Common.DropDown",
									"label": "Offer",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmImageOffer)), 'Office-365', steps('basics').hostPoolApi.tags.vmImageOffer)]",
									"toolTip": "Select the desired marketplace image offer.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Office-365",
												"value": "Office-365"
											},
											{
												"label": "Windows-10",
												"value": "Windows-10"
											},
											{
												"label": "Windows-11",
												"value": "Windows-11"
											}
										],
										"required": true
									},
									"visible": "[equals(steps('hosts').image.source, 'marketplace')]"
								},
								{
									"name": "skuApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(not(empty(steps('hosts').scope.subscription.id)), not(empty(steps('hosts').scope.location)), not(empty(steps('hosts').image.offer)), equals(steps('hosts').image.source, 'marketplace'))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.subscription.id, '/providers/Microsoft.Compute/locations/', steps('hosts').scope.location.name, '/publishers/MicrosoftWindowsDesktop/artifacttypes/vmimage/offers/', steps('hosts').image.offer, '/skus?api-version=2022-08-01')]"
									}
								},
								{
									"name": "sku",
									"type": "Microsoft.Common.DropDown",
									"label": "SKU",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmImageSku)), 'win11-25h2-avd-m365', steps('basics').hostPoolApi.tags.vmImageSku)]",
									"toolTip": "Select the desired marketplace image SKU.",
									"constraints": {
										"allowedValues": "[map(filter(steps('hosts').image.skuApi, (sku) => and(startsWith(sku.name, 'win'), or(contains(sku.name, 'ent'), contains(sku.name, 'avd')))), (sku) => parse(concat('{\"label\":\"', sku.name, '\",\"value\":\"', sku.name, '\"}')))]",
										"required": true
									},
									"visible": "[equals(steps('hosts').image.source, 'marketplace')]"
								},
								{
									"name": "gallerySubscription",
									"type": "Microsoft.Common.DropDown",
									"label": "Compute Gallery Subscription",
									"defaultValue": "[steps('hosts').scope.subscription.displayName]",
									"constraints": {
										"allowedValues": "[map(steps('basics').subscriptionsApi.value, (sub) => parse(concat('{\"label\":\"', sub.displayName, '\",\"value\":{\"displayName\":\"', sub.displayName, '\",\"id\":\"', sub.id, '\",\"subscriptionId\":\"', sub.subscriptionId, '\"}}')))]",
										"required": false
									},
									"visible": "[equals(steps('hosts').image.source, 'gallery')]"
								},
								{
									"name": "galleriesApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(equals(steps('hosts').image.source, 'gallery'), not(empty(steps('hosts').image.gallerySubscription.id)))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').image.gallerySubscription.id, '/providers/Microsoft.Compute/galleries?api-version=2024-03-03')]"
									}
								},
								{
									"name": "computeGallery",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmCustomImageId)), '', first(skip(split(steps('basics').hostPoolApi.tags.vmCustomImageId, '/'), 8)))]",
									"label": "Compute Gallery",
									"multiLine": true,
									"constraints": {
										"allowedValues": "[map(steps('hosts').image.galleriesApi.value, (gal) => parse(concat('{\"label\":\"', gal.name, '\",\"description\":\"Resource Group: ', first(skip(split(gal.id, '/'), 4)), ', Location: ', gal.location, '\",\"value\":\"', gal.id, '\"}')))]",
										"required": true
									},
									"visible": "[and(equals(steps('hosts').image.source, 'gallery'), not(empty(steps('hosts').image.gallerySubscription)))]"
								},
								{
									"name": "imageDefinitionsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(equals(steps('hosts').image.source, 'gallery'), not(empty(steps('hosts').image.computeGallery)))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').image.computeGallery, '/images?api-version=2024-03-03')]",
										"transforms": {
											"list": "value|[*].{label:name, value:id}"
										}
									}
								},
								{
									"name": "imageDefinition",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmCustomImageId)), '', last(split(steps('basics').hostPoolApi.tags.vmCustomImageId, '/')))]",
									"label": "Image Definition",
									"constraints": {
										"allowedValues": "[steps('hosts').image.imageDefinitionsApi.transformed.list]",
										"required": true
									},
									"visible": "[and(equals(steps('hosts').image.source, 'gallery'), not(empty(steps('hosts').image.computeGallery)))]"
								},
								{
									"name": "imageDefinitionApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[not(empty(steps('hosts').image.imageDefinition))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').image.imageDefinition, '?api-version=2024-03-03')]",
										"transforms": {
											"IsHibernateSupported": "properties.features[?name=='IsHibernateSupported'].value | [0]",
											"IsAcceleratedNetworkSupported": "properties.features[?name=='IsAcceleratedNetworkSupported'].value | [0]",
											"SecurityType": "properties.features[?name=='SecurityType'].value | [0]"
										}
									}
								}
							]
						},
						{
							"name": "security",
							"type": "Microsoft.Common.Section",
							"label": "Security",
							"elements": [
								{
									"name": "securityType",
									"type": "Microsoft.Common.DropDown",
									"label": "Security Type",
									"placeholder": "",
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), 'TrustedLaunch', coalesce(steps('basics').hostPoolApi.tags.vmSecurityType, 'TrustedLaunch'))]",
									"toolTip": "Select the appropriate Security Type configuration for the Virtual Machine. Note that 'ConfidentialVMs' are not available in all regions and the option may not appear.",
									"constraints": {
										"allowedValues": "[if(and(not(empty(steps('hosts').resourceSkusApi.transformed.confidentialVMSizes)), or(equals(steps('hosts').image.source, 'marketplace'), equals(steps('hosts').image.imageDefinitionApi.transformed.SecurityType, 'TrustedLaunchAndConfidentialVmSupported'))), parse('[{\"label\":\"ConfidentialVM\",\"value\":\"ConfidentialVM\"},{\"label\":\"Standard\",\"value\":\"Standard\"},{\"label\":\"TrustedLaunch\",\"value\":\"TrustedLaunch\"}]'), if(and(not(empty(steps('hosts').resourceSkusApi.transformed.confidentialVMSizes)), equals(steps('hosts').image.source, 'gallery'), equals(steps('hosts').image.imageDefinitionApi.transformed.SecurityType, 'ConfidentialVM')), parse('[{\"label\":\"ConfidentialVM\",\"value\":\"ConfidentialVM\"}]'), if(and(not(empty(steps('hosts').resourceSkusApi.transformed.confidentialVMSizes)), equals(steps('hosts').image.source, 'gallery'), equals(steps('hosts').image.imageDefinitionApi.transformed.SecurityType, 'ConfidentialVmSupported')), parse('[{\"label\":\"ConfidentialVM\",\"value\":\"ConfidentialVM\"},{\"label\":\"Standard\",\"value\":\"Standard\"}]'), if(and(equals(steps('hosts').image.source, 'gallery'), equals(steps('hosts').image.imageDefinitionApi.transformed.SecurityType, 'TrustedLaunch')), parse('[{\"label\":\"TrustedLaunch\",\"value\":\"TrustedLaunch\"}]'), if(or(equals(steps('hosts').image.source, 'marketplace'), and(equals(steps('hosts').image.source, 'gallery'), contains(steps('hosts').image.imageDefinitionApi.transformed.SecurityType, 'TrustedLaunch'), contains(steps('hosts').image.imageDefinitionApi.transformed.SecurityType, 'Supported'))), parse('[{\"label\":\"Standard\",\"value\":\"Standard\"},{\"label\":\"TrustedLaunch\",\"value\":\"TrustedLaunch\"}]'), if(and(equals(steps('hosts').image.source, 'gallery'), or(equals(steps('hosts').image.imageDefinitionApi.transformed.SecurityType, 'ConfidentialVmSupported'), empty(steps('hosts').image.imageDefinitionApi.transformed.SecurityType))), parse('[{\"label\":\"Standard\",\"value\":\"Standard\"}]'), parse('[]')))))))]",
										"required": true
									},
									"visible": true
								},
								{
									"name": "secureBootEnabled",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable Secure Boot",
									"toolTip": "Secure boot helps protect your VMs against boot kits, rootkits, and kernel-level malware.",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmSecureBoot)), true, bool(steps('basics').hostPoolApi.tags.vmSecureBoot))]",
									"visible": "[not(equals(steps('hosts').security.securityType, 'Standard'))]"
								},
								{
									"name": "vTpmEnabled",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable vTPM",
									"toolTip": "Virtual Trusted Platform Module (vTPM) is TPM2.0 compliant and validates your VM boot integrity apart from securely storing keys and secrets.",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmVirtualTPM)), true, bool(steps('basics').hostPoolApi.tags.vmVirtualTPM))]",
									"visible": "[not(equals(steps('hosts').security.securityType, 'Standard'))]"
								},
								{
									"name": "integrityMonitoring",
									"type": "Microsoft.Common.CheckBox",
									"label": "Integrity Monitoring",
									"toolTip": "Integrity monitoring enables cryptographic attestation and verification of VM boot integrity along with monitoring alerts if the VM didn't boot because attestation failed with the defined baseline.",
									"defaultValue": true,
									"visible": "[not(equals(steps('hosts').security.securityType, 'Standard'))]"
								}
							]
						},
						{
							"name": "diskEncryption",
							"type": "Microsoft.Common.Section",
							"label": "Disk Encryption Options",
							"elements": [
								{
									"name": "diskEncryptionTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "There are several types of encryption available for your managed disks including Azure Disk Storage Server-Side Encryption (SSE), Encryption at Host (EAH), and Confidential disk encryption (when the Confidential VM security type is selected)."
									}
								},
								{
									"name": "sseTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "<ul><li><b>Azure Disk Storage Server-Side Encryption</b> is always enabled and automatically encrypts your data stored on Azure managed disks (OS and data disks) when persisting on the storage clusters.</li></ul>"
									}
								},
								{
									"name": "encryptionAtHostTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "<ul><li><b>Encryption at host</b> enhances Azure Disk Storage Server-Side Encryption to ensure that all temp disks and disk caches are encrypted at rest and flow encrypted to the Storage clusters.</li></ul>",
										"link": {
											"label": "Learn more",
											"uri": "http://go.microsoft.com/fwlink/?LinkId=2133517"
										}
									}
								},
								{
									"name": "encryptionAtHost",
									"type": "Microsoft.Common.CheckBox",
									"label": "Encryption At Host",
									"toolTip": "Check to enable Encryption At Host",
									"defaultValue": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), bool(steps('basics').hostPoolApi.tags.vmEncryptionAtHost), true)]",
									"visible": "[not(equals(steps('hosts').security.securityType, 'ConfidentialVM'))]"
								},
								{
									"name": "encryptionAtHostNotRegisteredErrorBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(not(equals(steps('hosts').encryptionAtHostFeatureApi.properties.state, 'Registered')), steps('hosts').diskEncryption.encryptionAtHost)]",
									"options": {
										"style": "Error",
										"text": "The 'Encryption At Host' feature is not registered in your subscription. Follow the guidance at this link to enable the feature and restart the deployment.",
										"uri": "https://learn.microsoft.com/en-us/azure/virtual-machines/disks-enable-host-based-encryption-portal?tabs=azure-powershell"
									}
								},
								{
									"name": "confidentialVMEncryptionTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[equals(steps('hosts').security.securityType, 'ConfidentialVM')]",
									"options": {
										"text": "<ul><li><b>Confidential disk encryption</b> binds disk encryption keys to the virtual machine's TPM and makes the protected disk content accessible only to the VM. The TPM and VM guest state is always encrypted in attested code using keys released by a secure protocol that bypasses the hypervisor and host operating system. Currently only available for the OS disk. Encryption at host may be used for other disks on a Confidential VM in addition to Confidential Disk Encryption.</li></ul>",
										"link": {
											"label": "Learn more",
											"uri": "https://learn.microsoft.com/en-us/azure/confidential-computing/confidential-vm-overview#confidential-os-disk-encryption"
										}
									}
								},
								{
									"name": "confidentialVMOSDiskEncryption",
									"type": "Microsoft.Common.CheckBox",
									"label": "Confidential OS Disk Encryption",
									"toolTip": "Check to enable Confidential VM disk encryption",
									"defaultValue": true,
									"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), equals(steps('hosts').security.securityType, 'ConfidentialVM'))]"
								},
								{
									"name": "keyManagementTextBlock1",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
									"options": {
										"text": "You can rely on platform-managed keys for the encryption of your managed disk, or you can manage encryption using your own keys. If you choose to manage encryption with your own keys, you can specify a customer-managed key to use for encrypting and decrypting all data in managed disks.",
										"link": {
											"label": "Learn more",
											"uri": "https://learn.microsoft.com/en-us/azure/virtual-machines/disk-encryption#about-encryption-key-management"
										}
									}
								},
								{
									"name": "keyManagementTextBlock2",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[equals(steps('basics').deploymentType, 'SessionHostsOnly')]",
									"options": {
										"text": "You can rely on platform-managed keys for the encryption of your managed disk, or you can manage encryption using your own keys. If you choose to manage encryption with your own keys, you must select the existing disk encryption set."
									}
								},
								{
									"name": "selectDiskEncryptionSet",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable Customer-Managed Keys on OS Disk",
									"defaultValue": "[not(empty(steps('basics').hostPoolApi.tags.vmDiskEncryptionSetName))]",
									"toolTip": "Enables a zero trust configuration on the session host disks.",
									"visible": "[equals(steps('basics').deploymentType, 'SessionHostsOnly')]"
								},
								{
									"name": "diskEncryptionSetsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(not(empty(steps('hosts').scope.resourceGroup)), steps('hosts').diskEncryption.selectDiskEncryptionSet)]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.resourceGroup.id, '/providers/Microsoft.Compute/diskEncryptionSets?api-version=2024-03-02')]",
										"transforms": {
											"list": "value|[*].{label:name, value:id}"
										}
									}
								},
								{
									"name": "existingDiskEncryptionSet",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[steps('basics').hostPoolApi.tags.vmDiskEncryptionSetName]",
									"label": "Disk Encryption Set",
									"constraints": {
										"allowedValues": "[steps('hosts').diskEncryption.diskEncryptionSetsApi.transformed.list]",
										"required": true
									},
									"visible": "[and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), steps('hosts').diskEncryption.selectDiskEncryptionSet)]"
								},
								{
									"name": "keyManagementInfobox1",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
									"options": {
										"text": "In some environments it is required to utilize Customer Managed Keys and protect those keys in a premium key vault with the keys stored in a FIPS 140 validated Hardware Security Module. This is most common in IL5 type environments. Selecting a Customer Managed Key Hardware Security Module (HSM) option will ensure that all VM disks are protected with this configuration. Click this box for more information.",
										"uri": "https://learn.microsoft.com/en-us/azure/azure-government/documentation-government-impact-level-5#storage-isolation",
										"style": "Info"
									}
								},
								{
									"name": "keyManagement",
									"type": "Microsoft.Common.DropDown",
									"label": "Key Management",
									"defaultValue": "Platform-Managed Keys",
									"toolTip": "Platform-managed keys are key encryption keys that are generated, stored, and managed entirely by Azure. Choose Platform Managed for the best balance of security and ease of use. Customer-managed keys are key encryption keys that are generated, stored, and managed by you, the customer, in your Azure Key Vault. Choose Customer Managed if you need to meet specific compliance requirements. Platform-Managed and Customer-Managed Keys provide double encryption with an infrastructure encryption layer using platform-managed keys and a disk encryption layer using customer-managed keys.",
									"constraints": {
										"allowedValues": "[if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), parse('[{\"label\":\"Platform-Managed Keys\",\"value\":\"PlatformManaged\"},{\"label\":\"Customer-Managed Keys protected by HSM\",\"value\":\"CustomerManagedHSM\"}]'), parse('[{\"label\":\"Platform-Managed Keys\",\"value\":\"PlatformManaged\"},{\"label\":\"Customer-Managed Keys\",\"value\":\"CustomerManaged\"},{\"label\":\"Customer-Managed Keys protected by HSM\",\"value\":\"CustomerManagedHSM\"},{\"label\":\"Platform-Managed and Customer-Managed Keys\",\"value\":\"PlatformManagedAndCustomerManaged\"},{\"label\":\"Platform-Managed and Customer-Managed Keys protected by HSM\",\"value\":\"PlatformManagedAndCustomerManagedHSM\"}]'))]"
									},
									"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]"
								},
								{
									"name": "confOSDiskEncryptionWarning",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('hosts').diskEncryption.confidentialVMOSDiskEncryption, equals(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged') )]",
									"options": {
										"style": "Warning",
										"text": "You must have completed the prerequistes to support Confidential VM Disk Encryption.",
										"uri": "https://learn.microsoft.com/en-us/azure/confidential-computing/quick-create-confidential-vm-portal#prerequisites"
									}
								},
								{
									"name": "confDiskEncryptionPrincipalApi",
									"type": "Microsoft.Solutions.GraphApiControl",
									"request": {
										"method": "GET",
										"path": "/v1.0/servicePrincipals?$filter=startsWith(displayName, 'Confidential VM Orchestrator')&$select=displayName,id",
										"transforms": {
											"objectId": "[value[?displayName=='Confidential VM Orchestrator'] | [0].id]"
										}
									}
								},
								{
									"name": "confDiskEncryptionServicePrincipalPickerBlade",
									"type": "Microsoft.Solutions.BladeInvokeControl",
									"openBladeStatus": "[steps('hosts').diskEncryption.confDiskEncryptionServicePrincipalSelector.changing]",
									"bladeReference": {
										"name": "ObjectPickerBlade",
										"extension": "Microsoft_AAD_IAM",
										"parameters": {
											"queries": 4,
											"bladeSubtitle": "Confidential VM Orchestrator Service Principal",
											"additionalQueriesOnSearch": 0,
											"advancedQueryOptions": {},
											"selectionMaximum": 1,
											"selectionMinimum": 1,
											"bladeTitle": "Select the Service Principal",
											"informationHeader": {
												"informationText": "Select the 'Confidential VM Orchestrator' Service Principal."
											},
											"searchBoxLabel": "Enter 'Confidential VM Orchestrator' into the search box",
											"searchBoxPlaceHolderText": "",
											"searchGridNoRowsMessage": "No Service Principals found",
											"selectButtonText": "Select Service Principal",
											"selectedGridLabel": "Selected Service Principal",
											"selectedGridNoRowsMessage": "You must select the 'Confidential VM Orchestrator' Service Principal."
										}
									},
									"transforms": {
										"selection": "selectedObjects|[*].{displayName:displayName,id:id}"
									}
								},
								{
									"name": "confDiskEncryptionServicePrincipalSelector",
									"type": "Microsoft.Common.Selector",
									"label": "Select the <b>Confidential VM Orchestrator</b> Service Principal",
									"keyPath": "displayName",
									"value": "[steps('hosts').diskEncryption.confDiskEncryptionServicePrincipalPickerBlade.transformed.selection]",
									"barColor": "[if(empty(steps('hosts').diskEncryption.confDiskEncryptionServicePrincipalPickerBlade), '#FF0000', '#7fba00')]",
									"constraints": {
										"required": true
									},
									"link": "[if(empty(steps('hosts').diskEncryption.confDiskEncryptionServicePrincipalPickerBlade), 'Select Service Principal', first(map(steps('hosts').diskEncryption.confDiskEncryptionServicePrincipalPickerBlade.transformed.selection, (sp) => sp.displayName)))]",
									"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('hosts').diskEncryption.confidentialVMOSDiskEncryption, equals(steps('hosts').diskEncryption.keyManagement, 'CustomerManagedHSM'), empty(first(steps('hosts').diskEncryption.confDiskEncryptionPrincipalApi.value)))]"
								}
							]
						},
						{
							"name": "dedicatedHosts",
							"type": "Microsoft.Common.Section",
							"label": "Dedicated Hosts",
							"elements": [
								{
									"name": "dedicatedHostsTextBlock1",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "Azure Dedicated Host is a service that provides physical servers able to host one or more virtual machines assigned to one Azure subscription. Dedicated hosts are the same physical servers used in our data centers, provided instead as a directly accessible hardware resource.",
										"link": {
											"label": "Learn more",
											"uri": "https://learn.microsoft.com/en-us/azure/virtual-machines/dedicated-hosts"
										}
									}
								},
								{
									"name": "dedicatedHostsInfobox1",
									"type": "Microsoft.Common.InfoBox",
									"visible": true,
									"options": {
										"text": "In some environments it is required to have a dedicated Azure Host to isolate Compute. This is most common in IL5 type environments. Selecting this option will ensure the VMs are deployed to pre-existing Dedicated Host(s). Click this box for more information.",
										"uri": "https://learn.microsoft.com/en-us/azure/azure-government/documentation-government-impact-level-5#compute-isolation",
										"style": "Info"
									}
								},
								{
									"name": "deployToDedicatedHosts",
									"type": "Microsoft.Common.CheckBox",
									"label": "Deploy to Dedicated Hosts",
									"toolTip": "Select this check box to deploy the Virtual Machines to existing dedicated host(s)."
								},
								{
									"name": "dedicatedHostsTextBlock2",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('hosts').dedicatedHosts.deployToDedicatedHosts]",
									"options": {
										"text": "Select the dedicated host group and optionally the specific dedicated host below. Leave the dedicated host blank if you want to use automatic host selection.",
										"link": {
											"label": "Learn more",
											"uri": "https://learn.microsoft.com/en-us/azure/virtual-machines/dedicated-hosts#manual-vs-automatic-placement"
										}
									}
								},
								{
									"name": "hostGroupsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(not(empty(steps('hosts').scope.subscription.id)), steps('hosts').dedicatedHosts.deployToDedicatedHosts)]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.subscription.id, '/providers/Microsoft.Compute/hostGroups?api-version=2023-09-01')]"
									}
								},
								{
									"name": "dedicatedHostGroup",
									"type": "Microsoft.Common.DropDown",
									"label": "Dedicated Host Group",
									"multiLine": true,
									"toolTip": "Select the dedicated host group to which the Virtual Machines will be deployed using automatic host selection.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(filter(steps('hosts').dedicatedHosts.hostGroupsApi.value, (hg) => equals(hg.location, steps('hosts').scope.location.name)), (hg) => parse(concat('{\"label\":\"', hg.name, '\",\"description\":\"Resource Group: ', first(skip(split(hg.id, '/'), 4)), ', Availability Zone: ', hg.zones, '\",\"value\":\"', hg.id, '\"}')))]"
									},
									"visible": "[steps('hosts').dedicatedHosts.deployToDedicatedHosts]"
								},
								{
									"name": "dedicatedHostsApi",
									"condition": "[not(empty(steps('hosts').dedicatedHosts.dedicatedHostGroup))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').dedicatedHosts.dedicatedHostGroup, '/hosts?api-version=2023-09-01')]"
									}
								},
								{
									"name": "dedicatedHost",
									"type": "Microsoft.Common.DropDown",
									"visible": "[steps('hosts').dedicatedHosts.deployToDedicatedHosts]",
									"filter": true,
									"label": "Dedicated Host (Manual placement only)",
									"multiLine": true,
									"defaultValue": "",
									"toolTip": "This selection is optional. Do not select a host if you wish to use automatic selection.",
									"constraints": {
										"allowedValues": "[map(steps('hosts').dedicatedHosts.dedicatedHostsApi.value, (dh) => parse(concat('{\"label\":\"', dh.name, '\",\"description\":\"Sku: ', dh.sku.name, '\",\"value\":\"', dh.id, '\"}')))]",
										"required": false
									}
								}
							],
							"visible": true
						},
						{
							"name": "specs",
							"type": "Microsoft.Common.Section",
							"label": "Capacity and Performance",
							"elements": [
								{
									"name": "count",
									"type": "Microsoft.Common.Slider",
									"label": "Number of Virtual Machines",
									"defaultValue": 1,
									"toolTip": "Select the number of virtual machines to deploy in your AVD host pool.",
									"min": 1,
									"max": 4999,
									"showStepMarkers": true,
									"constraints": {
										"required": true
									},
									"visible": true
								},
								{
									"name": "diskSku",
									"type": "Microsoft.Common.DropDown",
									"label": "OS Disk SKU",
									"filter": true,
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), 'Premium_LRS', coalesce(steps('basics').hostPoolApi.tags.vmOSDiskType, 'Premium_LRS'))]",
									"toolTip": "Select the disk SKU for the operating system disk.",
									"constraints": {
										"required": true,
										"allowedValues": [
											{
												"label": "Premium_LRS",
												"value": "Premium_LRS"
											},
											{
												"label": "Standard_LRS",
												"value": "Standard_LRS"
											},
											{
												"label": "StandardSSD_LRS",
												"value": "StandardSSD_LRS"
											}
										]
									}
								},
								{
									"name": "diskSizeGB",
									"type": "Microsoft.Common.DropDown",
									"label": "OS Disk Size (GB)",
									"placeholder": "",
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), '128', coalesce(steps('basics').hostPoolApi.tags.vmDiskSizeGB, '128'))]",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "128",
												"value": 128
											},
											{
												"label": "256",
												"value": 256
											},
											{
												"label": "512",
												"value": 512
											},
											{
												"label": "1024",
												"value": 1024
											},
											{
												"label": "2048",
												"value": 2048
											}
										],
										"required": true
									},
									"visible": true
								},
								{
									"name": "sizeGeneric",
									"type": "Microsoft.Compute.SizeSelector",
									"label": "Size",
									"toolTip": "Select the size of the virtual machines. Multi-session hosts should have 4 - 24 vCPUs. Single session host should have 2 or more vCPUs.",
									"recommendedSizes": [
										"[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), 'Standard_D4ads_v6', coalesce(steps('basics').hostPoolApi.tags.vmSize, 'Standard_D4ads_v6'))]",
										"Standard_D8ads_v6",
										"Standard_D16ads_v6",
										"Standard_D32ads_v6",
										"Standard_D4as_v6",
										"Standard_D8as_v6",
										"Standard_D16as_v6",
										"Standard_D32as_v6",
										"Standard_D4ds_v6",
										"Standard_D8ds_v6",
										"Standard_D16ds_v6",
										"Standard_D32ds_v6",
										"Standard_D4s_v6",
										"Standard_D8s_v6",
										"Standard_D16s_v6",
										"Standard_D32s_v6"
									],
									"options": {
										"hideDiskTypeFilter": "[if(equals(steps('hosts').specs.diskSku, 'Premium_LRS'), true, false)]"
									},
									"osPlatform": "Windows",
									"count": "[steps('hosts').specs.count]",
									"scope": {
										"location": "[steps('hosts').scope.location.name]",
										"subscriptionId": "[steps('hosts').scope.subscription.subscriptionId]"
									},
									"visible": "[not(equals(steps('hosts').security.securityType, 'ConfidentialVM'))]"
								},
								{
									"name": "sizeConfidentialVM",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Machine Size",
									"defaultValue": "[if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), 'Standard_DC4ads_v5' ,'Standard_D4ads_v5')]",
									"toolTip": "Select the size of the virtual machines. Multi-session hosts should have 4 - 24 vCPUs. Single session host should have 2 or more vCPUs.",
									"defaultDescription": "",
									"constraints": {
										"allowedValues": "[steps('hosts').resourceSkusApi.transformed.confidentialVMSizes]",
										"required": true
									},
									"visible": "[equals(steps('hosts').security.securityType, 'ConfidentialVM')]"
								},
								{
									"name": "enableAcceleratedNetworking",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable accelerated networking",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.vmAcceleratedNetworking)), true, bool(steps('basics').hostPoolApi.tags.vmAcceleratedNetworking))]",
									"toolTip": "Enables low latency and high throughput on the network interface.",
									"visible": "[and(bool(first(map(filter(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.capabilities)), (sku) => equals(sku.name, 'AcceleratedNetworkingEnabled')), (sku) => sku.value))), or(equals(steps('hosts').image.source, 'marketplace'), bool(steps('hosts').image.imageDefinitionApi.transformed.IsAcceleratedNetworkSupported)))]"
								},
								{
									"name": "hibernationEnabled",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable Hibernation",
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), false, empty(steps('basics').hostPoolApi.tags.vmHibernate)), false, bool(steps('basics').hostPoolApi.tags.vmHibernate))]",
									"toolTip": "Hibernation allows you to pause VMs that aren't being used and save on compute costs where the VMs don't need to run 24/7.",
									"visible": "[and(equals(steps('controlPlane').hostPool.type, 'Personal'), bool(first(map(filter(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.capabilities)), (sku) => equals(sku.name, 'HibernationSupported')), (sku) => sku.value))), or(equals(steps('hosts').image.source, 'marketplace'), bool(steps('hosts').image.imageDefinitionApi.transformed.IsHibernateSupported)))]"
								}
							]
						},
						{
							"name": "availability",
							"type": "Microsoft.Common.Section",
							"label": "Availability",
							"elements": [
								{
									"name": "availability",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), if(empty(first(map(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.locationInfo)), (sku) => sku.zones))), 'No infrastructure redundancy required', 'Availability Zones'), coalesce(steps('basics').hostPoolApi.tags.vmAvailability, 'No infrastructure redundancy required'))]",
									"label": "Availability Options",
									"toolTip": "Select the redundancy / resiliency for the virtual machines.",
									"constraints": {
										"required": true,
										"allowedValues": "[if(empty(first(map(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.locationInfo)), (sku) => sku.zones))), parse('[{\"label\":\"No infrastructure redundancy required\",\"value\":\"None\"},{\"label\":\"Availability Sets\",\"value\":\"AvailabilitySets\"}]'), parse('[{\"label\":\"Availability Zones\",\"value\":\"AvailabilityZones\"},{\"label\":\"Availability Sets\",\"value\":\"AvailabilitySets\"},{\"label\":\"No infrastructure redundancy required\",\"value\":\"None\"}]'))]"
									}
								},
								{
									"name": "availabilityZones",
									"type": "Microsoft.Common.DropDown",
									"label": "Select Availability Zones",
									"defaultValue": [
										"Zone 1",
										"Zone 2",
										"Zone 3"
									],
									"multiselect": true,
									"selectAll": true,
									"toolTip": "Select the desired Availability Zones",
									"constraints": {
										"allowedValues": "[map(first(map(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.locationInfo)), (sku) => sku.zones)), (zone) => parse(concat('{\"label\":\"Zone ', zone, '\",\"value\":\"', zone, '\"}')))]",
										"required": true
									},
									"visible": "[equals(steps('hosts').availability.availability, 'AvailabilityZones')]"
								}
							],
							"visible": "[equals(steps('hosts').dedicatedHosts.deployToDedicatedHosts, false)]"
						},
						{
							"name": "registration",
							"type": "Microsoft.Common.Section",
							"label": "Session Host Registration",
							"elements": [
								{
									"name": "avdAgentsDSCPackage",
									"type": "Microsoft.Common.TextBox",
									"label": "AVD Agent DSC Package",
									"placeholder": "",
									"defaultValue": "Configuration_1.0.03211.1002.zip",
									"toolTip": "Provide the full URL (or just the file name to use the default storage account for the environment) to the DSC Configuration Package containing the AVD Agents and code to register the virtual machines as session hosts in the environment.",
									"constraints": {
										"required": true,
										"validationMessage": "The package name must start with 'Configuration', optionally be followed by an underscore and a version number, and end with '.zip'."
									},
									"visible": true
								},
								{
									"name": "useAgentDownloadEndpoint",
									"type": "Microsoft.Common.CheckBox",
									"label": "Download latest Agent",
									"toolTip": "Automatically downloads the latest agent software during installation rather than waiting for an upgrade."
								}
							],
							"visible": true
						},
						{
							"name": "management",
							"type": "Microsoft.Common.Section",
							"label": "Management",
							"elements": [
								{
									"name": "intune",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Intune Enrollment",
									"defaultValue": "[if(or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), empty(steps('basics').hostPoolApi.tags.intuneEnrollment)), 'No', if(steps('basics').hostPoolApi.tags.intuneEnrollment, 'Yes', 'No'))]",
									"toolTip": "If Intune is configured in your Azure AD tenant, you can choose to have the VM automatically enrolled during the deployment by selecting Yes.",
									"constraints": {
										"required": true,
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										]
									}
								}
							],
							"visible": "[not(contains(steps('identity').solution, 'DomainServices'))]"
						},
						{
							"name": "customScripts",
							"type": "Microsoft.Common.Section",
							"label": "Custom Scripts",
							"elements": [
								{
									"name": "addCustomScripts",
									"type": "Microsoft.Common.DropDown",
									"label": "Add Custom Scripts",
									"placeholder": "",
									"defaultValue": "No",
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Yes",
												"value": true
											},
											{
												"label": "No",
												"value": false
											}
										],
										"required": false
									},
									"visible": true
								},
								{
									"name": "storageHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('hosts').customScripts.addCustomScripts]",
									"options": {
										"text": "<u>Artifacts Storage</u>"
									}
								},
								{
									"name": "textBlockStorageAndManagedIdentity",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('hosts').customScripts.addCustomScripts]",
									"options": {
										"text": "Use the drop downs below to optionally select the storage account and blob container with the build artifacts (scripts and installers) and the User Assigned Managed Identity that has been assigned the 'Storage Blob Data Reader' role the storage account. If you do not host your scripts internally then these items are not required, but you must provide full URIs in the customizations Blob or URI name field."
									}
								},
								{
									"name": "storageAccountSubscription",
									"type": "Microsoft.Common.DropDown",
									"label": "Storage Account Subscription",
									"placeholder": "",
									"defaultValue": "[steps('hosts').scope.subscription.displayName]",
									"toolTip": "",
									"constraints": {
										"allowedValues": "[map(steps('basics').subscriptionsApi.value, (sub) => parse(concat('{\"label\":\"', sub.displayName, '\",\"value\":{\"displayName\":\"', sub.displayName, '\",\"id\":\"', sub.id, '\",\"subscriptionId\":\"', sub.subscriptionId, '\"}}')))]",
										"required": false
									},
									"visible": "[steps('hosts').customScripts.addCustomScripts]"
								},
								{
									"name": "storageAccountsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[not(empty(steps('hosts').customScripts.storageAccountSubscription))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').customScripts.storageAccountSubscription.id, '/providers/Microsoft.Storage/storageAccounts?api-version=2023-01-01')]"
									}
								},
								{
									"name": "storageAccount",
									"type": "Microsoft.Common.DropDown",
									"label": "Image Artifacts Storage Account",
									"multiLine": true,
									"toolTip": "Select the storage account containing the image customization artifacts (i.e., installers, scripts).",
									"constraints": {
										"allowedValues": "[map(steps('hosts').customScripts.storageAccountsApi.value, (sa) => parse(concat('{\"label\":\"', sa.name, '\",\"description\":\"Location: ', sa.location, ' Resource Group: ', first(skip(split(sa.id, '/'), 4)), '\",\"value\":{\"id\":\"', sa.id, '\",\"blobEndpoint\":\"', sa.properties.primaryEndpoints.blob, '\"}}')))]",
										"required": false
									},
									"visible": "[steps('hosts').customScripts.addCustomScripts]"
								},
								{
									"name": "containerApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[not(empty(steps('hosts').customScripts.storageAccount))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').customScripts.storageAccount.id, '/blobServices/default/containers?api-version=2023-01-01')]"
									}
								},
								{
									"name": "container",
									"type": "Microsoft.Common.DropDown",
									"visible": "[steps('hosts').customScripts.addCustomScripts]",
									"label": "Image Artifacts Container",
									"defaultValue": "",
									"toolTip": "Select the container which contains the software and script blobs.",
									"constraints": {
										"required": false,
										"allowedValues": "[map(steps('hosts').customScripts.containerApi.value, (con) => parse(concat('{\"label\":\"', con.name, '\",\"value\":\"', con.name, '\"}')))]"
									}
								},
								{
									"name": "managedIdentity",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Storage Account access User Assigned Identity",
									"toolTip": "Select an existing User Assigned Identity which has been assigned data plane rights of at least 'Storage Blob Data Reader' to the storage account and container selected above.",
									"resourceType": "Microsoft.ManagedIdentity/userAssignedIdentities",
									"constraints": {
										"required": false
									},
									"visible": "[steps('hosts').customScripts.addCustomScripts]"
								},
								{
									"name": "customizationText",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('hosts').customScripts.addCustomScripts]",
									"options": {
										"text": "Enter the name of the customizer and either the full URI or the blob name (if using the storage account and container above). If you are not using the storage account above, then the URI must be accessible from the session hosts VMs. <i>Optionally</i>, enter the any arguments that should be passed to the customization script or installer."
									}
								},
								{
									"name": "customizations",
									"type": "Microsoft.Common.EditableGrid",
									"ariaLabel": "Customizations",
									"label": "Custom Scripts and Software",
									"visible": "[steps('hosts').customScripts.addCustomScripts]",
									"constraints": {
										"width": "Full",
										"rows": {
											"count": {
												"min": 0,
												"max": 10
											}
										},
										"columns": [
											{
												"id": "name",
												"header": "Customization Name",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: VSCode",
													"constraints": {
														"required": true,
														"validations": [
															{
																"regex": "^(?![_-])[A-Za-z0-9_-]{1,13}(?<![_-])$",
																"message": "The value must not contain spaces or end or begin with a dash or underscore."
															}
														]
													}
												}
											},
											{
												"id": "blobNameOrUri",
												"header": "Blob Name or URI",
												"width": "2fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: VSCode.zip",
													"constraints": {
														"required": true
													}
												}
											},
											{
												"id": "arguments",
												"header": "Arguments",
												"width": "1fr",
												"element": {
													"type": "Microsoft.Common.TextBox",
													"placeholder": "Example: /install /silent",
													"constraints": {
														"required": false
													}
												}
											}
										]
									}
								}
							],
							"visible": true
						}
					]
				},
				{
					"name": "userProfiles",
					"label": "User Profiles",
					"elements": [
						{
							"name": "profileSolution",
							"type": "Microsoft.Common.DropDown",
							"defaultValue": "FSLogix",
							"visible": true,
							"label": "Profile Solution",
							"toolTip": "Select the user profile solution for your end users.",
							"constraints": {
								"allowedValues": [
									{
										"label": "FSLogix",
										"value": "FSLogix"
									},
									{
										"label": "Other",
										"value": "Other"
									}
								]
							}
						},
						{
							"name": "configureSessionHosts",
							"type": "Microsoft.Common.CheckBox",
							"label": "Configure FSLogix registry settings on session hosts",
							"defaultValue": true,
							"visible": "[equals(steps('userProfiles').profileSolution, 'FSLogix')]"
						},
						{
							"name": "deployStorage",
							"type": "Microsoft.Common.CheckBox",
							"label": "Deploy FSLogix Storage Resources",
							"defaultValue": true,
							"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), equals(steps('userProfiles').profileSolution, 'FSLogix'))]"
						},
						{
							"name": "fslogixContainerType",
							"type": "Microsoft.Common.DropDown",
							"visible": "[or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true))]",
							"label": "FSLogix Container Type(s)",
							"defaultValue": "Profile Container",
							"toolTip": "Select the container type(s) for the FSLogix profiles.",
							"constraints": {
								"required": true,
								"allowedValues": [
									{
										"label": "Cloud Cache, Profile Container",
										"value": "CloudCacheProfileContainer"
									},
									{
										"label": "Cloud Cache, Profile & Office Container",
										"value": "CloudCacheProfileOfficeContainer"
									},
									{
										"label": "Profile Container",
										"value": "ProfileContainer"
									},
									{
										"label": "Profile & Office Container",
										"value": "ProfileOfficeContainer"
									}
								]
							}
						},
						{
							"name": "sizeInMBs",
							"type": "Microsoft.Common.Slider",
							"label": "FSLogix VHD Size (MB)",
							"defaultValue": 30720,
							"toolTip": "Input the max size of the users fslogix containers.",
							"min": 10240,
							"max": 1048576,
							"showStepMarkers": true,
							"constraints": {
								"required": true
							},
							"visible": "[and(equals(steps('userProfiles').profileSolution, 'FSLogix'), steps('userProfiles').configureSessionHosts)]"
						},
						{
							"name": "ouPath",
							"type": "Microsoft.Common.TextBox",
							"defaultValue": "[steps('identity').virtualMachines.ouPath]",
							"visible": "[and(equals(steps('identity').solution, 'ActiveDirectoryDomainServices'), equals(steps('userProfiles').deployStorage, true))]",
							"label": "Storage OU Path",
							"toolTip": "Input the distinguished name of the desired organization unit for storage computer objects.",
							"placeholder": "Example: OU=pooled,OU=avd,DC=contoso,DC=com",
							"constraints": {
								"regex": "^(?:\\s*[Oo][Uu]\\s*=\\s*[^,]+\\s*,\\s*)+[Dd][Cc]\\s*=\\s*[A-Za-z0-9-]+\\s*(?:,\\s*[Dd][Cc]\\s*=\\s*[A-Za-z0-9-]+\\s*)+$",
								"required": true,
								"validationMessage": "Provide a valid OU distinguished name."
							}
						},
						{
							"name": "storageService",
							"type": "Microsoft.Common.DropDown",
							"visible": "[or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true))]",
							"label": "Storage Service",
							"defaultValue": "Azure Files",
							"toolTip": "Select the storage service that provides the SMB file share to support the use of FSLogix.",
							"constraints": {
								"allowedValues": "[if(not(equals(steps('identity').solution, 'ActiveDirectoryDomainServices')), parse('[{\"label\":\"Azure Files\",\"value\":\"AzureFiles\"}]'), parse('[{\"label\":\"Azure Files\",\"value\":\"AzureFiles\"},{\"label\":\"Azure NetApp Files\",\"value\":\"AzureNetAppFiles\"}]'))]"
							}
						},
						{
							"name": "azureNetAppFiles",
							"type": "Microsoft.Common.Section",
							"label": "Azure NetApp Files",
							"visible": "[equals(steps('userProfiles').storageService, 'AzureNetAppFiles')]",
							"elements": [
								{
									"name": "subscription",
									"type": "Microsoft.Common.DropDown",
									"label": "NetApp Files Subscription",
									"placeholder": "",
									"defaultValue": "[steps('hosts').scope.subscription.displayName]",
									"toolTip": "",
									"constraints": {
										"allowedValues": "[map(steps('basics').subscriptionsApi.value, (sub) => parse(concat('{\"label\":\"', sub.displayName, '\",\"value\":{\"displayName\":\"', sub.displayName, '\",\"id\":\"', sub.id, '\",\"subscriptionId\":\"', sub.subscriptionId, '\"}}')))]",
										"required": false
									}
								},
								{
									"name": "storageSku",
									"type": "Microsoft.Common.DropDown",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"label": "NetApp Files SKU",
									"toolTip": "Select the Azure NetApp Sku.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Premium",
												"value": "Premium"
											},
											{
												"label": "Standard",
												"value": "Standard"
											}
										]
									}
								},
								{
									"name": "virtualNetworksApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(equals(steps('userProfiles').storageService, 'AzureNetAppFiles'), steps('userProfiles').deployStorage, not(empty(steps('userProfiles').azureNetAppFiles.subscription)))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('userProfiles').azureNetAppFiles.subscription.id, '/providers/Microsoft.Network/virtualNetworks?api-version=2022-11-01')]"
									}
								},
								{
									"name": "virtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"label": "NetApp Virtual Network",
									"defaultValue": "[steps('hosts').network.virtualNetwork.name]",
									"multiLine": true,
									"toolTip": "Select the virtual network containing the subnets to which the Azure NetApp Files instance will be attached.",
									"constraints": {
										"allowedValues": "[map(filter(steps('userProfiles').azureNetAppFiles.virtualNetworksApi.value, (vnet) => equals(vnet.location, steps('hosts').scope.location.name)), (vnet) => parse(concat('{\"label\":\"', vnet.name, '\",\"description\":\"Location: ', vnet.location, ' Resource Group: ', first(skip(split(vnet.id, '/'), 4)), '\",\"value\":{\"name\":\"', vnet.name, '\",\"id\":\"', vnet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[equals(steps('userProfiles').deployStorage, true)]"
								},
								{
									"name": "subnetsApi",
									"condition": "[not(empty(steps('userProfiles').azureNetAppFiles.virtualNetwork))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('userProfiles').azureNetAppFiles.virtualNetwork.id, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "noSnetsWithDelegationErrorBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(not(empty(steps('userProfiles').azureNetAppFiles.virtualNetwork)), empty(map(filter(steps('userProfiles').azureNetAppFiles.subnetsApi.value, (snet) => equals(first(map(snet.properties.delegations, (del) => del.properties.serviceName)), 'Microsoft.NetApp/volumes')), (snet) => snet.name)))]",
									"options": {
										"style": "Error",
										"text": "There are no subnets in the virtual network chosen above that are delegated to the 'Microsoft.Netapp/volumes' service. You must either select another network (or region on the basics page) or create a subnet in the chosen virtual network and delegate it to 'Microsoft.Netapp/volumes', and then restart this deployment."
									}
								},
								{
									"name": "subnet",
									"type": "Microsoft.Common.DropDown",
									"label": "NetApp Subnet",
									"toolTip": "Select the subnet within the Virtual Network that is delegated to 'Microsoft.NetApp/volumes'.",
									"constraints": {
										"allowedValues": "[map(filter(steps('userProfiles').azureNetAppFiles.subnetsApi.value, (snet) => equals(first(map(snet.properties.delegations, (del) => del.properties.serviceName)), 'Microsoft.NetApp/volumes')), (snet) => parse(concat('{\"label\":\"', snet.name, '\",\"value\":{\"name\":\"', snet.name, '\",\"id\":\"', snet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[equals(steps('userProfiles').deployStorage, true)]"
								},
								{
									"name": "existingSharedActiveDirectoryConnection",
									"type": "Microsoft.Common.CheckBox",
									"label": "Existing shared Active Directory connection",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"toolTip": "Choose whether a Shared AD Connection for Azure NetApp File exists.",
									"constraints": {
										"required": false
									}
								},
								{
									"name": "storageShareSize",
									"type": "Microsoft.Common.Slider",
									"label": "Storage Share Size (GB)",
									"defaultValue": 100,
									"toolTip": "Input the quota size for the SMB file share to support the use of FSLogix.",
									"min": 100,
									"max": 100000,
									"showStepMarkers": false,
									"constraints": {
										"required": true
									},
									"visible": "[equals(steps('userProfiles').deployStorage, true)]"
								},
								{
									"name": "leastPrivHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"options": {
										"text": "<b>NTFS Permissions</b>"
									}
								},
								{
									"name": "leastPrivIntroBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"options": {
										"text": "You can choose to follow the principle of least privilege by assigning NTFS permissions to specific Active Directory groups instead of using the default \"Users\" group. If you select the checkbox below, youll need to pick the groups that should have access.",
										"link": {
											"label": "Learn more",
											"uri": "https://learn.microsoft.com/en-us/fslogix/how-to-configure-storage-permissions"
										}
									}
								},
								{
									"name": "leastPrivNTFS",
									"type": "Microsoft.Common.CheckBox",
									"label": "Configure Least Privilege NTFS permissions",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]"
								},
								{
									"name": "userGroupSelector",
									"type": "Microsoft.Common.Selector",
									"label": "Select User Groups",
									"keyPath": "displayName",
									"descriptionKeyPath": "id",
									"value": "[steps('userProfiles').azureNetAppFiles.userGroupPickerBlade.transformed.groups]",
									"visible": "[and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').azureNetAppFiles.leastPrivNTFS, true))]",
									"barColor": "[if(empty(steps('userProfiles').azureNetAppFiles.userGroupPickerBlade), '#FF0000', '#7fba00')]",
									"constraints": {
										"required": true
									},
									"link": "[if(empty(steps('userProfiles').azureNetAppFiles.userGroupPickerBlade), 'Select groups', 'Update Selected groups')]"
								},
								{
									"name": "userGroupPickerBlade",
									"type": "Microsoft.Solutions.BladeInvokeControl",
									"openBladeStatus": "[steps('userProfiles').azureNetAppFiles.userGroupSelector.changing]",
									"bladeReference": {
										"name": "ObjectPickerBlade",
										"extension": "Microsoft_AAD_IAM",
										"parameters": {
											"queries": 4194304,
											"disablers": 4,
											"bladeSubtitle": "Pick the groups to assign",
											"additionalQueriesOnSearch": 0,
											"advancedQueryOptions": {
												"suggestedObjectsOptions": {}
											},
											"selectionMaximum": 20,
											"selectionMinimum": 1,
											"bladeTitle": "Select Groups",
											"informationHeader": {
												"informationText": "Select the Active Directory groups to assign to the NTFS permissions.",
												"informationLink": ""
											},
											"inviteEnabled": true,
											"searchBoxLabel": "Search for a group",
											"searchBoxPlaceHolderText": "Enter a string in the group name",
											"searchBoxTooltip": "This is the tooltip",
											"searchGridNoRowsMessage": "No groups found",
											"selectButtonText": "Select Groups",
											"selectedGridLabel": "Selected User Groups",
											"selectedGridNoRowsMessage": "You must select at least one group"
										}
									},
									"transforms": {
										"groups": "selectedObjects|[*].{id:id, name:displayName}"
									}
								},
								{
									"name": "configureSessionHostsHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('hosts').configureSessionHosts]",
									"options": {
										"text": "<b>Session Host Configuration</b>"
									}
								},
								{
									"name": "localVolumesHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)))]",
									"options": {
										"text": "<u>Local NetApp Volume</u>"
									}
								},
								{
									"name": "localNetAppVolumesTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)))]",
									"options": {
										"text": "Use the drop down boxes below to select the local NetApp account, capacity pool, and volume that is used for the fslogix profile (and office) containers."
									}
								},
								{
									"name": "netAppAccountsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(not(empty(steps('userProfiles').azureNetAppFiles.subscription)), equals(steps('userProfiles').storageService, 'AzureNetAppFiles'), steps('userProfiles').configureSessionHosts)]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('userProfiles').azureNetAppFiles.subscription.id, '/providers/Microsoft.NetApp/netAppAccounts?api-version=2023-11-01')]"
									}
								},
								{
									"name": "existingLocalNetAppAccount",
									"type": "Microsoft.Common.DropDown",
									"label": "Existing Local NetApp Account",
									"toolTip": "Select the existing local NetApp account to use for the FSLogix profile storage.",
									"constraints": {
										"allowedValues": "[map(filter(steps('userProfiles').azureNetAppFiles.netAppAccountsApi.value, (account) => equals(account.location, steps('hosts').scope.location.name)), (account) => parse(concat('{\"label\":\"', account.name, '\",\"description\":\"Resource Group: ', first(skip(split(account.id, '/'), 4)), '\", \"value\":\"', account.id, '\"}')))]",
										"required": true
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)))]"
								},
								{
									"name": "localCapacityPoolsApi",
									"condition": "[not(empty(steps('userProfiles').azureNetAppFiles.existingLocalNetAppAccount))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('userProfiles').azureNetAppFiles.existingLocalNetAppAccount, '/capacityPools?api-version=2023-11-01')]"
									}
								},
								{
									"name": "localCapacityPool",
									"type": "Microsoft.Common.DropDown",
									"label": "Local Capacity Pool",
									"multiLine": false,
									"toolTip": "Select an existing capacity pool from the selected NetApp Account.",
									"constraints": {
										"allowedValues": "[map(steps('userProfiles').azureNetAppFiles.localCapacityPoolsApi.value, (pool) => parse(concat('{\"label\":\"', last(split(pool.name, '/')), '\",\"value\":\"', pool.id, '\"}')))]",
										"required": true
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)))]"
								},
								{
									"name": "localVolumesApi",
									"condition": "[not(empty(steps('userProfiles').azureNetAppFiles.localCapacityPool))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('userProfiles').azureNetAppFiles.localCapacityPool, '/volumes?api-version=2023-11-01')]"
									}
								},
								{
									"name": "localVolumes",
									"type": "Microsoft.Common.DropDown",
									"label": "Local Volume(s)",
									"multiselect": "[contains(steps('userProfiles').fslogixContainerType, 'OfficeContainer')]",
									"toolTip": "Select the existing volume from the selected NetApp capacity pool.",
									"constraints": {
										"allowedValues": "[map(steps('userProfiles').azureNetAppFiles.localVolumesApi.value, (vol) => parse(concat('{\"label\":\"', last(split(vol.name, '/')), '\",\"value\":\"', vol.id, '\"}')))]",
										"required": true
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)))]"
								},
								{
									"name": "remoteVolumeHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]",
									"options": {
										"text": "<u>Remote Volume</u>"
									}
								},
								{
									"name": "remoteVolumesTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]",
									"options": {
										"text": "<u>Optionally</u>, use the drop down boxes below to select a remote NetApp account, capacity pool, and volume(s) to use with Cloud Cache profile containers and office containers."
									}
								},
								{
									"name": "remoteNetAppAccount",
									"type": "Microsoft.Common.DropDown",
									"label": "Remote NetApp Account",
									"toolTip": "Select the existing local NetApp account to use for the FSLogix profile storage.",
									"multiLine": true,
									"constraints": {
										"allowedValues": "[map(filter(steps('userProfiles').azureNetAppFiles.netAppAccountsApi.value, (account) => not(equals(account.location, steps('hosts').scope.location.name))), (account) => parse(concat('{\"label\":\"', account.name, '\",\"description\":\"Location: ', account.location, ', Resource Group: ', first(skip(split(account.id, '/'), 4)), '\", \"value\":\"', account.id, '\"}')))]",
										"required": false
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]"
								},
								{
									"name": "remoteCapacityPoolsApi",
									"condition": "[not(empty(steps('userProfiles').azureNetAppFiles.remoteNetAppAccount))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('userProfiles').azureNetAppFiles.remoteNetAppAccount, '/capacityPools?api-version=2023-11-01')]"
									}
								},
								{
									"name": "remoteCapacityPool",
									"type": "Microsoft.Common.DropDown",
									"label": "Remote Capacity Pool",
									"toolTip": "Select an existing capacity pool from the selected NetApp Account.",
									"constraints": {
										"allowedValues": "[map(steps('userProfiles').azureNetAppFiles.remoteCapacityPoolsApi.value, (pool) => parse(concat('{\"label\":\"', last(split(pool.name, '/')), '\",\"value\":\"', pool.id, '\"}')))]",
										"required": false
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]"
								},
								{
									"name": "remoteVolumesApi",
									"condition": "[not(empty(steps('userProfiles').azureNetAppFiles.remoteCapacityPool))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('userProfiles').azureNetAppFiles.remoteCapacityPool, '/volumes?api-version=2023-11-01')]"
									}
								},
								{
									"name": "remoteVolumes",
									"type": "Microsoft.Common.DropDown",
									"label": "Remote Volume(s)",
									"multiselect": "[contains(steps('userProfiles').fslogixContainerType, 'OfficeContainer')]",
									"toolTip": "Select the office-containers and profile-containers volumes from the selected NetApp capacity pool.",
									"constraints": {
										"allowedValues": "[map(steps('userProfiles').azureNetAppFiles.remoteVolumesApi.value, (vol) => parse(concat('{\"label\":\"', last(split(vol.name, '/')), '\",\"value\":\"', vol.id, '\"}')))]",
										"required": false
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]"
								}
							]
						},
						{
							"name": "azureFiles",
							"type": "Microsoft.Common.Section",
							"label": "Azure Files",
							"visible": "[equals(steps('userProfiles').storageService, 'AzureFiles')]",
							"elements": [
								{
									"name": "storageSku",
									"type": "Microsoft.Common.DropDown",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"label": "Azure Files SKU",
									"toolTip": "Select the Azure Files Sku.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Premium",
												"value": "Premium"
											},
											{
												"label": "Standard",
												"value": "Standard"
											}
										]
									}
								},
								{
									"name": "storageIndex",
									"type": "Microsoft.Common.Slider",
									"label": "Storage Index",
									"defaultValue": 1,
									"toolTip": "Input the starting number of the storage accounts to deploy with SMB file shares to support the use of FSLogix.",
									"min": 1,
									"max": "[sub(99, steps('userProfiles').azureFiles.storageCount)]",
									"showStepMarkers": false,
									"constraints": {
										"required": true
									},
									"visible": "[equals(steps('userProfiles').deployStorage, true)]"
								},
								{
									"name": "storageShareSize",
									"type": "Microsoft.Common.Slider",
									"label": "Storage Share Size (GB)",
									"defaultValue": 100,
									"toolTip": "Input the quota size for the SMB file share to support the use of FSLogix.",
									"min": 100,
									"max": 100000,
									"showStepMarkers": false,
									"constraints": {
										"required": true
									},
									"visible": "[equals(steps('userProfiles').deployStorage, true)]"
								},
								{
									"name": "leastPrivShardHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true)), not(equals(steps('identity').solution, 'EntraId')))]",
									"options": {
										"text": "[if(equals(steps('userProfiles').deployStorage, true), '<u>Least Privilege, Sharding, and User Group(s) to Share Assignment(s)</u>', '<u>User Group(s) to Share Assignment(s)</u>')]"
									}
								},
								{
									"name": "leastPrivIntroBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(equals(steps('userProfiles').deployStorage, true), not(equals(steps('identity').solution, 'EntraId')))]",
									"options": {
										"text": "[if(or(equals(steps('identity').solution, 'ActiveDirectoryDomainServices'), equals(steps('identity').solution, 'EntraKerberos-Hybrid')), 'You can choose to follow the principle of least privilege by assigning NTFS permissions to specific Active Directory groups instead of using the default \"Users\" group. If you select the checkbox below, youll need to pick the groups that should have access.', 'You can choose to follow the principle of least privilege by assigning NTFS permissions to specific user groups instead of using the default \"Users\" group. If you select the checkbox below, youll need to pick the groups that should have access.')]",
										"link": {
											"label": "Learn more",
											"uri": "https://learn.microsoft.com/en-us/fslogix/how-to-configure-storage-permissions"
										}
									}
								},
								{
									"name": "leastPrivNTFS",
									"type": "Microsoft.Common.CheckBox",
									"label": "Configure Least Privilege NTFS permissions",
									"visible": "[and(equals(steps('userProfiles').deployStorage, true), not(equals(steps('identity').solution, 'EntraId')))]"
								},
								{
									"name": "shardingTextBlock1",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true)), not(equals(steps('identity').solution, 'EntraId')))]",
									"options": {
										"text": "In order to improve scalability of user profile data, you have the option to deploy more than one storage account per host pool. This architectural pattern is called 'Sharding'.",
										"link": {
											"label": "Sharding pattern - Azure Architecture Center | Microsoft Learn",
											"uri": "https://learn.microsoft.com/en-us/azure/architecture/patterns/sharding"
										}
									}
								},
								{
									"name": "shardingInfoBox1",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true)), contains(steps('identity').solution, 'DomainServices'))]",
									"options": {
										"style": "Info",
										"text": "If you choose to Shard the user profile storage, you must provide a group to assign to each storage account. In order to minimize login times, to provide more than four (4) storage accounts, you must select the 'Sharding via Object Specific Settings' option below and, for ease of configuration, select 'Configure FSLogix registry settings on session hosts' above. You can find instructions on how to configure the regisry at the link provided.",
										"uri": "https://learn.microsoft.com/en-us/fslogix/how-to-configure-object-specific-settings"
									}
								},
								{
									"name": "shardingOption",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Sharding Options",
									"defaultValue": "No Sharding",
									"constraints": {
										"allowedValues": "[if(contains(steps('identity').solution, 'EntraKerberos'), parse('[{\"label\":\"No Sharding\",\"value\":\"None\"},{\"label\":\"Sharding via Permissions (Max 4 Storage Accounts)\",\"value\":\"ShardPerms\"}]'), parse('[{\"label\":\"No Sharding\",\"value\":\"None\"},{\"label\":\"Sharding via Permissions (Max 4 Storage Accounts)\",\"value\":\"ShardPerms\"},{\"label\":\"Sharding via Object Specific Settings\",\"value\":\"ShardOSS\"}]'))]"
									},
									"visible": "[and(or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true)), not(equals(steps('identity').solution, 'EntraId')))]"
								},
								{
									"name": "userGroupSelector",
									"type": "Microsoft.Common.Selector",
									"label": "Select User Groups",
									"keyPath": "displayName",
									"descriptionKeyPath": "id",
									"value": "[steps('userProfiles').azureFiles.userGroupPickerBlade.transformed.groups]",
									"visible": "[and(or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true)), not(equals(steps('identity').solution, 'EntraId')), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), not(equals(steps('userProfiles').azureFiles.shardingOption, 'None'))))]",
									"barColor": "[if(empty(steps('userProfiles').azureFiles.userGroupPickerBlade), '#FF0000', '#7fba00')]",
									"constraints": {
										"required": true
									},
									"link": "[if(empty(steps('userProfiles').azureFiles.userGroupPickerBlade), 'Select groups', 'Update Selected groups')]"
								},
								{
									"name": "userGroupPickerBlade",
									"type": "Microsoft.Solutions.BladeInvokeControl",
									"openBladeStatus": "[steps('userProfiles').azureFiles.userGroupSelector.changing]",
									"bladeReference": {
										"name": "ObjectPickerBlade",
										"extension": "Microsoft_AAD_IAM",
										"parameters": {
											"queries": "[if(or(equals(steps('identity').solution, 'ActiveDirectoryDomainServices'), equals(steps('identity').solution, 'EntraKerberos-Hybrid')), 4194304, 32)]",
											"disablers": 4,
											"bladeSubtitle": "Pick the groups to assign",
											"additionalQueriesOnSearch": 0,
											"advancedQueryOptions": {
												"suggestedObjectsOptions": {}
											},
											"selectionMaximum": 20,
											"selectionMinimum": 1,
											"bladeTitle": "Select Groups",
											"informationHeader": {
												"informationText": "Select the groups to assign to the desktop application group. The group types are automatically filtered based on your identity type.",
												"informationLink": ""
											},
											"inviteEnabled": true,
											"searchBoxLabel": "Search for a group",
											"searchBoxPlaceHolderText": "Enter a string in the group name",
											"searchBoxTooltip": "This is the tooltip",
											"searchGridNoRowsMessage": "No groups found",
											"selectButtonText": "Select Groups",
											"selectedGridLabel": "Selected User Groups",
											"selectedGridNoRowsMessage": "You must select at least one group"
										}
									},
									"transforms": {
										"groups": "selectedObjects|[*].{id:id, name:displayName}"
									}
								},
								{
									"name": "shardingTooManyGroupsErrorBox",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(equals(steps('userProfiles').azureFiles.shardingOption, 'ShardPerms'), greater(length(steps('userProfiles').azureFiles.userGroupPickerBlade.transformed.groups), 4))]",
									"options": {
										"style": "Error",
										"text": "You selected (or provided) over 4 groups. You can select/provide a maximum of 4 groups when choosing 'Sharding with Permissions' in order to minimize login time and maintain compatibility with Cloud Cache (if used). Either reduce the number of groups, or select 'Sharding with Object Specific Settings' and follow the instructions provided in the link to configure the registry on the session hosts.",
										"uri": "https://learn.microsoft.com/en-us/fslogix/how-to-configure-object-specific-settings"
									}
								},
								{
									"name": "storageAccountDeployedNumberTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(equals(steps('userProfiles').deployStorage, true), and(not(equals(steps('identity').solution, 'EntraId')), not(equals(steps('userProfiles').azureFiles.shardingOption, 'None'))))]",
									"options": {
										"text": "The number of groups selected or provided above determines the number of storage accounts deployed by this solution. The storage account names are automatically determined by combining a suffix with a 0-padded two digit suffix starting at the 'Storage Index' value."
									}
								},
								{
									"name": "storageAccountsRequiredTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(not(equals(steps('userProfiles').deployStorage, true)), steps('userProfiles').configureSessionHosts, and(not(equals(steps('identity').solution, 'EntraId')), not(equals(steps('userProfiles').azureFiles.shardingOption, 'None'))))]",
									"options": {
										"text": "The number of groups selected or provided above determines the number of storage accounts that are required when selecting existing accounts."
									}
								},
								{
									"name": "entraIdTexBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true)), equals(steps('identity').solution, 'EntraId'))]",
									"options": {
										"text": "A total of 1 storage account will be deployed/required because you chose the 'Entra Id' identity provider on the 'Session Host' screen. Currently, Entra Id does not support sharding storage with multiple storage accounts."
									}
								},
								{
									"name": "noShardingTexBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true)), equals(steps('userProfiles').azureFiles.shardingOption, 'None'))]",
									"options": {
										"text": "A total of 1 storage account will be deployed/required because you have chosen not to Shard your storage."
									}
								},
								{
									"name": "storageCount",
									"type": "Microsoft.Common.Slider",
									"label": "Storage Accounts Required (Read Only)",
									"defaultValue": 1,
									"min": "[if(or(equals(steps('identity').solution, 'EntraId'), equals(steps('userProfiles').azureFiles.shardingOption, 'None')), 1, length(steps('userProfiles').azureFiles.userGroupPickerBlade.transformed.groups))]",
									"max": "[if(or(equals(steps('identity').solution, 'EntraId'), equals(steps('userProfiles').azureFiles.shardingOption, 'None')), 1, length(steps('userProfiles').azureFiles.userGroupPickerBlade.transformed.groups))]",
									"showStepMarkers": false,
									"visible": "[or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true))]"
								},
								{
									"name": "entraKerbCloudWarning",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(equals(steps('identity').solution, 'EntraKerberos-CloudOnly'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'ShardPerms')))]",
									"options": {
										"text": "<b>Enabling authentication to FSLogix storage accounts using Entra Kerberos for Cloud-Only Identities is only supported in Azure Commercial.</b><br><br>When you enable Entra Kerberos authentication on a storage account, an Entra application is automatically created. This solution will update that application by adding a tag to support Kerberos tickets for Entra groups and granting admin consent for the required permissions.<br><br>You must specify a user-assigned managed identity that has been granted 'Application.ReadWrite.All' permissions to Microsoft Graph. This identity will be used to apply the necessary updates to the Entra application.",
										"style": "Warning",
										"uri": "https://learn.microsoft.com/en-us/entra/identity/authentication/kerberos#group-sid-limit-in-entra-kerberos-preview"
									}
								},
								{
									"name": "entraKerbHybridWarning",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'ShardPerms')))]",
									"options": {
										"text": "To grant specific Entra groups NTFS permissions on the share, this solution will:<ol><li>Deploy a deployment helper virtual machine to the subnet specified on the <b>session host</b> page of this wizard.</li><li>Join the session host VM to the user domain.</li><li>Enable Entra Kerberos authentication on the storage account and update the associated Entra application.</li></ol>In order to accomplish this, the following requirements must be met:<ul><li><b>Network Connectivity:</b> The session host subnet must have line-of-sight to a domain controller for the specified domain.</li><li><b>Domain Join Permissions:</b> The domain join credentials must have sufficient permissions to join the domain in the Organization Unit path specified below.</li><li><b>Graph Permissions:</b> The User-Assigned Managed identity that you select below must have been granted Microsoft Graph 'Application.ReadUpdate.All' permissions.</li></ul>",
										"style": "Warning",
										"uri": "https://learn.microsoft.com/en-us/azure/storage/files/storage-files-identity-configure-file-level-permissions"
									}
								},
								{
									"name": "domainName",
									"type": "Microsoft.Common.TextBox",
									"visible": "[and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'ShardPerms')))]",
									"label": "User Active Directory Domain Name",
									"toolTip": "Provide domain name from where users are synchronized. This is required to use file explorer to configure permissions.",
									"placeholder": "Example: contoso.com",
									"constraints": {
										"regex": "^([a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,}$",
										"required": false,
										"validationMessage": "Provide a valid fully qualified domain name."
									}
								},
								{
									"name": "vmOUPath",
									"type": "Microsoft.Common.TextBox",
									"visible": "[and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'shardPerms')))]",
									"label": "Deployment VM OU Path",
									"toolTip": "Input the distinguished name of the desired organization unit for computer objects.",
									"placeholder": "Example: OU=pooled,OU=avd,DC=contoso,DC=com",
									"constraints": {
										"regex": "^(?:\\s*[Oo][Uu]\\s*=\\s*[^,]+\\s*,\\s*)+[Dd][Cc]\\s*=\\s*[A-Za-z0-9-]+\\s*(?:,\\s*[Dd][Cc]\\s*=\\s*[A-Za-z0-9-]+\\s*)+$",
										"required": true,
										"validationMessage": "Provide a valid OU distinguished name."
									}
								},								
								{
									"name": "credentialSource",
									"type": "Microsoft.Common.OptionsGroup",
									"label": "Domain Join Credential Source",
									"defaultValue": "Key Vault",
									"toolTip": "Select 'Manual Entry' to specify the secrets manually or 'Key Vault' to reference secrets from the Key Vault chosen on the <b>Identity</b> pane.<br>This key vault must also contain the following two secrets and values:<br><ul><li><b>DomainJoinUserPrincipalName</b>: The domain join account UserPrincipalName (i.e., domjoin@contoso.local).</li><li><b>DomainJoinUserPassword</b>: The password associated with the domain join user account.</li></ul>",
									"constraints": {
										"allowedValues": [
											{
												"label": "Key Vault",
												"value": "keyVault"
											},
											{
												"label": "Manual Entry",
												"value": "manual"
											}
										],
										"required": true
									},
									"visible": "[and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), equals(steps('identity').credentials.source, 'keyVault'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'shardPerms')))]"
								},
								{
									"name": "domainJoinUserPrincipalName",
									"type": "Microsoft.Common.TextBox",
									"label": "Domain Join Account UserPrincipalName",
									"toolTip": "Enter the user principal name with permissions to join computers to the domain in the selected OU.",
									"placeholder": "domainjoin@contoso.com",
									"constraints": {
										"required": true,
										"regex": "^[a-z0-9A-Z_.-]+@(?:[a-z0-9]+\\.)+[a-z]+$",
										"validationMessage": "The value must be a valid user principal name."
									},
									"visible": "[and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'shardPerms')), not(equals(steps('userProfiles').azureFiles.credentialSource, 'keyVault')))]"
								},
								{
									"name": "domainJoinUserPassword",
									"type": "Microsoft.Common.PasswordBox",
									"label": {
										"password": "Domain Join Account Password",
										"confirmPassword": "Confirm Password"
									},
									"toolTip": "Enter a password that is alphanumeric, contains at least 12 characters, 1 letter, 1 number and 1 special character.",
									"constraints": {
										"required": true
									},
									"options": {
										"hideConfirmation": false
									},
									"visible": "[and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'shardPerms')), not(equals(steps('userProfiles').azureFiles.credentialSource, 'keyVault')))]"
								},								
								{
									"name": "managedIdentity",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "User Assigned Identity",
									"toolTip": "Select an existing User Assigned Identity which has been granted 'Application.ReadUpdate.All' permissions in Microsoft Graph.",
									"resourceType": "Microsoft.ManagedIdentity/userAssignedIdentities",
									"constraints": {
										"required": true
									},
									"visible": "[and(contains(steps('identity').solution, 'EntraKerberos'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'ShardPerms')))]"
								},								
								{
									"name": "keyManagementHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"options": {
										"text": "<u>Encryption Key Management</u>"
									}
								},
								{
									"name": "keyManagementTextBox1",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"options": {
										"link": {
											"label": "Microsoft Learn | Azure Storage - Customer Managed Keys",
											"uri": "https://learn.microsoft.com/en-us/azure/storage/common/customer-managed-keys-overview"
										},
										"text": "Azure Storage uses service-side encryption (SSE) to automatically encrypt your data when it is persisted to the cloud. Data in storage accounts is encrypted with Microsoft-managed keys by default. You can continue to rely on Microsoft-managed keys for the encryption of your data, or you can manage encryption with your own keys. You can specify a customer-managed key to use for encrypting and decrypting data in Blob Storage and in Azure Files. Customer-managed keys must be stored in Azure Key Vault or Azure Key Vault Managed Hardware Security Model (HSM)."
									}
								},
								{
									"name": "keyManagementInfobox1",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"options": {
										"text": "In some environments it is required to utilize Customer Managed Keys and protect those keys in a premium key vault with the keys stored in a FIPS 140 validated Hardware Security Module. This is most common in IL5 type environments. Selecting a Customer Managed Key Hardware Security Module (HSM) option will ensure that all storage accounts protected with this configuration. Click this box for more information.",
										"uri": "https://learn.microsoft.com/en-us/azure/azure-government/documentation-government-impact-level-5#storage-isolation",
										"style": "Info"
									}
								},
								{
									"name": "keyManagement",
									"type": "Microsoft.Common.DropDown",
									"visible": "[equals(steps('userProfiles').deployStorage, true)]",
									"label": "Storage Encryption Key Management",
									"defaultValue": "[if(contains(steps('hosts').diskEncryption.keyManagement, 'Customer'), if(contains(steps('hosts').diskEncryption.keyManagement, 'HSM'), 'Customer-Managed Keys protected by HSM', 'Customer-Managed Keys'), 'Microsoft-Managed Keys')]",
									"toolTip": "Select the type of Key Management to use for the FSLogix storage account(s) encryption keys.",
									"constraints": {
										"required": true,
										"allowedValues": [
											{
												"label": "Microsoft-Managed Keys",
												"value": "MicrosoftManaged"
											},
											{
												"label": "Customer-Managed Keys",
												"value": "CustomerManaged"
											},
											{
												"label": "Customer-Managed Keys protected by HSM",
												"value": "CustomerManagedHSM"
											}
										]
									}
								},
								{
									"name": "configureSessionHostsHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, or(not(equals(steps('userProfiles').deployStorage, true)), contains(steps('userProfiles').fslogixContainerType, 'CloudCache')))]",
									"options": {
										"text": "<b>Session Host Configuration</b>"
									}
								},
								{
									"name": "storageAccountsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(not(empty(steps('hosts').scope.subscription.id)), steps('userProfiles').configureSessionHosts)]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.subscription.id, '/providers/Microsoft.Storage/storageAccounts?api-version=2023-01-01')]",
										"transforms": {
											"list": "sort_by(value, &name)|[*].{name:name, id:id, location:location}"
										}
									}
								},
								{
									"name": "localAccountsHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)))]",
									"options": {
										"text": "<u>Local Storage Accounts</u>"
									}
								},
								{
									"name": "notDeployedOnlyOneSATextBox",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)), or(equals(steps('userProfiles').azureFiles.shardingOption, 'None'), equals(steps('identity').solution, 'EntraId')))]",
									"options": {
										"text": "Select a single storage account from the same region as the session hosts. The session hosts will be configured to store user profiles on this storage account."
									}
								},
								{
									"name": "notDeployedMorethanOneSATextBox",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)), not(equals(steps('identity').solution, 'EntraId')), not(equals(steps('userProfiles').azureFiles.shardingOption, 'None')))]",
									"options": {
										"text": "Select the same number of storage accounts as the groups selected/provided above from the same region as the session hosts. The session hosts will be configured to store user profiles on these storage accounts."
									}
								},
								{
									"name": "existingLocalStorageAccounts",
									"type": "Microsoft.Common.DropDown",
									"label": "Existing Local Storage Accounts",
									"multiLine": true,
									"multiselect": true,
									"toolTip": "",
									"constraints": {
										"allowedValues": "[map(filter(steps('userProfiles').azureFiles.storageAccountsApi.transformed.list, (sa) => if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), if(and(not(empty(steps('basics').hostPoolApi.tags)), not(empty(steps('basics').hostPoolApi.tags.storageResourceGroup))), equals(first(skip(split(sa.id, '/'), 4)), steps('basics').hostPoolApi.tags.storageResourceGroup), equals(sa.location, steps('hosts').scope.location.name)), equals(sa.location, steps('hosts').scope.location.name))), (sa) => parse(concat('{\"label\":\"', sa.name, '\",\"description\":\"Resource Group: ', first(skip(split(sa.id, '/'), 4)),  ', Location: ', sa.location, '\", \"value\":\"', sa.id, '\"}')))]",
										"required": true
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)))]"
								},
								{
									"name": "wrongNumberOfLocalStorageAccounts",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)), not(equals(steps('userProfiles').azureFiles.storageCount, length(steps('userProfiles').azureFiles.existingLocalStorageAccounts))))]",
									"options": {
										"style": "Error",
										"text": "You have not selected the correct number of storage accounts. You must select the correct number before continuing or the session hosts will not be configured properly."
									}
								},
								{
									"name": "remoteAccountsHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]",
									"options": {
										"text": "<u>Remote Storage Accounts</u>"
									}
								},
								{
									"name": "singleSACCTextBox",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, or(equals(steps('userProfiles').azureFiles.shardingOption, 'None'), equals(steps('identity').solution, 'EntraId')), contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]",
									"options": {
										"text": "<u>Optionally</u>, select a remote region (not in the same region as your session hosts) and then a single storage account from the selected region for active/active disaster recovery or high availability of user profiles using FSLogix Cloud Cache."
									}
								},
								{
									"name": "morethanOneSACCTextBox",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'), not(equals(steps('identity').solution, 'EntraId')), not(equals(steps('userProfiles').azureFiles.shardingOption, 'None')))]",
									"options": {
										"text": "<u>Optionally</u>, select a remote region (not in the same region as your session hosts) and then the same number of storage accounts as the groups selected/provided above in the selected remote region. The session hosts will be configured to also store user profiles on these remote storage accounts using FSLogix Cloud Cache."
									}
								},
								{
									"name": "remoteLocation",
									"type": "Microsoft.Common.DropDown",
									"label": "Remote Location of Storage Account(s)",
									"toolTip": "Select the Remote Location.",
									"defaultDescription": "",
									"constraints": {
										"allowedValues": "[map(filter(steps('hosts').scope.locationsApi.transformed.list, (loc) => not(equals(loc.value, steps('hosts').scope.location.name))), (loc) => parse(concat('{\"label\":\"', loc.label, '\",\"value\":\"', loc.value, '\"}')))]",
										"required": false
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]"
								},
								{
									"name": "existingRemoteStorageAccounts",
									"type": "Microsoft.Common.DropDown",
									"label": "Existing Remote Storage Accounts",
									"multiLine": true,
									"multiselect": true,
									"toolTip": "",
									"constraints": {
										"allowedValues": "[map(filter(steps('userProfiles').azureFiles.storageAccountsApi.transformed.list, (sa) => equals(sa.location, steps('userProfiles').azureFiles.remoteLocation)), (sa) => parse(concat('{\"label\":\"', sa.name, '\",\"description\":\"Resource Group: ', first(skip(split(sa.id, '/'), 4)), '\", \"value\":\"', sa.id, '\"}')))]",
										"required": false
									},
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'))]"
								},
								{
									"name": "wrongNumberOfRemoteStorageAccounts",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'), not(equals(length(steps('userProfiles').azureFiles.existingRemoteStorageAccounts), 0)) , not(equals(steps('userProfiles').azureFiles.storageCount, length(steps('userProfiles').azureFiles.existingRemoteStorageAccounts))))]",
									"options": {
										"style": "Error",
										"text": "You have not selected the correct number of storage accounts. You must select the correct number before continuing or the session hosts will not be configured properly."
									}
								}
							]
						},
						{
							"name": "shareManagement",
							"type": "Microsoft.Common.Section",
							"label": "Share Management",
							"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('userProfiles').deployStorage)]",
							"elements": [
								{
									"name": "shareManagementTextBox2",
									"type": "Microsoft.Common.TextBlock",
									"options": {
										"text": "You can optionally select groups that will be assigned admin permissions to the file share to facilitate user profile management troubleshooting."
									}
								},
								{
									"name": "configureAdminAccess",
									"type": "Microsoft.Common.CheckBox",
									"label": "Add Admin Access to File Share",
									"visible": true
								},
								{
									"name": "groupPickerBlade",
									"type": "Microsoft.Solutions.BladeInvokeControl",
									"openBladeStatus": "[steps('userProfiles').shareManagement.groupSelector.changing]",
									"bladeReference": {
										"name": "ObjectPickerBlade",
										"extension": "Microsoft_AAD_IAM",
										"parameters": {
											"queries": 32,
											"disablers": 4,
											"bladeSubtitle": "Pick the groups to assign",
											"additionalQueriesOnSearch": 0,
											"advancedQueryOptions": {
												"suggestedObjectsOptions": {}
											},
											"selectionMaximum": 20,
											"selectionMinimum": 1,
											"bladeTitle": "Select Groups",
											"informationHeader": {
												"informationText": "Select the groups to assign to the desktop application group",
												"informationLink": ""
											},
											"inviteEnabled": true,
											"searchBoxLabel": "Search for a group",
											"searchBoxPlaceHolderText": "Enter a string in the group name",
											"searchBoxTooltip": "This is the tooltip",
											"searchGridNoRowsMessage": "No groups found",
											"selectButtonText": "Select Groups",
											"selectedGridLabel": "Selected Admin Groups",
											"selectedGridNoRowsMessage": "You must select at least one group"
										},
										"inFullScreen": false
									},
									"transforms": {
										"groups": "selectedObjects|[*].{id:id, name:displayName}"
									}
								},
								{
									"name": "groupSelector",
									"type": "Microsoft.Common.Selector",
									"label": "Select Admin Groups",
									"keyPath": "displayName",
									"descriptionKeyPath": "id",
									"value": "[steps('userProfiles').shareManagement.groupPickerBlade.transformed.groups]",
									"visible": "[equals(steps('userProfiles').shareManagement.configureAdminAccess, true)]",
									"barColor": "[if(empty(steps('userProfiles').shareManagement.groupPickerBlade), '#FF0000', '#7fba00')]",
									"constraints": {
										"required": true
									},
									"link": "[if(empty(steps('userProfiles').shareManagement.groupPickerBlade), 'Select groups', 'Re-select groups')]"
								}
							]
						}
					]
				},
				{
					"name": "management",
					"label": "Management and Monitoring",
					"elements": [
						{
							"name": "servicePrincipals",
							"type": "Microsoft.Common.Section",
							"label": "Azure Virtual Desktop Service Principal RBAC Assignment",
							"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), or(steps('controlPlane').hostPool.startVmOnConnect, steps('controlPlane').scalingPlan.deployScalingPlan))]",
							"elements": [
								{
									"name": "avdServicePrincipalInfoBox",
									"type": "Microsoft.Common.InfoBox",
									"options": {
										"style": "Info",
										"text": "The 'Azure/Windows Virtual Desktop' Microsoft Application (AppId: 9cdead84-a844-4324-93f2-b2e6bb768d07) must be assigned the required RBAC roles to the subscription to ensure the Scaling Plan and/or Start VM on Connect options work correctly.",
										"uri": "https://learn.microsoft.com/en-us/azure/virtual-desktop/autoscale-create-assign-scaling-plan?tabs=portal%2Cintune&pivots=power-management#assign-permissions-to-the-azure-virtual-desktop-service-principal"
									}
								},
								{
									"name": "enableAVDSPRBAC",
									"type": "Microsoft.Common.CheckBox",
									"label": "Assign Required Role"
								},
								{
									"name": "avdServicePrincipalApi",
									"type": "Microsoft.Solutions.GraphApiControl",
									"request": {
										"method": "GET",
										"path": "/v1.0/servicePrincipals?$filter=appId eq '9cdead84-a844-4324-93f2-b2e6bb768d07'"
									}
								},
								{
									"name": "avdArmServicePrincipalApi",
									"type": "Microsoft.Solutions.GraphApiControl",
									"request": {
										"method": "GET",
										"path": "/v1.0/servicePrincipals?$filter=appId eq '50e95039-b200-4007-bc97-8d5790743a63'"
									}
								},
								{
									"name": "avdServicePrincipalPickerBlade",
									"type": "Microsoft.Solutions.BladeInvokeControl",
									"openBladeStatus": "[steps('management').servicePrincipals.avdServicePrincipalSelector.changing]",
									"bladeReference": {
										"name": "ObjectPickerBlade",
										"extension": "Microsoft_AAD_IAM",
										"parameters": {
											"queries": 16777216,
											"bladeSubtitle": "Azure/Windows Virtual Desktop Application",
											"additionalQueriesOnSearch": 0,
											"advancedQueryOptions": {},
											"selectionMaximum": 1,
											"selectionMinimum": 1,
											"bladeTitle": "Select the Microsoft Application",
											"informationHeader": {
												"informationText": "Select the 'Azure/Windows Virtual Desktop' Application."
											},
											"searchBoxLabel": "Copy '9cdead84-a844-4324-93f2-b2e6bb768d07' into the search box",
											"searchBoxPlaceHolderText": "Enter '9cdead84-a844-4324-93f2-b2e6bb768d07'",
											"searchGridNoRowsMessage": "No Microsoft Applications found",
											"selectButtonText": "Select Microsoft Application",
											"selectedGridLabel": "Selected Microsoft Application",
											"selectedGridNoRowsMessage": "You must select the 'Azure/Windows Virtual Desktop' Microsoft Application"
										}
									},
									"transforms": {
										"selection": "selectedObjects|[*].{displayName:displayName,id:id}"
									}
								},
								{
									"name": "avdServicePrincipalSelector",
									"type": "Microsoft.Common.Selector",
									"label": "Select the <b>Azure Virtual Desktop</b> Microsoft Application",
									"keyPath": "displayName",
									"value": "[steps('management').servicePrincipals.avdServicePrincipalPickerBlade.transformed.selection]",
									"barColor": "[if(empty(steps('management').servicePrincipals.avdServicePrincipalPickerBlade), '#FF0000', '#7fba00')]",
									"constraints": {
										"required": true
									},
									"link": "[if(empty(steps('management').servicePrincipals.avdServicePrincipalPickerBlade), 'Select the Azure Virtual Desktop Application', first(map(steps('management').servicePrincipals.avdServicePrincipalPickerBlade.transformed.selection, (sp) => sp.displayName)))]",
									"visible": "[and(steps('management').servicePrincipals.enableAVDSPRBAC, empty(first(steps('management').servicePrincipals.avdServicePrincipalApi.value)), or(steps('controlPlane').hostPool.startVmOnConnect, steps('controlPlane').scalingPlan.deployScalingPlan))]"
								}
							]
						},
						{
							"name": "automation",
							"type": "Microsoft.Common.Section",
							"label": "Automation",
							"elements": [
								{
									"name": "deployIncreaseQuota",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable File Share Automatic Quota Increase",
									"toolTip": "Choose to deploy a function app that will automatically increase your Azure Premium File Share quota when the remaining space is at a critical level."
								},
								{
									"name": "serverFarmsApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[not(empty(steps('basics').subscription))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.subscription.id, '/providers/'Microsoft.Web/serverfarms?api-version=2023-12-01')]"
									}
								},
								{
									"name": "serverFarm",
									"type": "Microsoft.Common.DropDown",
									"label": "Function App Hosting Plan (Server Farm)",
									"multiLine": true,
									"toolTip": "Select the existing Hosting Plan which the Function App will use. Note that only Hosting Plans located in the same region as the storage accounts are shown.",
									"constraints": {
										"allowedValues": "[map(filter(steps('management').automation.serverFarmsApi.value, (sf) => equals(sf.location, steps('hosts').scope.location.name)), (sf) => parse(concat('{\"label\":\"', sf.name, '\",\"description\":\"Location: ', sf.location, ' Resource Group: ', first(skip(split(sf.id, '/'), 4)), '\",\"value\":\"', sf.id, '\"}')))]",
										"required": true
									},
									"visible": "[and(equals(steps('basics').deploymentType, 'HostpoolOnly'), steps('management').automation.deployIncreaseQuota)]"
								}
							],
							"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), equals(steps('userProfiles').azureFiles.storageSku, 'Premium'))]"
						},
						{
							"name": "backup",
							"type": "Microsoft.Common.Section",
							"label": "Backup and Recovery",
							"visible": "[or(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), equals(steps('basics').hostPoolApi.properties.hostPoolType, 'Personal'))]",
							"elements": [
								{
									"name": "recoveryServicesVaultApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), not(empty(steps('hosts').scope.resourceGroup.id)))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.resourceGroup.id, '/providers/Microsoft.RecoveryServices/vaults?api-version=2024-10-01')]",
										"transforms": {
											"list": "value|[*].{label:name, value:id}"
										}
									}
								},
								{
									"name": "recoveryServices",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable Recovery Services",
									"defaultValue": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), true, if(empty(steps('basics').recoveryServicesVaultApi), false, true))]",
									"toolTip": "Choose to deploy backups for your solution. For a personal host pool, this will enable backups on the virtual machines. For a pooled host pool, this will enable backups on the FSLogix file share when using Azure Files."
								},
								{
									"name": "recoveryServicesVault",
									"type": "Microsoft.Common.DropDown",
									"label": "Recovery Services Vault",
									"defaultValue": "[first(steps('management').backup.recoveryServicesVaultApi.transformed.list).label]",
									"constraints": {
										"allowedValues": "[steps('management').backup.recoveryServicesVaultApi.transformed.list]",
										"required": true
									},
									"visible": "[and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), steps('management').backup.recoveryServices)]"
								},
								{
									"name": "diskAccessesApi",
									"type": "Microsoft.Solutions.ArmApiControl",
									"condition": "[and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), not(empty(steps('hosts').scope.resourceGroup.id)))]",
									"request": {
										"method": "GET",
										"path": "[concat(steps('hosts').scope.resourceGroup.id, '/providers/Microsoft.Compute/diskAccesses?api-version=2024-03-02')]",
										"transforms": {
											"list": "value|[*].{label:name, value:id}"
										}
									}
								},
								{
									"name": "associateDiskAccessResource",
									"type": "Microsoft.Common.CheckBox",
									"label": "Associate VM(s) with Disk Access Resource",
									"defaultValue": "[not(empty(steps('management').backup.diskAccessesApi))]",
									"toolTip": "Disk Access Resources are used to allow Azure Backup to access the managed disk over the private network in order to perform the backup.",
									"visible": "[and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), not(empty(steps('management').backup.diskAccessesApi)))]"
								},
								{
									"name": "diskAccess",
									"type": "Microsoft.Common.DropDown",
									"label": "Disk Access",
									"defaultValue": "[first(steps('management').backup.diskAccessesApi.transformed.list).label]",
									"toolTip": "Select the existing Disk Access Resource",
									"constraints": {
										"allowedValues": "[steps('management').backup.diskAccessesApi.transformed.list]",
										"required": true
									},
									"visible": "[and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), steps('management').backup.associateDiskAccessResource)]"
								}
							]
						},
						{
							"name": "keyVaults",
							"type": "Microsoft.Common.Section",
							"label": "Key Vaults",
							"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), or(and(equals(steps('basics').deploymentType, 'Complete'), equals(steps('identity').credentials.source, 'manual')), contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged')))]",
							"elements": [
								{
									"name": "deploySecretsKeyVault",
									"type": "Microsoft.Common.CheckBox",
									"label": "Deploy VM Secrets Key Vault",
									"toolTip": "Select to deploy a key vault and create secrets for VM Admin user and password and if applicable, the domain join username and password.",
									"visible": "[and(equals(steps('basics').deploymentType, 'Complete'), equals(steps('identity').credentials.source, 'manual'))]"
								},
								{
									"name": "enableSoftDelete",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable Soft Delete on Secrets Key Vault",
									"defaultValue": true,
									"toolTip": "Select to enable soft delete on the secrets key vault",
									"visible": "[and(equals(steps('identity').credentials.source, 'manual'), steps('management').keyVaults.deploySecretsKeyVault)]"
								},
								{
									"name": "enablePurgeProtection",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable Purge Protection on Secrets Key Vault",
									"defaultValue": true,
									"toolTip": "Select to enable purge protection on the secrets key vault",
									"visible": "[and(equals(steps('identity').credentials.source, 'manual'), steps('management').keyVaults.deploySecretsKeyVault, steps('management').keyVaults.enableSoftDelete)]"
								},
								{
									"name": "keyVaultRetentionInDays",
									"type": "Microsoft.Common.Slider",
									"label": "Key Vault Retention (in Days)",
									"defaultValue": 90,
									"showStepMarkers": false,
									"toolTip": "The number of days Key Vaults are kept in the recycle bin. Soft delete is designed to prevent accidental deletion of your key vault and keys, secrets, and certificates stored inside key vault. When you delete a key vault or a key vault object, it remains recoverable for a user configurable retention period or a default of 90 days.",
									"min": 7,
									"max": 90,
									"visible": "[and(equals(steps('basics').deploymentType, 'Complete'), or(contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'), steps('management').keyVaults.deploySecretsKeyVault))]"
								},
								{
									"name": "existingEncryptionKeyVault",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Existing Encryption Keyvault",
									"resourceType": "Microsoft.KeyVault/vaults",
									"toolTip": "Select an existing Key Vault to use for Customer Managed Keys. Note that only key vaults in the Virtual Machine location are shown.",
									"constraints": {
										"required": true
									},
									"scope": {
										"subscriptionId": "[steps('hosts').scope.subscription.subscriptionId]",
										"location": "[steps('hosts').scope.location.name]"
									},
									"visible": "[and(equals(steps('basics').deploymentType, 'HostpoolOnly'), or(contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged')))]"
								},
								{
									"name": "keyExpirationInDays",
									"type": "Microsoft.Common.Slider",
									"label": "Encryption Key Rotation (in Days)",
									"defaultValue": 180,
									"showStepMarkers": false,
									"toolTip": "The number of days before a new key version is automatically generated in the Azure Key Vault.",
									"min": 30,
									"max": 180,
									"visible": "[or(contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'))]"
								}
							]
						},
						{
							"name": "monitoring",
							"type": "Microsoft.Common.Section",
							"label": "Monitoring",
							"visible": true,
							"elements": [
								{
									"name": "enableMonitoring",
									"type": "Microsoft.Common.CheckBox",
									"visible": true,
									"label": "Enable Monitoring for AVD and VM Insights",
									"defaultValue": true,
									"toolTip": "Deploy the required resources to enable AVD and VM Insights."
								},
								{
									"name": "subscription",
									"type": "Microsoft.Common.DropDown",
									"label": "AVD Monitoring Subscription",
									"defaultValue": "[steps('hosts').scope.subscription.displayName]",
									"toolTip": "[if(equals(steps('basics').deploymentType, 'Complete'), 'Select the subscription where AVD monitoring resources will be deployed.', 'Select the subscription where existing AVD monitoring resources are located.')]",
									"constraints": {
										"allowedValues": "[map(steps('basics').subscriptionsApi.value, (sub) => parse(concat('{\"label\":\"', sub.displayName, '\",\"value\":{\"displayName\":\"', sub.displayName, '\",\"id\":\"', sub.id, '\",\"subscriptionId\":\"', sub.subscriptionId, '\"}}')))]",
										"required": true
									},
									"visible": "[steps('management').monitoring.enableMonitoring]"
								},
								{
									"name": "logAnalyticsWorkspacesApi",
									"condition": "[and(equals(steps('basics').deploymentType, 'HostpoolOnly'), steps('management').monitoring.enableMonitoring, not(empty(steps('management').monitoring.subscription)))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('management').monitoring.subscription.id, '/providers/Microsoft.OperationalInsights/workspaces?api-version=2023-09-01')]"
									}
								},
								{
									"name": "logAnalyticsWorkspace",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('management').monitoring.logAnalyticsWorkspacesApi.value, (la) => and(contains(la.name, '-avd-'), equals(la.location, steps('controlPlane').scope.location.name))), (la) => la.name))]",
									"visible": "[and(equals(steps('basics').deploymentType, 'HostpoolOnly'), steps('management').monitoring.enableMonitoring)]",
									"label": "Existing Log Analytics Workspace",
									"multiLine": true,
									"toolTip": "Select the existing Log Analytics Workspace to which AVD control plane and resource monitoring data will be sent.",
									"constraints": {
										"allowedValues": "[map(steps('management').monitoring.logAnalyticsWorkspacesApi.value, (la) => parse(concat('{\"label\":\"', la.name, '\",\"description\":\"Resource Group: ', first(skip(split(la.id, '/'), 4)), ', Location: ', la.location, '\",\"value\":\"', la.id, '\"}')))]",
										"required": true
									}
								},
								{
									"name": "dataCollectionRulesApi",
									"condition": "[and(not(equals(steps('basics').deploymentType, 'Complete')), steps('management').monitoring.enableMonitoring, not(empty(steps('management').monitoring.subscription)))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('management').monitoring.subscription.id, '/providers/Microsoft.Insights/dataCollectionRules?api-version=2023-03-11')]"
									}
								},
								{
									"name": "avdInsightsDataCollectionRule",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('management').monitoring.dataCollectionRulesApi.value, (dcr) => equals(dcr.name, concat('microsoft-avdi-', steps('hosts').scope.location.name))), (dcr) => dcr.name))]",
									"visible": "[and(not(equals(steps('basics').deploymentType, 'Complete')), steps('management').monitoring.enableMonitoring)]",
									"label": "AVD Insights Data Collection Rule",
									"multiLine": true,
									"toolTip": "Select the existing AVD Insights Data Collection Rule.",
									"constraints": {
										"allowedValues": "[map(filter(steps('management').monitoring.dataCollectionRulesApi.value, (dcr) => and(contains(dcr.name, 'avdi'), equals(dcr.location, steps('hosts').scope.location.name))), (dcr) => parse(concat('{\"label\":\"', dcr.name, '\",\"description\":\"Resource Group: ', first(skip(split(dcr.id, '/'), 4)), ', Location: ', dcr.location, '\",\"value\":\"', dcr.id, '\"}')))]",
										"required": false
									}
								},
								{
									"name": "vmInsightsDataCollectionRule",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('management').monitoring.dataCollectionRulesApi.value, (dcr) => equals(dcr.name, concat('MSVMI-', steps('hosts').scope.location.name))), (dcr) => dcr.name))]",
									"visible": "[and(not(equals(steps('basics').deploymentType, 'Complete')), steps('management').monitoring.enableMonitoring)]",
									"label": "VM Insights Data Collection Rule",
									"multiLine": true,
									"toolTip": "Select the existing Virtual Machines Insights Data Collection Rule.",
									"constraints": {
										"allowedValues": "[map(filter(steps('management').monitoring.dataCollectionRulesApi.value, (dcr) => and(contains(dcr.name, 'MSVMI'), equals(dcr.location, steps('hosts').scope.location.name))), (dcr) => parse(concat('{\"label\":\"', dcr.name, '\",\"description\":\"Resource Group: ', first(skip(split(dcr.id, '/'), 4)), ', Location: ', dcr.location, '\",\"value\":\"', dcr.id, '\"}')))]",
										"required": false
									}
								},
								{
									"name": "dataCollectionEndpointsApi",
									"condition": "[and(not(empty(steps('management').monitoring.subscription.id)), not(equals(steps('basics').deploymentType, 'Complete')), steps('management').monitoring.enableMonitoring)]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('management').monitoring.subscription.id, '/providers/Microsoft.Insights/dataCollectionEndpoints?api-version=2023-03-11')]"
									}
								},
								{
									"name": "dataCollectionEndpoint",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('management').monitoring.dataCollectionEndpointsApi.value, (dce) => and(contains(dce.name, 'avd'), equals(dce.location, steps('hosts').scope.location.name))), (dce) => dce.name))]",
									"visible": "[and(not(equals(steps('basics').deploymentType, 'Complete')), steps('management').monitoring.enableMonitoring)]",
									"label": "Data Collection Endpoint",
									"multiLine": true,
									"toolTip": "Select the existing Data Collection Endpoint.",
									"constraints": {
										"allowedValues": "[map(filter(steps('management').monitoring.dataCollectionEndpointsApi.value, (dce) => equals(dce.location, steps('hosts').scope.location.name)), (dce) => parse(concat('{\"label\":\"', dce.name, '\",\"description\":\"Resource Group: ', first(skip(split(dce.id, '/'), 4)), ', Location: ', dce.location, '\",\"value\":\"', dce.id, '\"}')))]",
										"required": false
									}
								},
								{
									"name": "enableCentralMonitoring",
									"type": "Microsoft.Common.CheckBox",
									"visible": true,
									"label": "Configure Centralized Security Monitoring for Session Hosts",
									"toolTip": "Creates a Data Collection Rule Association to use the Azure Monitoring Agent for collecting data in a centralized workspace."
								},
								{
									"name": "securityDataCollectionRule",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Security Monitoring Data Collection Rule",
									"visible": "[steps('management').monitoring.enableCentralMonitoring]",
									"resourceType": "Microsoft.Insights/dataCollectionRules",
									"toolTip": "Select the Data Collection Rule used for collecting security data for Sentinel or Defender for Cloud. This is required to create the Data Collection Rule Association",
									"constraints": {
										"required": true
									}
								}
							]
						}
					]
				},
				{
					"name": "zeroTrust",
					"label": "Zero Trust Configuration",
					"elements": [
						{
							"name": "zeroTrusttextBlock0",
							"type": "Microsoft.Common.TextBlock",
							"visible": "[equals(steps('basics').deploymentType, 'SessionHostsOnly')]",
							"options": {
								"text": "This page is intentionally blank when only completing a Session Host Deployment."
							}
						},
						{
							"name": "zeroTrusttextBlock1",
							"type": "Microsoft.Common.TextBlock",
							"options": {
								"text": "Zero Trust is a new security model that assumes breach and verifies each request as though it originated from an uncontrolled network.",
								"link": {
									"label": "Microsoft Learn | Zero Trust Security",
									"uri": "https://learn.microsoft.com/en-us/azure/security/fundamentals/zero-trust"
								}
							},
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]"
						},
						{
							"name": "privateEndpoints",
							"type": "Microsoft.Common.Section",
							"label": "Private Endpoints",
							"visible": "[and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), or(and(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('management').backup.recoveryServices), and(steps('userProfiles').deployStorage, equals(steps('userProfiles').storageService, 'AzureFiles')), and(equals(steps('basics').deploymentType, 'Complete'), or(steps('hosts').diskEncryption.confidentialVMOSDiskEncryption, contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged')))))]",
							"elements": [
								{
									"name": "privateEndpointTextBlock1",
									"type": "Microsoft.Common.TextBlock",
									"options": {
										"text": "Private Endpoints are one key technology we can use to implement Zero Trust Architecture Guidance. Private endpoints should be utilized for all Platform as a Service (PaaS) resources (i.e., Blob Storage, File Storage, and Key Vaults utilized by this solution. Private Endpoints have their own set of prereqs including Private DNS Zones.",
										"link": {
											"label": "Microsoft Learn | Private Endpoint Overview",
											"uri": "https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview"
										}
									}
								},
								{
									"name": "deployPrivateEndpoints",
									"type": "Microsoft.Common.CheckBox",
									"label": "Deploy Private Endpoints",
									"defaultValue": true
								},
								{
									"name": "privateEndpointTextBlock2",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').privateEndpoints.deployPrivateEndpoints]",
									"options": {
										"link": {
											"label": "Microsoft Learn | Private Link Deployment in a Hub and Spoke Network",
											"uri": "https://learn.microsoft.com/en-us/azure/architecture/networking/guide/private-link-hub-spoke-network"
										},
										"text": "When deploying private endpoints, you must select the subnet and Private DNS Zones required for DNS resolution. The available virtual networks are dynamically filtered according to the regions specified for the resource types in earlier configuration screens. The drop-down menus will present only the virtual networks, subnets, and Private DNS Zones that match your prior selections, ensuring that you can choose the appropriate resources for your Zero Trust implementation."
									}
								},
								{
									"name": "subnetsHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').privateEndpoints.deployPrivateEndpoints]",
									"options": {
										"text": "<u>Subnets</u>"
									}
								},
								{
									"name": "managementHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(or(steps('management').keyVaults.deploySecretsKeyVault, steps('management').automation.deployIncreaseQuota), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints)]",
									"options": {
										"text": "<i>Shared Management Resources (i.e., Key Vaults, Function Apps, etc.)</i>"
									}
								},
								{
									"name": "managementVirtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Network",
									"defaultValue": "[steps('hosts').network.virtualNetwork.name]",
									"multiLine": true,
									"toolTip": "Select the virtual network for the key vault and/or function app private endpoints.<br><br><b>Important:</b> The virtual networks are limited to those in the same region and subscription that you selected in the 'Subscription and Region Details' section of the 'Session Hosts' pane.",
									"constraints": {
										"allowedValues": "[map(filter(steps('hosts').network.virtualNetworksApi.value, (vnet) => equals(vnet.location, steps('hosts').scope.location.name)), (vnet) => parse(concat('{\"label\":\"', vnet.name, '\",\"description\":\"Location: ', vnet.location, ' Resource Group: ', first(skip(split(vnet.id, '/'), 4)), '\",\"value\":{\"name\":\"', vnet.name, '\",\"id\":\"', vnet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[and(or(and(equals(steps('basics').deploymentType, 'Complete'), or(contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'), steps('management').keyVaults.deploySecretsKeyVault)), steps('management').automation.deployIncreaseQuota), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints)]"
								},
								{
									"name": "managementSubnetsApi",
									"condition": "[not(empty(steps('zeroTrust').privateEndpoints.managementVirtualNetwork))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('zeroTrust').privateEndpoints.managementVirtualNetwork.id, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "keyVaultsSubnet",
									"type": "Microsoft.Common.DropDown",
									"label": "Key Vault Private Endpoint subnet",
									"toolTip": "Select an existing subnet for the private Endpoint.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.managementSubnetsApi.value, (snet) => empty(snet.properties.delegations)), (snet) => parse(concat('{\"label\":\"', snet.name, '\",\"value\":{\"name\":\"', snet.name, '\",\"id\":\"', snet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[and(equals(steps('basics').deploymentType, 'Complete'), or(contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'), steps('management').keyVaults.deploySecretsKeyVault), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints)]"
								},
								{
									"name": "functionAppOutboundSubnet",
									"type": "Microsoft.Common.DropDown",
									"label": "Function App Outbound subnet",
									"toolTip": "Select an existing subnet for function App Outbound access. This subnet must have a delegation for Microsoft.Web/serverFarms.",
									"constraints": {
										"required": true,
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.managementSubnetsApi.value, (snet) => equals(first(map(snet.properties.delegations, (del) => del.properties.serviceName)), 'Microsoft.Web/serverFarms')), (snet) => parse(concat('{\"label\":\"', snet.name, '\",\"value\":\"', snet.id, '\"}')))]"
									},
									"visible": "[and(steps('management').automation.deployIncreaseQuota, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints)]"
								},
								{
									"name": "hostpoolHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(or(and(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('management').backup.recoveryServices), and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').storageService, 'AzureFiles'))), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints)]",
									"options": {
										"text": "<i>Hostpool Resources (Storage or Recovery Services Vaults)</i>"
									}
								},
								{
									"name": "hostpoolVirtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Network",
									"multiLine": true,
									"defaultValue": "[steps('hosts').network.virtualNetwork.name]",
									"toolTip": "Select the virtual network for the storage account and/or recovery services vault private endpoints.<br><br><b>Important:</b> The virtual networks are limited to those in the same region and subscription that you selected in the 'Subscription and Region Details' section of the 'Session Hosts' pane.",
									"constraints": {
										"allowedValues": "[map(filter(steps('hosts').network.virtualNetworksApi.value, (vnet) => equals(vnet.location, steps('hosts').scope.location.name)), (vnet) => parse(concat('{\"label\":\"', vnet.name, '\",\"description\":\"Location: ', vnet.location, ' Resource Group: ', first(skip(split(vnet.id, '/'), 4)), '\",\"value\":{\"name\":\"', vnet.name, '\",\"id\":\"', vnet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[and(or(and(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('management').backup.recoveryServices), and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').storageService, 'AzureFiles'))), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints)]"
								},
								{
									"name": "hostpoolSubnetsApi",
									"condition": "[not(empty(steps('zeroTrust').privateEndpoints.hostpoolVirtualNetwork))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('zeroTrust').privateEndpoints.hostpoolVirtualNetwork.id, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "hostpoolSubnet",
									"type": "Microsoft.Common.DropDown",
									"label": "Private Endpoints Subnet",
									"toolTip": "Select an existing subnet for the private Endpoints.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.hostpoolSubnetsApi.value, (snet) => empty(snet.properties.delegations)), (snet) => parse(concat('{\"label\":\"', snet.name, '\",\"value\":{\"name\":\"', snet.name, '\",\"id\":\"', snet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[and(or(and(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('management').backup.recoveryServices), and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').storageService, 'AzureFiles'))), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints)]"
								},
								{
									"name": "privateDNSZonesHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').privateEndpoints.deployPrivateEndpoints]",
									"options": {
										"text": "<u>Private DNS Zones</u>"
									}
								},
								{
									"name": "privateDNSZoneIntegrationTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').privateEndpoints.deployPrivateEndpoints]",
									"options": {
										"text": "To connect privately with your private endpoint, you need a DNS record. We recommend that you integrate your private endpoint with a private DNS zone. If you select the checkbox below, you'll be asked to select the appropriate Private DNS Zone for each resource type deployed by this solution and the deployment will automatically create the Private DNS integration when creating the private endpoints. Alternatively, you can assign policies to private endpoints to automatically register the endpoints with the appropriate private DNS zones. Uncheck the box below if that is the method you are using.",
										"link": {
											"label": "Learn more",
											"uri": "https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview#dns-configuration"
										}
									}
								},
								{
									"name": "enablePrivateDNSIntegration",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable Private DNS Zone Integration",
									"toolTip": "To connect privately with your private endpoint, you need a DNS record. Check this box to select the appropriate private DNS zones so that the deployment automatically integrates each private endpoint with Azure private DNS.",
									"defaultValue": true,
									"visible": "[steps('zeroTrust').privateEndpoints.deployPrivateEndpoints]"
								},
								{
									"name": "privateDNSZonesSubscription",
									"type": "Microsoft.Common.DropDown",
									"label": "Private DNS Zone Subscription",
									"placeholder": "",
									"defaultValue": "[steps('hosts').scope.subscription.displayName]",
									"toolTip": "Select the subscription that contains your Private DNS Zones.",
									"constraints": {
										"allowedValues": "[map(steps('basics').subscriptionsApi.value, (sub) => parse(concat('{\"label\":\"', sub.displayName, '\",\"value\":{\"displayName\":\"', sub.displayName, '\",\"id\":\"', sub.id, '\",\"subscriptionId\":\"', sub.subscriptionId, '\"}}')))]",
										"required": true
									},
									"visible": "[and(steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration)]"
								},
								{
									"name": "privateDNSZonesApi",
									"condition": "[and(steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, not(empty(steps('zeroTrust').privateEndpoints.privateDNSZonesSubscription)))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('zeroTrust').privateEndpoints.privateDNSZonesSubscription.id, '/providers/Microsoft.Network/privateDnsZones?api-version=2018-09-01')]"
									}
								},
								{
									"name": "azureBackupPrivateDnsZone",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, '.backup.')), (zone) => zone.name))]",
									"visible": "[and(steps('management').backup.recoveryServices, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration)]",
									"label": "Azure Backup",
									"multiLine": true,
									"toolTip": "Select the existing Geo Specific Private DNS Zone for Azure Backup Storage.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, '.backup.')), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource Group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": false
									}
								},
								{
									"name": "azureBlobPrivateDnsZone",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.blob.')), (zone) => zone.name))]",
									"visible": "[and(or(steps('management').backup.recoveryServices, steps('management').automation.deployIncreaseQuota), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration)]",
									"label": "Azure Blob Storage",
									"multiLine": true,
									"toolTip": "Select the existing Private DNS Zone for Azure Blob Storage.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.blob.')), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource Group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": true
									}
								},
								{
									"name": "azureFilesPrivateDnsZone",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.file.')), (zone) => zone.name))]",
									"visible": "[and(or(and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').storageService, 'AzureFiles')), steps('management').automation.deployIncreaseQuota), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration)]",
									"label": "Azure Files",
									"multiLine": true,
									"toolTip": "Select the existing Private DNS Zone for Azure Files.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.file.')), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource Group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": true
									}
								},
								{
									"name": "azureKeyVaultPrivateDnsZone",
									"type": "Microsoft.Common.DropDown",
									"label": "Azure Key Vault",
									"defaultValue": "[first(map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.vaultcore.')), (zone) => zone.name))]",
									"multiLine": true,
									"toolTip": "Select the existing Private DNS Zone for Azure Key Vaults.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.vaultcore.')), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": true
									},
									"visible": "[and(steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration, and(equals(steps('basics').deploymentType, 'Complete'), or(steps('management').keyVaults.deploySecretsKeyVault, contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'))))]"
								},
								{
									"name": "azureQueuePrivateDnsZone",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.queue.')), (zone) => zone.name))]",
									"visible": "[and(or(steps('management').backup.recoveryServices, steps('management').automation.deployIncreaseQuota), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration)]",
									"label": "Azure Queue Storage",
									"multiLine": true,
									"toolTip": "Select the existing Private DNS Zone for Azure Queue Storage.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.queue.')), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource Group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": false
									}
								},
								{
									"name": "azureTablePrivateDnsZone",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.table.')), (zone) => zone.name))]",
									"visible": "[and(steps('management').automation.deployIncreaseQuota, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration)]",
									"label": "Azure Table Storage",
									"multiLine": true,
									"toolTip": "Select the existing Private DNS Zone for Azure Table Storage.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.table.')), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource Group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": false
									}
								},
								{
									"name": "azureFunctionAppPrivateDnsZone",
									"type": "Microsoft.Common.DropDown",
									"defaultValue": "[first(map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => or(startsWith(zone.name, 'privatelink.azurewebsites.'), startsWith(zone.name, 'privatelink.appservice.'))), (zone) => zone.name))]",
									"visible": "[and(steps('management').automation.deployIncreaseQuota, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration)]",
									"label": "Azure Web App",
									"multiLine": true,
									"toolTip": "Select the existing Private DNS Zone for Azure Function Apps",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').privateEndpoints.privateDNSZonesApi.value, (zone) => or(startsWith(zone.name, 'privatelink.azurewebsites.'), startsWith(zone.name, 'privatelink.appservice.'))), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource Group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": false
									}
								}
							]
						},
						{
							"name": "azureMonitor",
							"type": "Microsoft.Common.Section",
							"label": "Azure Monitor",
							"visible": "[equals(steps('basics').deploymentType, 'Complete')]",
							"elements": [
								{
									"name": "privateLinkTextBlock1",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "Azure Monitor is a constellation of different interconnected services that work together to monitor your workloads. An Azure Monitor private link connects a private endpoint to a set of Azure Monitor resources to define the boundaries of your monitoring network. That set is called an Azure Monitor Private Link Scope (AMPLS).",
										"link": {
											"label": "Use Azure Private Link to connect networks to Azure Monitor - Azure Monitor | Microsoft Learn",
											"uri": "https://learn.microsoft.com/en-us/azure/azure-monitor/logs/private-link-security"
										}
									}
								},
								{
									"name": "privateLink",
									"type": "Microsoft.Common.CheckBox",
									"label": "Attach AVD monitoring resources to an existing Azure Monitor Private Link Scope"
								},
								{
									"name": "azureMonitorPrivateLinkScope",
									"type": "Microsoft.Solutions.ResourceSelector",
									"label": "Azure Monitor Private Link Scope",
									"resourceType": "Microsoft.Insights/privateLinkScopes",
									"constraints": {
										"required": true
									},
									"visible": "[steps('zeroTrust').azureMonitor.privateLink]"
								}
							]
						},
						{
							"name": "policy",
							"type": "Microsoft.Common.Section",
							"label": "Policies",
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
							"elements": [
								{
									"name": "diskAccessTextBlock1",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "[if(and(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('management').backup.recoveryServices, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints), 'Check the following box to define and and assign a policy that disables public network access and automatically assigns a disk access resource to the virtual machine OS disks for private access.', 'Select the following check box to define and assign a policy that disables all network access to your managed disks.')]",
										"link": {
											"label": "Microsoft Learn | Restrict Managed Disks from Being Imported or Exported",
											"uri": "https://learn.microsoft.com/en-us/azure/virtual-machines/disks-restrict-import-export-overview"
										}
									}
								},
								{
									"name": "deployDiskAccessPolicy",
									"type": "Microsoft.Common.CheckBox",
									"label": "Deploy Disk Access Policy"
								}
							]
						},
						{
							"name": "avdPrivateLink",
							"type": "Microsoft.Common.Section",
							"label": "AVD Private Link",
							"visible": "[not(equals(steps('basics').deploymentType, 'SessionHostsOnly'))]",
							"elements": [
								{
									"name": "textBlock1",
									"type": "Microsoft.Common.TextBlock",
									"options": {
										"link": {
											"label": "Microsoft Learn | AVD Private Link Overview",
											"uri": "https://learn.microsoft.com/en-us/azure/virtual-desktop/private-link-overview"
										},
										"text": "You can use Azure Private Link with Azure Virtual Desktop to privately connect to your remote resources. By creating a private endpoint, traffic between your virtual network and the service remains on the Microsoft network, so you no longer need to expose your service to the public internet. You also use a VPN or ExpressRoute for your users with the Remote Desktop client to connect to the virtual network. Keeping traffic within the Microsoft network improves security and keeps your data safe."
									}
								},
								{
									"name": "enablePrivateLink",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable AVD Private Link"
								},
								{
									"name": "textBlock2",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]",
									"options": {
										"link": {
											"label": "Microsoft Learn | AVD Private Link Overview",
											"uri": "https://learn.microsoft.com/en-us/azure/virtual-desktop/private-link-overview"
										},
										"text": "When enabling Private Link with Azure Virtual Desktop, you have the following supported scenarios to connect to Azure Virtual Desktop. Choose the configuration below to meet your requirements. <ol><li>All parts of the connection - initial feed discovery, feed download, and remote session connections - use private routes.</li><br/><li>Feed download and remote session connections use private routes, but initial feed discovery uses public routes.</li><br/><li>Only remote session connections use private routes, but initial feed discovery and feed download use public routes.</li></ol>"
									}
								},
								{
									"name": "infoBox1",
									"type": "Microsoft.Common.InfoBox",
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(empty(filter(steps('controlPlane').workspacesApi.value, (ws) => contains(ws.name, 'global-feed')))))]",
									"options": {
										"style": "Info",
										"text": "[concat('An existing global feed workspace has been detected: ', first(map(filter(steps('controlPlane').workspacesApi.value, (ws) => contains(ws.name, 'global-feed')), (ws) => ws.name)), '. Therefore, you can only choose either option 2 or 3, because you can only have one global-feed workspace with one private endpoint.')]"
									}
								},
								{
									"name": "avdPrivateLinkConfig",
									"type": "Microsoft.Common.DropDown",
									"label": "AVD Private Link Configuration",
									"multiLine": true,
									"defaultValue": "[if(or(equals(steps('basics').deploymentType, 'HostpoolOnly'), equals(steps('controlPlane').workspace.createOption, 'update')), 'Only remote session connections use private routes', 'Feed download and remote session connections use private routes')]",
									"toolTip": "Chooose the AVD Private Link Configuration.",
									"constraints": {
										"allowedValues": "[if(or(equals(steps('basics').deploymentType, 'HostpoolOnly'), equals(steps('controlPlane').workspace.createOption, 'update')), parse('[{\"label\":\"Only remote session connections use private routes\",\"description\":\"Hostpool private endpoints are required\",\"value\":\"Hostpool\"}]'), if(empty(filter(steps('controlPlane').workspacesApi.value, (ws) => contains(ws.name, 'global-feed'))), parse('[{\"label\":\"All parts of the connection use private routes\",\"description\":\"Global feed, Workspace feed, and hostpool private endpoints are required\",\"value\":\"All\"},{\"label\":\"Feed download and remote session connections use private routes\",\"description\":\"Workspace feed and Hostpool private endpoints are required\",\"value\":\"FeedAndHostpool\"},{\"label\":\"Only remote session connections use private routes\",\"description\":\"Hostpool private endpoints are required\",\"value\":\"Hostpool\"}]'), parse('[{\"label\":\"Feed download and remote session connections use private routes\",\"description\":\"Workspace feed and Hostpool private endpoints are required\",\"value\":\"FeedAndHostpool\"},{\"label\":\"Only remote session connections use private routes\",\"description\":\"Hostpool private endpoints are required\",\"value\":\"Hostpool\"}]')))]",
										"required": true
									},
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]"
								},
								{
									"name": "hostpoolHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]",
									"options": {
										"text": "<u>Remote Session Connections</u>"
									}
								},
								{
									"name": "hostpoolTextBlock2",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]",
									"options": {
										"text": "Select the virtual network, and subnet for the remote session connection private endpoint. The virtual network is limited to the location of the virtual machines selected on the 'Basics' screen."
									}
								},
								{
									"name": "hostpoolVirtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Network",
									"multiLine": true,
									"toolTip": "Select the virtual network where the AVD Private Link Hostpool Connection private endpoints will be created. Note that only virtual networks located in the same region as the host pool (selected on the Control Plane blade).",
									"defaultValue": "[steps('zeroTrust').privateEndpoints.hostpoolVirtualNetwork.name]",
									"constraints": {
										"allowedValues": "[map(filter(steps('controlPlane').virtualNetworksApi.value, (vnet) => equals(vnet.location, steps('controlPlane').scope.location.name)), (vnet) => parse(concat('{\"label\":\"', vnet.name, '\",\"description\":\"Location: ', vnet.location, ' Resource Group: ', first(skip(split(vnet.id, '/'), 4)), '\",\"value\":{\"name\":\"', vnet.name, '\",\"id\":\"', vnet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]"
								},
								{
									"name": "hostpoolSubnetsApi",
									"condition": "[not(empty(steps('zeroTrust').avdPrivateLink.hostpoolVirtualNetwork))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('zeroTrust').avdPrivateLink.hostpoolVirtualNetwork.id, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "hostpoolSubnet",
									"type": "Microsoft.Common.DropDown",
									"label": "Subnet",
									"toolTip": "Select an existing subnet for the private Endpoints.",
									"defaultValue": "[steps('zeroTrust').privateEndpoints.hostpoolSubnet.name]",
									"constraints": {
										"allowedValues": "[map(steps('zeroTrust').avdPrivateLink.hostpoolSubnetsApi.value, (snet) => parse(concat('{\"label\":\"', snet.name, '\",\"value\":{\"name\":\"', snet.name, '\",\"id\":\"', snet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]"
								},
								{
									"name": "hostpoolPublicNetworkAccess",
									"type": "Microsoft.Common.DropDown",
									"label": "Remote Session Connection public access",
									"placeholder": "",
									"defaultValue": "Enabled",
									"multiLine": true,
									"toolTip": "Select the appropriate option for configuring public network access to the remote session.",
									"constraints": {
										"allowedValues": [
											{
												"label": "Disabled",
												"description": "Remote sessions are denied when either the client or session host is using a public route.",
												"value": "Disabled"
											},
											{
												"label": "Enabled",
												"description": "Remote sessions are allowed when either the client or session host are using a private or public route.",
												"value": "Enabled"
											},
											{
												"label": "Enabled For Clients Only",
												"description": "Remote sessions are allowed as long as the session host is using a private route, regardless of the route the client is using.",
												"value": "EnabledForClientsOnly"
											}
										],
										"required": false
									},
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]"
								},
								{
									"name": "feedWorkspaceHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'Hostpool')))]",
									"options": {
										"text": "<u>Workspace Feed</u>"
									}
								},
								{
									"name": "feedWorkspaceTextBlock1",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'Hostpool')))]",
									"options": {
										"text": "Select the virtual network and subnet for the workspace feed private endpoint. The virtual network is limited to the subscription and location as specified on the 'Control Plane' pane. The same private dns zone as the remote session connection is used."
									}
								},
								{
									"name": "feedWorkspaceVirtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Network",
									"multiLine": true,
									"toolTip": "Select the virtual network where the AVD Private Link Workspace feed download private endpoints will be created. Note that only virtual networks located in the same region as the control plane are shown.",
									"defaultValue": "[steps('zeroTrust').privateEndpoints.managementVirtualNetwork.name]",
									"constraints": {
										"allowedValues": "[map(filter(steps('controlPlane').virtualNetworksApi.value, (vnet) => equals(vnet.location, steps('controlPlane').scope.location.name)), (vnet) => parse(concat('{\"label\":\"', vnet.name, '\",\"description\":\"Location: ', vnet.location, ' Resource Group: ', first(skip(split(vnet.id, '/'), 4)), '\",\"value\":{\"name\":\"', vnet.name, '\",\"id\":\"', vnet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'Hostpool')))]"
								},
								{
									"name": "feedWorkspaceSubnetsApi",
									"condition": "[not(empty(steps('zeroTrust').avdPrivateLink.feedWorkspaceVirtualNetwork))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('zeroTrust').avdPrivateLink.feedWorkspaceVirtualNetwork.id, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "feedWorkspaceSubnet",
									"type": "Microsoft.Common.DropDown",
									"label": "Subnet",
									"toolTip": "Select an existing subnet for the private Endpoints.",
									"defaultValue": "[steps('zeroTrust').privateEndpoints.keyVaultsSubnet.name]",
									"constraints": {
										"allowedValues": "[map(steps('zeroTrust').avdPrivateLink.feedWorkspaceSubnetsApi.value, (snet) => parse(concat('{\"label\":\"', snet.name, '\",\"value\":{\"name\":\"', snet.name, '\",\"id\":\"', snet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'Hostpool')))]"
								},
								{
									"name": "feedWorkspacePublicNetworkAccess",
									"type": "Microsoft.Common.DropDown",
									"label": "Workspace feed public access",
									"placeholder": "",
									"defaultValue": "Public access enabled from all networks",
									"multiLine": true,
									"toolTip": "",
									"constraints": {
										"allowedValues": [
											{
												"label": "Public access enabled from all networks",
												"description": "Workspace feed requests are allowed from private and public routes.",
												"value": "Enabled"
											},
											{
												"label": "Public access disabled from all networks",
												"description": "Workspace feed requests are allowed only from private routes.",
												"value": "Disabled"
											}
										],
										"required": false
									},
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'Hostpool')))]"
								},
								{
									"name": "globalFeedTextBlock0",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'All'))]",
									"options": {
										"text": "<u>Global Feed</u>"
									}
								},
								{
									"name": "globalFeedTextBlock1",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'All'))]",
									"options": {
										"text": "Select the subscription, virtual network, and subnet where you wish to create the global feed private endpoint."
									}
								},
								{
									"name": "globalFeedVirtualNetwork",
									"type": "Microsoft.Common.DropDown",
									"label": "Virtual Network",
									"multiLine": true,
									"toolTip": "Select the virtual network where the AVD Private Link Global Workspace Private Endpoint will be created.",
									"defaultValue": "[steps('zeroTrust').avdPrivateLink.feedWorkspaceVirtualNetwork.name]",
									"constraints": {
										"allowedValues": "[map(filter(steps('controlPlane').virtualNetworksApi.value, (vnet) => equals(vnet.location, steps('controlPlane').scope.location.name)), (vnet) => parse(concat('{\"label\":\"', vnet.name, '\",\"description\":\"Location: ', vnet.location, ' Resource Group: ', first(skip(split(vnet.id, '/'), 4)), '\",\"value\":{\"name\":\"', vnet.name, '\",\"id\":\"', vnet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'All'))]"
								},
								{
									"name": "globalFeedSubnetsApi",
									"condition": "[not(empty(steps('zeroTrust').avdPrivateLink.globalFeedVirtualNetwork))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('zeroTrust').avdPrivateLink.globalFeedVirtualNetwork.id, '/subnets?api-version=2022-05-01')]"
									}
								},
								{
									"name": "globalFeedSubnet",
									"type": "Microsoft.Common.DropDown",
									"label": "Subnet",
									"toolTip": "Select an existing subnet for the global Feed Private Endpoint.",
									"defaultValue": "[steps('zeroTrust').avdPrivateLink.hostpoolSubnet.name]",
									"constraints": {
										"allowedValues": "[map(steps('zeroTrust').avdPrivateLink.globalFeedSubnetsApi.value, (snet) => parse(concat('{\"label\":\"', snet.name, '\",\"value\":{\"name\":\"', snet.name, '\",\"id\":\"', snet.id, '\"}}')))]",
										"required": true
									},
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'All'))]"
								},
								{
									"name": "privateDNSZonesHeader",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]",
									"options": {
										"text": "<u>Private DNS Zones</u>"
									}
								},
								{
									"name": "privateDNSZoneIntegrationTextBlock",
									"type": "Microsoft.Common.TextBlock",
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]",
									"options": {
										"text": "To connect privately with your private endpoint, you need a DNS record. We recommend that you integrate your private endpoint with a private DNS zone. If you select the checkbox below, you'll be asked to select the appropriate Private DNS Zone for each resource type deployed by this solution and the deployment will automatically create the Private DNS integration when creating the private endpoints. Alternatively, you can assign policies to private endpoints to automatically register the endpoints with the appropriate private DNS zones. Uncheck the box below if that is the method you are using.",
										"link": {
											"label": "Learn more",
											"uri": "https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview#dns-configuration"
										}
									}
								},
								{
									"name": "enablePrivateDNSIntegration",
									"type": "Microsoft.Common.CheckBox",
									"label": "Enable Private DNS Zone Integration",
									"toolTip": "To connect privately with your private endpoint, you need a DNS record. Check this box to select the appropriate private DNS zones so that the deployment automatically integrates each private endpoint with Azure private DNS.",
									"defaultValue": true,
									"visible": "[steps('zeroTrust').avdPrivateLink.enablePrivateLink]"
								},
								{
									"name": "privateDNSZonesSubscription",
									"type": "Microsoft.Common.DropDown",
									"label": "Private DNS Zone Subscription",
									"placeholder": "",
									"defaultValue": "[steps('zeroTrust').privateEndpoints.privateDNSZonesSubscription.displayName]",
									"toolTip": "Select the subscription containing your AVD Private Link Private DNS zones.",
									"constraints": {
										"allowedValues": "[map(steps('basics').subscriptionsApi.value, (sub) => parse(concat('{\"label\":\"', sub.displayName, '\",\"value\":{\"displayName\":\"', sub.displayName, '\",\"id\":\"', sub.id, '\",\"subscriptionId\":\"', sub.subscriptionId, '\"}}')))]",
										"required": true
									},
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.enablePrivateDNSIntegration)]"
								},
								{
									"name": "privateDNSZonesApi",
									"condition": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(empty(steps('zeroTrust').avdPrivateLink.privateDNSZonesSubscription)))]",
									"type": "Microsoft.Solutions.ArmApiControl",
									"request": {
										"method": "GET",
										"path": "[concat(steps('zeroTrust').avdPrivateLink.privateDNSZonesSubscription.id, '/providers/Microsoft.Network/privateDnsZones?api-version=2018-09-01')]"
									}
								},
								{
									"name": "wvdPrivateLinkDnsZone",
									"type": "Microsoft.Common.DropDown",
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.enablePrivateDNSIntegration)]",
									"defaultValue": "[first(map(filter(steps('zeroTrust').avdPrivateLink.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.wvd.')), (zone) => zone.name))]",
									"label": "AVD Private DNS Zone",
									"multiLine": true,
									"toolTip": "Select the existing Private DNS Zone for the Remote Session connection and Workspace Feed (if applicable).",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').avdPrivateLink.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink.wvd.')), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource Group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": true
									}
								},
								{
									"name": "globalFeedPrivateDnsZone",
									"type": "Microsoft.Common.DropDown",
									"visible": "[and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.enablePrivateDNSIntegration, equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'All'))]",
									"label": "Global Feed Private DNS Zone",
									"defaultValue": "[first(map(filter(steps('zeroTrust').avdPrivateLink.privateDNSZonesApi.value, (zone) => contains(zone.name, 'privatelink-global.wvd.')), (zone) => zone.name))]",
									"multiLine": true,
									"toolTip": "Select the existing Private DNS Zone for the global Feed.",
									"constraints": {
										"allowedValues": "[map(filter(steps('zeroTrust').avdPrivateLink.privateDNSZonesApi.value, (zone) => contains(zone.name, '.wvd.')), (zone) => parse(concat('{\"label\":\"', zone.name, '\",\"description\":\"Resource group: ', first(skip(split(zone.id, '/'), 4)), '\",\"value\":\"', zone.id, '\"}')))]",
										"required": true
									}
								}
							]
						}
					]
				},
				{
					"name": "tags",
					"label": "Tags",
					"elements": [
						{
							"name": "tags",
							"type": "Microsoft.Common.TagsByResource",
							"resources": [
								"Microsoft.Compute/availabilitySets",
								"Microsoft.Compute/diskAccesses",
								"Microsoft.Compute/diskEncryptionSets",
								"Microsoft.Compute/virtualMachines",
								"Microsoft.DesktopVirtualization/applicationGroups",
								"Microsoft.DesktopVirtualization/hostPools",
								"Microsoft.DesktopVirtualization/scalingPlans",
								"Microsoft.DesktopVirtualization/workspaces",
								"Microsoft.Insights/dataCollectionEndpoints",
								"Microsoft.Insights/dataCollectionRules",
								"Microsoft.KeyVault/vaults",
								"Microsoft.ManagedIdentity/userAssignedIdentities",
								"Microsoft.NetApp/netAppAccounts",
								"Microsoft.Network/networkInterfaces",
								"Microsoft.Network/privateEndpoints",
								"Microsoft.OperationalInsights/workspaces",
								"Microsoft.RecoveryServices/vaults",
								"Microsoft.Resources/resourceGroups",
								"Microsoft.Storage/storageAccounts",
								"Microsoft.Web/serverFarms"
							]
						}
					]
				}
			]
		},
		"outputs": {
			"parameters": {
				"deploymentType": "[steps('basics').deploymentType]",
				"identifier": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('basics').naming.identifier, '')]",
				"index": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('basics').naming.index, '')]",
				"nameConvResTypeAtEnd": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('basics').naming.nameConvResTypeAtEnd, false)]",
				"identitySolution": "[steps('identity').solution]",
				"domainName": "[if(contains(steps('identity').solution, 'DomainServices'), steps('identity').virtualMachines.domainName, if(and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'shardPerms'))), steps('userProfiles').azureFiles.domainName, ''))]",
				"vmOUPath": "[if(contains(steps('identity').solution, 'DomainServices'), steps('identity').virtualMachines.ouPath, if(and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'shardPerms'))), steps('userProfiles').azureFiles.vmOUPath, ''))]",
				"domainJoinUserPassword": "[if(and(contains(steps('identity').solution, 'DomainServices'), equals(steps('identity').credentials.source, 'manual')), steps('identity').credentials.domainJoinUserPassword, if(and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'shardPerms')), not(equals(steps('userProfiles').azureFiles.credentialSource, 'keyVault'))), steps('userProfiles').azureFiles.domainJoinUserPassword, ''))]",
				"domainJoinUserPrincipalName": "[if(and(contains(steps('identity').solution, 'DomainServices'), equals(steps('identity').credentials.source, 'manual')), steps('identity').credentials.domainJoinUserPrincipalName, if(and(equals(steps('identity').solution, 'EntraKerberos-Hybrid'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'shardPerms')), not(equals(steps('userProfiles').azureFiles.credentialSource, 'keyVault'))), steps('userProfiles').azureFiles.domainJoinUserPrincipalName, ''))]",
				"virtualMachineAdminPassword": "[if(equals(steps('identity').credentials.source, 'manual'), steps('identity').credentials.localAdminPassword, '')]",
				"virtualMachineAdminUserName": "[if(equals(steps('identity').credentials.source, 'manual'), steps('identity').credentials.localAdminUsername, '')]",
				"credentialsKeyVaultResourceId": "[if(equals(steps('identity').credentials.source, 'keyVault'), steps('identity').credentials.keyVault.id, '')]",
				"existingHostPoolResourceId": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), steps('basics').existingHostPool.id, '')]",
				"controlPlaneSubscriptionId": "[if(equals(steps('basics').deploymentType, 'Complete'), steps('controlPlane').scope.subscription.subscriptionId, '')]",
				"controlPlaneLocation": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), '', steps('controlPlane').scope.location.name)]",
				"existingFeedWorkspaceResourceId": "[if(or(and(equals(steps('basics').deploymentType, 'Complete'), equals(steps('controlPlane').workspace.createOption, 'update')), equals(steps('basics').deploymentType, 'HostpoolOnly')), steps('controlPlane').workspace.existingWorkspace, '')]",
				"workspaceFriendlyName": "[if(and(equals(steps('basics').deploymentType, 'Complete'), not(equals(steps('controlPlane').workspace.createOption, 'update'))), steps('controlPlane').naming.workspaceFriendlyName, '')]",
				"desktopFriendlyName": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), '', steps('controlPlane').naming.desktopFriendlyName)]",
				"hostPoolType": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), if(equals(steps('controlPlane').hostPool.type, 'Pooled'), concat(steps('controlPlane').hostPool.type, ' ', steps('controlPlane').hostPool.loadBalancerAlgorithm), concat(steps('controlPlane').hostPool.type, ' ', steps('controlPlane').hostPool.assignmentType)), 'Pooled BreadthFirst')]",
				"hostPoolMaxSessionLimit": "[if(and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), equals(steps('controlPlane').hostPool.type, 'Pooled')), steps('controlPlane').hostPool.maxSessions, 1)]",
				"hostPoolValidationEnvironment": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('controlPlane').hostPool.validation, false)]",
				"hostPoolRDPProperties": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('controlPlane').hostPool.rdpProperties, '')]",
				"startVmOnConnect": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('controlPlane').hostPool.startVmOnConnect, false)]",
				"appGroupSecurityGroups": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('controlPlane').assignments.groupPickerBlade.transformed.groups, parse('[]'))]",
				"deployScalingPlan": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('controlPlane').scalingPlan.deployScalingPlan, false)]",
				"scalingPlanExclusionTag": "[if(steps('controlPlane').scalingPlan.deployScalingPlan, steps('controlPlane').scalingPlan.exclusionTag, '')]",
				"scalingPlanRampUpSchedule": "[if(steps('controlPlane').scalingPlan.deployScalingPlan, if(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('controlPlane').scalingPlan.personalWeekdayRampUpSchedule, steps('controlPlane').scalingPlan.weekdayRampUpSchedule), parse('[]'))]",
				"scalingPlanPeakSchedule": "[if(steps('controlPlane').scalingPlan.deployScalingPlan, if(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('controlPlane').scalingPlan.personalWeekdayPeakSchedule, steps('controlPlane').scalingPlan.weekdayPeakSchedule), parse('[]'))]",
				"scalingPlanRampDownSchedule": "[if(steps('controlPlane').scalingPlan.deployScalingPlan, if(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('controlPlane').scalingPlan.personalWeekdayRampDownSchedule, steps('controlPlane').scalingPlan.weekdayRampDownSchedule), parse('[]'))]",
				"scalingPlanOffPeakSchedule": "[if(steps('controlPlane').scalingPlan.deployScalingPlan, if(equals(steps('controlPlane').hostPool.type, 'Personal'), steps('controlPlane').scalingPlan.personalWeekdayOffPeakSchedule, steps('controlPlane').scalingPlan.weekdayOffPeakSchedule), parse('[]'))]",
				"scalingPlanForceLogoff": "[if(steps('controlPlane').scalingPlan.deployScalingPlan, steps('controlPlane').scalingPlan.forceLogoff, false)]",
				"scalingPlanMinsBeforeLogoff": "[if(and(steps('controlPlane').scalingPlan.deployScalingPlan, steps('controlPlane').scalingPlan.forceLogoff), steps('controlPlane').scalingPlan.minsToLogoff, 0)]",
				"existingHostsResourceGroupName": "[if(equals(steps('basics').deploymentType, 'SessionHostsOnly'), steps('hosts').scope.resourceGroup.name, '')]",
				"virtualMachinesTimeZone": "[steps('hosts').scope.timeZone]",
				"virtualMachineNamePrefix": "[steps('hosts').naming.virtualMachineNamePrefix]",
				"sessionHostIndex": "[steps('hosts').naming.index]",
				"vmNameIndexLength": "[steps('hosts').naming.indexPadding]",
				"sessionHostCount": "[steps('hosts').specs.count]",
				"virtualMachineSubnetResourceId": "[steps('hosts').network.subnet.id]",
				"imageOffer": "[if(equals(steps('hosts').image.source, 'marketplace'), steps('hosts').image.offer, '')]",
				"imagePublisher": "[if(equals(steps('hosts').image.source, 'marketplace'), 'MicrosoftWindowsDesktop', '')]",
				"imageSku": "[if(equals(steps('hosts').image.source, 'marketplace'), steps('hosts').image.sku, '')]",
				"customImageResourceId": "[if(equals(steps('hosts').image.source, 'gallery'), steps('hosts').image.imageDefinition, '')]",
				"securityType": "[steps('hosts').security.securityType]",
				"secureBootEnabled": "[if(equals(steps('hosts').security.securityType, 'Standard'), false, steps('hosts').security.secureBootEnabled)]",
				"vTpmEnabled": "[if(equals(steps('hosts').security.securityType, 'Standard'), false, steps('hosts').security.vTpmEnabled)]",
				"encryptionAtHost": "[steps('hosts').diskEncryption.encryptionAtHost]",
				"existingDiskEncryptionSetResourceId": "[if(and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), steps('hosts').diskEncryption.selectDiskEncryptionSet), steps('hosts').diskEncryption.existingDiskEncryptionSet, '')]",
				"keyManagementDisks": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('hosts').diskEncryption.keyManagement, 'PlatformManaged')]",
				"confidentialVMOSDiskEncryption": "[if(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('hosts').diskEncryption.confidentialVMOSDiskEncryption, false)]",
				"confidentialVMOrchestratorObjectId": "[if(and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('hosts').diskEncryption.confidentialVMOSDiskEncryption, equals(steps('hosts').diskEncryption.keyManagement, 'CustomerManagedHSM')), if(empty(first(steps('hosts').diskEncryption.confDiskEncryptionPrincipalApi.value)), first(map(steps('hosts').diskEncryption.confDiskEncryptionServicePrincipalPickerBlade.transformed.selection, (sp) => sp.id)), first(steps('hosts').diskEncryption.confDiskEncryptionPrincipalApi.transformed.objectId)), '')]",
				"dedicatedHostGroupResourceId": "[if(steps('hosts').dedicatedHosts.deployToDedicatedHosts, steps('hosts').dedicatedHosts.dedicatedHostGroup, '')]",
				"dedicatedHostResourceId": "[if(steps('hosts').dedicatedHosts.deployToDedicatedHosts, steps('hosts').dedicatedHosts.dedicatedHost, '')]",
				"availability": "[if(equals(steps('hosts').dedicatedHosts.deployToDedicatedHosts, false), steps('hosts').availability.availability, 'none')]",
				"diskSku": "[steps('hosts').specs.diskSku]",
				"diskSizeGB": "[steps('hosts').specs.diskSizeGB]",
				"virtualMachineSize": "[if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric)]",
				"vCPUs": "[first(map(filter(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.capabilities)), (cap) => equals(cap.name, 'vCPUs')), (cap) => cap.value))]",
				"memoryGB": "[first(map(filter(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.capabilities)), (cap) => equals(cap.name, 'MemoryGB')), (cap) => cap.value))]",
				"availabilityZones": "[if(and(equals(steps('hosts').dedicatedHosts.deployToDedicatedHosts, false), equals(steps('hosts').availability.availability, 'AvailabilityZones')), steps('hosts').availability.availabilityZones, parse('[]'))]",
				"enableAcceleratedNetworking": "[if(and(bool(first(map(filter(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.capabilities)), (sku) => equals(sku.name, 'AcceleratedNetworkingEnabled')), (sku) => sku.value))), or(equals(steps('hosts').image.source, 'marketplace'), bool(steps('hosts').image.imageDefinitionApi.transformed.IsAcceleratedNetworkSupported))), steps('hosts').specs.enableAcceleratedNetworking, false)]",
				"hibernationEnabled": "[if(and(equals(steps('controlPlane').hostPool.type, 'Personal'), bool(first(map(filter(first(map(filter(steps('hosts').resourceSkusApi.value, (sku) => contains(sku.name, if(equals(steps('hosts').security.securityType, 'ConfidentialVM'), steps('hosts').specs.sizeConfidentialVM, steps('hosts').specs.sizeGeneric))), (sku) => sku.capabilities)), (sku) => equals(sku.name, 'HibernationSupported')), (sku) => sku.value))), or(equals(steps('hosts').image.source, 'marketplace'), bool(steps('hosts').image.imageDefinitionApi.transformed.IsHibernateSupported))), steps('hosts').specs.hibernationEnabled, false)]",
				"avdAgentsDSCPackage": "[steps('hosts').registration.avdAgentsDSCPackage]",
				"useAgentDownloadEndpoint": "[steps('hosts').registration.useAgentDownloadEndpoint]",
				"intuneEnrollment": "[if(or(equals(steps('identity').solution, 'EntraId'), contains(steps('identity').solution, 'EntraKerberos')), steps('hosts').management.intune, false)]",
				"artifactsContainerUri": "[if(steps('hosts').customScripts.addCustomScripts, if(and(not(empty(steps('hosts').customScripts.storageAccount)), not(empty(steps('hosts').customScripts.container))), concat(steps('hosts').customScripts.storageAccount.blobEndpoint, steps('hosts').customScripts.container), ''), '')]",
				"artifactsUserAssignedIdentityResourceId": "[if(steps('hosts').customScripts.addCustomScripts, if(not(empty(steps('hosts').customScripts.managedIdentity)), steps('hosts').customScripts.managedIdentity.id, ''), '')]",
				"sessionHostCustomizations": "[if(steps('hosts').customScripts.addCustomScripts, steps('hosts').customScripts.customizations, parse('[]'))]",
				"fslogixContainerType": "[if(equals(steps('userProfiles').profileSolution, 'FSLogix'), steps('userProfiles').fslogixContainerType, 'ProfileContainer')]",
				"fslogixSizeInMBs": "[if(and(equals(steps('userProfiles').profileSolution, 'FSLogix'), steps('userProfiles').configureSessionHosts), steps('userProfiles').sizeInMBs, 30720)]",
				"deployFSLogixStorage": "[if(equals(steps('userProfiles').profileSolution, 'FSLogix'), steps('userProfiles').deployStorage, false)]",
				"fslogixConfigureSessionHosts": "[if(equals(steps('userProfiles').profileSolution, 'FSLogix'), steps('userProfiles').configureSessionHosts, false)]",
				"fslogixOUPath": "[if(and(equals(steps('identity').solution, 'ActiveDirectoryDomainServices'), equals(steps('userProfiles').deployStorage, true)), steps('userProfiles').ouPath, '')]",
				"fslogixStorageService": "[if(equals(steps('userProfiles').deployStorage, true), if(equals(steps('userProfiles').storageService, 'AzureFiles'), concat('AzureFiles ', steps('userProfiles').azureFiles.storageSku), concat('AzureNetAppFiles ', steps('userProfiles').azureNetAppFiles.storageSku)), if(steps('userProfiles').configureSessionHosts, if(equals(steps('userProfiles').storageService, 'AzureFiles'), 'AzureFiles Standard', 'AzureNetAppFiles Standard'), 'AzureFiles Standard'))]",
				"netAppVolumesSubnetResourceId": "[if(and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').storageService, 'AzureNetAppFiles')), steps('userProfiles').azureNetAppFiles.subnet.id, '')]",
				"existingSharedActiveDirectoryConnection": "[if(and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').storageService, 'AzureNetAppFiles')), steps('userProfiles').azureNetAppFiles.existingSharedActiveDirectoryConnection, false)]",
				"fslogixExistingLocalNetAppVolumeResourceIds": "[if(and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)), equals(steps('userProfiles').storageService, 'AzureNetAppFiles')), steps('userProfiles').azureNetAppFiles.localVolumes, parse('[]'))]",
				"fslogixExistingRemoteNetAppVolumeResourceIds": "[if(and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'), equals(steps('userProfiles').storageService, 'AzureNetAppFiles')), steps('userProfiles').azureNetAppFiles.remoteVolumes, parse('[]'))]",
				"fslogixShardOptions": "[if(and(equals(steps('userProfiles').storageService, 'AzureFiles'), or(steps('userProfiles').configureSessionHosts, equals(steps('userProfiles').deployStorage, true))), steps('userProfiles').azureFiles.shardingOption, 'None')]",
				"fslogixUserGroups": "[if(and(equals(steps('userProfiles').storageService, 'AzureNetAppFiles'), equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').azureNetAppFiles.leastPrivNTFS, true)), steps('userProfiles').azureNetAppFiles.userGroupPickerBlade.transformed.groups, if(and(equals(steps('userProfiles').storageService, 'AzureFiles'), not(equals(steps('identity').solution, 'EntraId')), or(equals(steps('userProfiles').configureSessionHosts, true), equals(steps('userProfiles').deployStorage, true)), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), not(equals(steps('userProfiles').azureFiles.shardingOption, 'None')))), steps('userProfiles').azureFiles.userGroupPickerBlade.transformed.groups, parse('[]')))]",
				"fslogixShareSizeInGB": "[if(equals(steps('userProfiles').deployStorage, true), if(equals(steps('userProfiles').storageService, 'AzureFiles'), steps('userProfiles').azureFiles.storageShareSize, steps('userProfiles').azureNetAppFiles.storageShareSize), 100)]",
				"fslogixStorageIndex": "[if(and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').storageService, 'AzureFiles')), steps('userProfiles').azureFiles.storageIndex, 0)]",
				"keyManagementStorageAccounts": "[if(and(equals(steps('userProfiles').deployStorage, true), equals(steps('userProfiles').storageService, 'AzureFiles')), steps('userProfiles').azureFiles.keyManagement, 'MicrosoftManaged')]",
				"fslogixExistingLocalStorageAccountResourceIds": "[if(and(steps('userProfiles').configureSessionHosts, not(equals(steps('userProfiles').deployStorage, true)), equals(steps('userProfiles').storageService, 'AzureFiles')), steps('userProfiles').azureFiles.existingLocalStorageAccounts, parse('[]'))]",
				"fslogixExistingRemoteStorageAccountResourceIds": "[if(and(steps('userProfiles').configureSessionHosts, contains(steps('userProfiles').fslogixContainerType, 'CloudCache'), equals(steps('userProfiles').storageService, 'AzureFiles')), steps('userProfiles').azureFiles.existingRemoteStorageAccounts, parse('[]'))]",
				"fslogixAppUpdateUserAssignedIdentityResourceId": "[if(and(contains(steps('identity').solution, 'EntraKerberos'), or(equals(steps('userProfiles').azureFiles.leastPrivNTFS, true), equals(steps('userProfiles').azureFiles.shardingOption, 'ShardPerms'))), steps('userProfiles').azureFiles.managedIdentity.id, '')]",
				"fslogixAdminGroups": "[if(steps('userProfiles').shareManagement.configureAdminAccess, steps('userProfiles').shareManagement.groupPickerBlade.transformed.groups, parse('[]'))]",
				"avdObjectId": "[if(and(not(equals(steps('basics').deploymentType, 'SessionHostsOnly')), steps('management').servicePrincipals.enableAVDSPRBAC, or(steps('controlPlane').hostPool.startVmOnConnect, steps('controlPlane').scalingPlan.deployScalingPlan)), if(empty(first(steps('management').servicePrincipals.avdServicePrincipalApi.value)), first(map(steps('management').servicePrincipals.avdServicePrincipalPickerBlade.transformed.selection, (sp) => sp.id)), first(map(steps('management').servicePrincipals.avdServicePrincipalApi.value, (sp) => sp.id))), '')]",
				"deployIncreaseQuota": "[if(and(equals(steps('basics').deploymentType, 'Complete'), equals(steps('userProfiles').azureFiles.storageSku, 'Premium')), steps('management').automation.deployIncreaseQuota, false)]",
				"existingHostingPlanResourceId": "[if(and(equals(steps('basics').deploymentType, 'HostpoolOnly'), steps('management').automation.deployIncreaseQuota), steps('management').automation.serverFarm, '')]",
				"recoveryServices": "[steps('management').backup.recoveryServices]",
				"existingRecoveryServicesVaultResourceId": "[if(and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), equals(steps('basics').hostPoolApi.properties.hostPoolType, 'Personal'), steps('management').backup.recoveryServices), steps('management').backup.recoveryServicesVault, '')]",
				"existingDiskAccessResourceId": "[if(and(equals(steps('basics').deploymentType, 'SessionHostsOnly'), equals(steps('basics').hostPoolApi.properties.hostPoolType, 'Personal'), steps('management').backup.recoveryServices, steps('management').backup.associateDiskAccessResource), steps('management').backup.diskAccess, '')]",
				"deploySecretsKeyVault": "[if(and(equals(steps('basics').deploymentType, 'Complete'), equals(steps('identity').credentials.source, 'manual')), steps('management').keyVaults.deploySecretsKeyVault, false)]",
				"secretsKeyVaultEnableSoftDelete": "[if(and(equals(steps('basics').deploymentType, 'Complete'), equals(steps('identity').credentials.source, 'manual'), steps('management').keyVaults.deploySecretsKeyVault), steps('management').keyVaults.enableSoftDelete, false)]",
				"secretsKeyVaultEnablePurgeProtection": "[if(and(equals(steps('basics').deploymentType, 'Complete'), equals(steps('identity').credentials.source, 'manual'), steps('management').keyVaults.deploySecretsKeyVault, steps('management').keyVaults.enableSoftDelete), steps('management').keyVaults.enablePurgeProtection, false)]",
				"keyVaultRetentionInDays": "[if(and(equals(steps('basics').deploymentType, 'Complete'), or(steps('management').keyVaults.deploySecretsKeyVault, contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'))), steps('management').keyVaults.keyVaultRetentionInDays, 7)]",
				"existingEncryptionKeyVaultResourceId": "[if(and(equals(steps('basics').deploymentType, 'HostpoolOnly'), or(contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'))), steps('management').keyVaults.existingEncryptionKeyVault.id, '')]",
				"keyExpirationInDays": "[if(and(equals(steps('basics').deploymentType, 'Complete'), or(contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'))), steps('management').keyVaults.keyExpirationInDays, 180)]",
				"enableMonitoring": "[steps('management').monitoring.enableMonitoring]",
				"monitoringSubscriptionId": "[if(steps('management').monitoring.enableMonitoring, steps('management').monitoring.subscription.subscriptionId, '')]",
				"existingLogAnalyticsWorkspaceResourceId": "[if(and(equals(steps('basics').deploymentType, 'HostpoolOnly'), steps('management').monitoring.enableMonitoring), steps('management').monitoring.logAnalyticsWorkspace, '')]",
				"existingAVDInsightsDataCollectionRuleResourceId": "[if(and(not(equals(steps('basics').deploymentType, 'Complete')), steps('management').monitoring.enableMonitoring), steps('management').monitoring.avdInsightsDataCollectionRule, '')]",
				"existingVMInsightsDataCollectionRuleResourceId": "[if(and(not(equals(steps('basics').deploymentType, 'Complete')), steps('management').monitoring.enableMonitoring), steps('management').monitoring.vmInsightsDataCollectionRule, '')]",
				"existingDataCollectionEndpointResourceId": "[if(and(not(equals(steps('basics').deploymentType, 'Complete')), steps('management').monitoring.enableMonitoring), steps('management').monitoring.dataCollectionEndpoint, '')]",
				"securityDataCollectionRulesResourceId": "[if(steps('management').monitoring.enableCentralMonitoring, steps('management').monitoring.securityDataCollectionRule.id, '')]",
				"deployPrivateEndpoints": "[steps('zeroTrust').privateEndpoints.deployPrivateEndpoints]",
				"keyVaultPrivateEndpointSubnetResourceId": "[if(and(or(steps('hosts').diskEncryption.confidentialVMOSDiskEncryption, contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'), steps('management').keyVaults.deploySecretsKeyVault), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints), steps('zeroTrust').privateEndpoints.keyVaultsSubnet.id, '')]",
				"functionAppSubnetResourceId": "[if(and(steps('management').automation.deployIncreaseQuota, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints), steps('zeroTrust').privateEndpoints.functionAppOutboundSubnet.id, '')]",
				"hostPoolResourcesPrivateEndpointSubnetResourceId": "[if(steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.hostpoolSubnet.id, '')]",
				"azureBackupPrivateDnsZoneResourceId": "[if(and(steps('management').backup.recoveryServices, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration), steps('zeroTrust').privateEndpoints.azureBackupPrivateDnsZone, '')]",
				"azureBlobPrivateDnsZoneResourceId": "[if(and(or(steps('management').backup.recoveryServices, steps('management').monitoring.enableMonitoring), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration), steps('zeroTrust').privateEndpoints.azureBlobPrivateDnsZone, '')]",
				"azureFunctionAppPrivateDnsZoneResourceId": "[if(and(steps('management').automation.deployIncreaseQuota, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration), steps('zeroTrust').privateEndpoints.azureFunctionAppPrivateDnsZone, '')]",
				"azureFilesPrivateDnsZoneResourceId": "[if(and(equals(steps('userProfiles').storageService, 'AzureFiles'), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration), steps('zeroTrust').privateEndpoints.azureFilesPrivateDnsZone, '')]",
				"azureKeyVaultPrivateDnsZoneResourceId": "[if(and(steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration, or(steps('management').keyVaults.deploySecretsKeyVault, steps('hosts').diskEncryption.confidentialVMOSDiskEncryption, contains(steps('hosts').diskEncryption.keyManagement, 'CustomerManaged'), contains(steps('userProfiles').azureFiles.keyManagement, 'CustomerManaged'))), steps('zeroTrust').privateEndpoints.azureKeyVaultPrivateDnsZone, '')]",
				"azureQueuePrivateDnsZoneResourceId": "[if(and(or(steps('management').backup.recoveryServices, steps('management').automation.deployIncreaseQuota), steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration), steps('zeroTrust').privateEndpoints.azureQueuePrivateDnsZone, '')]",
				"azureTablePrivateDnsZoneResourceId": "[if(and(steps('management').automation.deployIncreaseQuota, steps('zeroTrust').privateEndpoints.deployPrivateEndpoints, steps('zeroTrust').privateEndpoints.enablePrivateDNSIntegration), steps('zeroTrust').privateEndpoints.azureTablePrivateDnsZone, '')]",
				"azureMonitorPrivateLinkScopeResourceId": "[if(steps('zeroTrust').azureMonitor.privateLink, steps('zeroTrust').azureMonitor.azureMonitorPrivateLinkScope.id, '')]",
				"deployDiskAccessPolicy": "[steps('zeroTrust').policy.deployDiskAccessPolicy]",
				"avdPrivateLinkPrivateRoutes": "[if(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'None')]",
				"hostpoolPrivateEndpointSubnetResourceId": "[if(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.hostpoolSubnet.id, '')]",
				"workspaceFeedPrivateEndpointSubnetResourceId": "[if(and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'Hostpool'))), steps('zeroTrust').avdPrivateLink.feedWorkspaceSubnet.id, '')]",
				"avdPrivateDnsZoneResourceId": "[if(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.wvdPrivateLinkDnsZone, '')]",
				"hostPoolPublicNetworkAccess": "[if(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.hostpoolPublicNetworkAccess, 'Enabled')]",
				"workspacePublicNetworkAccess": "[if(and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, not(equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'Hostpool'))), steps('zeroTrust').avdPrivateLink.feedWorkspacePublicNetworkAccess, 'Enabled')]",
				"existingGlobalFeedResourceId": "[first(map(filter(steps('controlPlane').workspacesApi.value, (ws) => contains(ws.name, 'global-feed')), (ws) => ws.id))]",
				"globalFeedPrivateEndpointSubnetResourceId": "[if(and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.enablePrivateDNSIntegration, equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'All')), steps('zeroTrust').avdPrivateLink.globalFeedSubnet.id, '')]",
				"globalFeedPrivateDnsZoneResourceId": "[if(and(steps('zeroTrust').avdPrivateLink.enablePrivateLink, steps('zeroTrust').avdPrivateLink.enablePrivateDNSIntegration, equals(steps('zeroTrust').avdPrivateLink.avdPrivateLinkConfig, 'All')), steps('zeroTrust').avdPrivateLink.globalFeedPrivateDnsZone, '')]",
				"tags": "[steps('tags').tags]"
			},
			"kind": "Subscription",
			"location": "[steps('hosts').scope.location.name]",
			"subscriptionId": "[steps('hosts').scope.subscription.id]"
		}
	}
}